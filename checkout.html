<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout | Syrine's Crumble</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @font-face {
      font-family: 'Stella';
      src: url('font/stella.ttf') format('truetype');
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Chewy', cursive;
      text-decoration: none;
    }

    :root {
      --primary: #C0394F;
      --secondary: #FFD7DF;
      --background: #FFEBEE;
      --text: #333333;
      --light: #FFFFFF;
      --accent: #FF6B8A;
      --success: #4CAF50;
      --shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      --transition: all 0.3s ease;
    }

    body {
      background: #FFEBEE;
      color: #C0394F;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.2rem 2rem;
      background: var(--light);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .brand-name {
      font-family: 'stella', cursive;
      font-size: 2rem;
      color: var(--primary);
      line-height: 1;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.8rem;
    }

    .logo-icon {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: var(--secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid var(--primary);
    }

    .logo-icon i {
      color: var(--primary);
      font-size: 1.5rem;
    }

    .logo-text {
      display: flex;
      flex-direction: column;
    }

    .cart-icon {
      position: relative;
      cursor: pointer;
    }

    .cart-count {
      position: absolute;
      top: -8px;
      right: -8px;
      background: var(--primary);
      color: #fff;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: .75rem;
      font-weight: bold;
    }

    /* Progress bar */
    .progress-container {
      margin: 2rem auto;
      max-width: 800px;
    }

    .progress-bar {
      display: flex;
      justify-content: space-between;
      position: relative;
    }

    .progress-bar::before {
      content: "";
      position: absolute;
      top: 16px;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--secondary);
      ;
      border-radius: 2px;
    }

    .progress-step {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
    }

    .step-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #fff;
      border: 3px solid #f1e6d6;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      margin-bottom: .5rem;
    }

    .progress-step.active .step-icon {
      background: var(--primary);
      ;
      border-color: var(--primary);
      ;
      color: #fff;
    }

    .progress-step.completed .step-icon {
      background: #4caf50;
      border-color: #4caf50;
      color: #fff;
    }

    .step-label {
      font-size: .9rem;
      font-weight: 500;
    }

    /* Layout */
    .checkout-container {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 1.5rem;
      display: grid;
      grid-template-columns: 1fr 380px;
      gap: 2rem;
    }

    .checkout-container {
      /* display: flex; */
      gap: 20px;
      align-items: flex-start;
      /* make each box wrap its own content */
    }

    .checkout-content,
    .order-summary {
      background: #fff;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
    }

    /* Form */
    .section-title {
      font-size: 1.4rem;
      margin-bottom: 1rem;
      color: var(--primary);
      ;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      margin-bottom: 1rem;
      position: relative;
    }

    .form-group label {
      font-weight: 500;
      margin-bottom: .4rem;
    }

    .form-group input,
    .form-group textarea {
      padding: .8rem 1rem;
      border: 1px solid var(--primary);
      ;
      border-radius: 10px;
      font-size: 1rem;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--secondary);
      ;
      box-shadow: 0 0 0 2px var(--secondary);
    }

    /* Order summary */
    .summary-title {
      font-size: 1.4rem;
      margin-bottom: 1rem;
      color: var(--primary);
      ;
    }

    .summary-items {
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
    }

    .summary-item {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #eee;
    }

    .item-details {
      display: flex;
      gap: 1rem;
      align-items: flex-start;
    }

    .item-image {
      width: 60px;
      height: 60px;
      border-radius: 10px;
      overflow: hidden;
    }

    .item-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .item-info {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .item-name {
      font-weight: 600;
      color: var(--text);
      font-size: 1rem;
    }

    .item-quantity {
      font-size: 0.9rem;
      color: #777;
    }

    .item-flavors {
      margin-top: 0.2rem;
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
    }

    .item-flavor {
      font-size: 0.85rem;
      color: #555;
    }

    .item-flavor .flavor-details {
      display: inline-block;
      font-size: 0.9rem;
    }

    .item-flavor .flavor-details span {
      font-weight: bold;
      font-size: 1.1rem;
      margin: 0 0.2rem;
    }


    .item-price {
      font-weight: bold;
      font-size: 1rem;
      color: var(--primary);
      white-space: nowrap;
    }

    .summary-total {
      display: flex;
      justify-content: space-between;
      font-weight: bold;
      font-size: 1.2rem;
      padding-top: 1rem;
      border-top: 2px solid #eee;
    }

    .total-amount {
      color: var(--primary);
    }

    /* Buttons */
    .checkout-nav {
      margin-top: 2rem;
      display: flex;
      justify-content: space-between;
      gap: 1rem;
    }

    .btn {
      padding: .9rem 1.6rem;
      border: none;
      border-radius: 50px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all .3s;
      display: flex;
      align-items: center;
      gap: .5rem;
    }

    .btn-prev {
      background: transparent;
      border: 2px solid var(--primary);
      color: var(--primary);
    }

    .btn-prev:hover {
      background: var(--secondary);
    }

    .btn-next {
      background: var(--primary);
      color: #fff;
      box-shadow: 0 4px 10px var(--secondary);
    }

    .btn-next:hover {
      background: var(--primary);
    }

    @media(max-width: 900px) {
      .checkout-container {
        grid-template-columns: 1fr;
      }
    }

    .loading-spinner {
      display: none;
      /* hidden by default */
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(2px);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }

    .payment-modal {
      display: none;
      /* hidden by default */
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      justify-content: center;
      align-items: center;
    }

    .payment-modal-content {
      background: #fff;
      border-radius: 12px;
      width: 90%;
      max-width: 800px;
      height: 90%;
      display: flex;
      flex-direction: column;
      position: relative;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
    }

    .payment-modal-content iframe {
      flex: 1;
      width: 100%;
      border: none;
      border-radius: 0 0 12px 12px;
    }

    .close-modal {
      position: absolute;
      top: 10px;
      right: 20px;
      font-size: 2rem;
      font-weight: bold;
      cursor: pointer;
      color: #333;
    }


    .loading-spinner.active {
      display: flex;
    }


    .payment-methods {
      display: flex;
      gap: 1.5rem;
      margin: 1rem 0 2rem 0;
    }

    .payment-option {
      flex: 1;
      background: #fff;
      border: 2px solid var(--primary);
      border-radius: 12px;
      padding: 1.2rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.6rem;
      font-weight: 500;
      color: var(--primary);
    }

    .payment-option i {
      font-size: 1.8rem;
      color: var(--primary);
    }

    .payment-option:hover {
      border-color: var(--primary);
      box-shadow: 0 4px 12px var(--secondary);
    }

    .payment-option.active {
      border-color: var(--primary);
      background: #fff7f0;
      box-shadow: 0 4px 12px var(--secondary);
    }


    #city {
      width: 100%;
      padding: 10px 15px;
      border-radius: 8px;
      border: 1px solid var(--primary);
      outline: none;
      font-size: 1rem;
      transition: 0.3s;
    }

    #city:focus {
      border-color: var(--primary);
    }

    #district {
      width: 100%;
      padding: 10px 15px;
      border-radius: 8px;
      border: 1px solid var(--primary);
      outline: none;
      font-size: 1rem;
      transition: 0.3s;
    }

    #district:focus {
      border-color: var(--primary);
    }

    .dropdown-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 200px;
      overflow-y: auto;
      background: #fff;
      border: 1px solid #ccc;
      border-top: none;

      border-radius: 0 0 8px 8px;
      z-index: 1000;
      display: none;
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .dropdown-list li {
      padding: 10px 15px;
      cursor: pointer;
      transition: 0.2s;
    }

    .dropdown-list li:hover {
      background-color: #ffefeb;
    }



    @media(max-width: 600px) {
      header {
        padding: 0.8rem 1rem;
      }

      .brand-name {
        font-size: 1.5rem;
      }

      .logo-icon {
        width: 40px;
        height: 40px;
      }

      .checkout-container {
        padding: 0 1rem;
      }

      .checkout-content,
      .order-summary {
        padding: 1.2rem;
      }

      .form-grid {
        grid-template-columns: 1fr;
        /* stack fields */
      }

      .btn {
        width: 100%;
        /* buttons full width */
        justify-content: center;
      }

      .progress-bar::before {
        top: 12px;
        /* align line for smaller icons */
      }

      .step-icon {
        width: 28px;
        height: 28px;
        font-size: 0.8rem;
      }

      .step-label {
        font-size: 0.75rem;
        text-align: center;
      }

      .item-image {
        width: 50px;
        height: 50px;
      }

      .item-info {
        font-size: 0.9rem;
      }
    }


    .logo-container {
      flex: 0 0 auto;
      position: absolute;
      right: 80%;
      height: inherit;
      transform: translateX(-50%);
    }

    .logo-container {
      flex: 0 0 auto;
    }

    @media (max-width: 768px) {

      /* Base mobile adjustments */
      body {
        font-size: 14px;
      }

      .container {
        padding: 0 15px;
      }

      /* Header mobile styles - Logo centered with menu/cart on sides */
      .modern-header {
        padding: 10px 0;
      }

      .header-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 1.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      /* Responsive Styles */
      @media (max-width: 992px) {
        .main-nav {
          display: none;
        }

        .mobile-menu-btn {
          display: block;
        }

        .header-container {
          padding: 0 1rem;
        }
      }

      .mobile-menu-btn {
        display: block;
        background: none;
        border: none;
        font-size: 1.5rem;
        color: #333;
        cursor: pointer;
        padding: 8px;
        order: 1;
        /* Left side */
      }

      .logo-container {
        order: 2;
        /* Center */
        flex: 0 1 auto;
        /* margin: 150 15px; */
      }

      .logo-img {
        max-width: 120px;
        height: 50px;
      }

      .header-actions {
        order: 3;
        /* Right side */
      }

      .main-nav {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        order: 4;
        width: 100%;
      }

      .main-nav.active {
        display: block;
      }

      .nav-list {
        flex-direction: column;
        padding: 10px 0;
      }

      .nav-item {
        margin: 0;
      }

      .nav-link {
        padding: 15px 20px;
        justify-content: flex-start;
        border-bottom: 1px solid #f0f0f0;
      }

      .nav-link i {
        margin-right: 10px;
        width: 20px;
        text-align: center;
      }

      /* Hero section mobile */
      .hero {
        /* padding: 40px 0; */
      }

      .hero-title {
        font-size: 2rem;
        margin-bottom: 10px;
      }

      .hero-subtitle {
        font-size: 1rem;
        margin-bottom: 30px;
        padding: 0 10px;
      }

      .svg-container {
        /* flex-direction: column; */
        gap: 30px;
      }

      .team-container {
        margin: 0 10px;
      }

      .cookie-img {
        max-width: 120px;
      }

      /* Features section mobile */
      .features {
        padding: 40px 0;
      }

      .section-title {
        font-size: 1.8rem;
        margin-bottom: 30px;
      }

      .features-grid {
        grid-template-columns: 1fr;
        gap: 20px;
      }

      .feature-card {
        padding: 20px;
      }

      .feature-icon {
        font-size: 2rem;
        margin-bottom: 15px;
      }

      /* Boxes section mobile */
      .boxes {
        padding: 30px 0;
      }

      .box-options {
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
      }

      .box-option {
        padding: 15px;
      }

      .box-img {
        max-width: 80px;
        margin-bottom: 10px;
      }

      /* Cookies grid mobile */
      .cookies-grid {
        grid-template-columns: 1fr;
        gap: 10px;
      }

      /* .cookie-card {
        padding: 15px;
    } */

      /* .cookie-image img {
        max-width: 100px;
    } */

      .click-indicator {
        font-size: 0.8rem;
        padding: 5px;
      }

      /* Mystery section mobile */
      .mystery-content {
        flex-direction: column;
        gap: 30px;
        text-align: center;
      }

      .mystery-image {
        max-width: 200px;
        margin: 0 auto;
      }

      .question-mark {
        font-size: 3rem;
        width: 80px;
        height: 80px;
        line-height: 80px;
      }

      /* Popup mobile styles */
      .cookie-popup {
        flex-direction: column;
        max-height: 70%;
        max-width: 90%;
        margin: 20px auto;
      }

      /* Dropdown Cart Styles */
      .cart-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        width: 350px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        display: none;
        margin-top: 10px;
        border: 1px solid #e0e0e0;
      }

      .cart-dropdown.active {
        display: block;
        animation: fadeInDown 0.3s ease-out;
      }

      @keyframes fadeInDown {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .cart-dropdown-content {
        max-height: 400px;
        overflow-y: auto;
      }

      .cart-dropdown-header {
        padding: 15px 20px;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .cart-dropdown-header h3 {
        margin: 0;
        font-size: 1.2rem;
        color: #333;
      }

      .cart-dropdown-items {
        padding: 0;
        margin: 0;
        list-style: none;
      }

      .cart-dropdown-item {
        padding: 15px 20px;
        border-bottom: 1px solid #f5f5f5;
        display: flex;
        align-items: center;
      }

      .cart-dropdown-item:last-child {
        border-bottom: none;
      }

      .cart-dropdown-item-image {
        width: 50px;
        height: 50px;
        border-radius: 5px;
        overflow: hidden;
        margin-right: 15px;
        background: #f9f9f9;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .cart-dropdown-item-image img {
        max-width: 100%;
        max-height: 100%;
      }

      .cart-dropdown-item-details {
        flex: 1;
      }

      .cart-dropdown-item-name {
        font-weight: 600;
        margin-bottom: 5px;
        color: #333;
      }

      .cart-dropdown-item-price {
        color: #e67e22;
        font-weight: 600;
      }

      .cart-dropdown-item-quantity {
        display: flex;
        align-items: center;
        margin-top: 5px;
      }

      .cart-dropdown-quantity-btn {
        background: #f5f5f5;
        border: none;
        width: 25px;
        height: 25px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 14px;
      }

      .cart-dropdown-quantity-value {
        margin: 0 10px;
        font-weight: 600;
      }

      .cart-dropdown-remove {
        background: none;
        border: none;
        color: #e74c3c;
        cursor: pointer;
        font-size: 16px;
        margin-left: 10px;
      }

      .cart-dropdown-footer {
        padding: 15px 20px;
        border-top: 1px solid #f0f0f0;
      }

      .cart-dropdown-total {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
        font-weight: 600;
        font-size: 1.1rem;
      }

      .cart-dropdown-checkout {
        width: 100%;
        padding: 12px;
        background: #e67e22;
        color: white;
        border: none;
        border-radius: 5px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.3s;
      }

      .cart-dropdown-checkout:hover {
        background: #d35400;
      }

      .cart-dropdown-empty {
        padding: 30px 20px;
        text-align: center;
        color: #777;
      }

      .cart-dropdown-empty i {
        font-size: 40px;
        margin-bottom: 15px;
        color: #ddd;
      }

      /* Header adjustments for dropdown positioning */
      .header-actions {
        position: relative;
      }

      /* Close dropdown when clicking outside */
      .cart-dropdown-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 999;
        display: none;
      }

      .cart-dropdown-overlay.active {
        display: block;
      }

      /* Mobile responsiveness */
      @media (max-width: 768px) {
        .cart-dropdown {
          width: 300px;
          right: -10px;
        }
      }

      @media (max-width: 480px) {
        .cart-dropdown {
          width: 280px;
          right: -15px;
        }
      }



      .popup-image {
        width: 100%;
        height: 200px;
        border-radius: 10px 10px 0 0;
      }

      .popup-content {
        padding: 20px;
      }

      .popup-style-buttons {
        flex-direction: column;
        gap: 10px;
      }

      .popup-style-option {
        width: 100%;
        padding: 12px;
      }

      .popup-actions {
        flex-direction: column;
        gap: 15px;
      }

      .quantity-selector {
        justify-content: center;
      }

      .popup-add-to-cart {
        width: 100%;
      }

      /* Flavor popup mobile */
      .flavor-popup {
        width: 95%;
        max-width: 400px;
        margin: 20px auto;
      }

      .flavor-popup-content {
        padding: 20px;
      }

      .popup-style-selection {
        flex-direction: column;
        gap: 10px;
      }

      .popup-style-btn {
        width: 100%;
        padding: 12px;
      }

      .flavor-grid {
        grid-template-columns: 1fr;
        gap: 10px;
      }

      .flavor-option {
        padding: 15px;
      }

      /* Cart sidebar mobile */
      .cart-sidebar {
        width: 100%;
        height: 100%;

      }

      .cart-sidebar.active {
        right: 0;
      }

      .cart-item {
        flex-direction: column;
        padding: 15px;
        gap: 10px;
      }

      .cart-item-image {
        width: 60px;
        height: 60px;
      }

      .cart-item-details {
        text-align: center;
      }

      .cart-item-actions {
        justify-content: center;
      }

      /* Footer mobile */
      .footer-content {
        flex-direction: column;
        gap: 30px;
        text-align: center;
      }

      .footer-column {
        width: 100%;
      }

      .social-icons {
        justify-content: center;
      }

      /* Button mobile adjustments */
      .btn {
        padding: 12px 20px;
        font-size: 0.9rem;
      }

      .add-to-cart-btn {
        padding: 10px 15px;
        font-size: 0.9rem;
      }

      /* Text size adjustments */
      h1 {
        font-size: 2rem;
      }

      h2 {
        font-size: 1.6rem;
      }

      h3 {
        font-size: 1.3rem;
      }

      h4 {
        font-size: 1.1rem;
      }

      /* Utility classes for mobile */
      .mobile-hidden {
        display: none !important;
      }

      .mobile-only {
        display: block !important;
      }

      /* Improved scrolling for mobile */
      .tab-content-area {
        overflow-x: hidden;
      }
    }

    @media (max-width: 480px) {
      .box-options {
        grid-template-columns: 1fr;
      }

      .hero-title {
        font-size: 2.8rem;
      }

      .section-title {
        font-size: 1.5rem;
      }

      .cookie-img {
        max-width: 100px;
      }

      .mystery-image {
        max-width: 150px;
      }

      .question-mark {
        font-size: 2.5rem;
        width: 60px;
        height: 60px;
        line-height: 60px;
      }

      /* Smaller header elements for very small screens */
      .logo-img {
        max-width: 100px;
      }

      .mobile-menu-btn {
        font-size: 1.3rem;
        padding: 6px;
      }

      .cart-icon {
        font-size: 1.3rem;
      }
    }

    @media (max-width: 768px) and (orientation: landscape) {
      .hero {
        padding: 30px 0;
      }

      .svg-container {
        flex-direction: row;
        justify-content: center;
      }

      .cookie-img {
        max-width: 100px;
      }

      .features-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      /* Header adjustments for landscape */
      .header-container {
        padding: 0 10px;
      }

      .logo-img {
        max-width: 100px;
      }
    }


    @media (max-width: 768px) {

      /* Base mobile adjustments */
      body {
        font-size: 14px;
      }

      .container {
        padding: 0 15px;
      }

      /* Header mobile styles - Logo centered with menu/cart on sides */
      .modern-header {
        padding: 10px 0;
      }

      .header-container {
        padding: 0 50px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .mobile-menu-btn {
        display: block;
        background: none;
        border: none;
        font-size: 1.5rem;
        color: #333;
        cursor: pointer;
        padding: 8px;
        order: 1;
        /* Left side */
      }

      .logo-container {
        order: 2;
        /* Center */
        flex: 0 1 auto;
        /* margin: 150 15px; */
      }

      .logo-img {
        max-width: 120px;
        height: 50px;
      }

      .header-actions {
        order: 3;
        /* Right side */
      }

      .main-nav {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        order: 4;
        width: 100%;
      }

      .main-nav.active {
        display: block;
      }

      .nav-list {
        flex-direction: column;
        padding: 10px 0;
      }

      .nav-item {
        margin: 0;
      }

      .nav-link {
        padding: 15px 20px;
        justify-content: flex-start;
        border-bottom: 1px solid #f0f0f0;
      }

      .nav-link i {
        margin-right: 10px;
        width: 20px;
        text-align: center;
      }

      /* Hero section mobile */
      .hero {
        /* padding: 40px 0; */
      }

      .hero-title {
        font-size: 2rem;
        margin-bottom: 10px;
      }

      .hero-subtitle {
        font-size: 1rem;
        margin-bottom: 30px;
        padding: 0 10px;
      }

      .svg-container {
        /* flex-direction: column; */
        gap: 30px;
      }

      .team-container {
        margin: 0 10px;
      }

      .cookie-img {
        max-width: 120px;
      }

      /* Features section mobile */
      .features {
        padding: 40px 0;
      }

      .section-title {
        font-size: 1.8rem;
        margin-bottom: 30px;
      }

      .features-grid {
        grid-template-columns: 1fr;
        gap: 20px;
      }

      .feature-card {
        padding: 20px;
      }

      .feature-icon {
        font-size: 2rem;
        margin-bottom: 15px;
      }

      /* Boxes section mobile */
      .boxes {
        padding: 30px 0;
      }

      .box-options {
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
      }

      .box-option {
        padding: 15px;
      }

      .box-img {
        max-width: 80px;
        margin-bottom: 10px;
      }

      /* Cookies grid mobile */
      .cookies-grid {
        grid-template-columns: 1fr;
        gap: 10px;
      }

      /* .cookie-card {
        padding: 15px;
    } */

      /* .cookie-image img {
        max-width: 100px;
    } */

      .click-indicator {
        font-size: 0.8rem;
        padding: 5px;
      }

      /* Mystery section mobile */
      .mystery-content {
        flex-direction: column;
        gap: 30px;
        text-align: center;
      }

      .mystery-image {
        max-width: 200px;
        margin: 0 auto;
      }

      .question-mark {
        font-size: 3rem;
        width: 80px;
        height: 80px;
        line-height: 80px;
      }

      /* Popup mobile styles */
      .cookie-popup {
        flex-direction: column;
        max-height: 70%;
        max-width: 90%;
        margin: 20px auto;
      }

      /* Dropdown Cart Styles */
      .cart-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        width: 350px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        display: none;
        margin-top: 10px;
        border: 1px solid #e0e0e0;
      }

      .cart-dropdown.active {
        display: block;
        animation: fadeInDown 0.3s ease-out;
      }

      @keyframes fadeInDown {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .cart-dropdown-content {
        max-height: 400px;
        overflow-y: auto;
      }

      .cart-dropdown-header {
        padding: 15px 20px;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .cart-dropdown-header h3 {
        margin: 0;
        font-size: 1.2rem;
        color: #333;
      }

      .cart-dropdown-items {
        padding: 0;
        margin: 0;
        list-style: none;
      }

      .cart-dropdown-item {
        padding: 15px 20px;
        border-bottom: 1px solid #f5f5f5;
        display: flex;
        align-items: center;
      }

      .cart-dropdown-item:last-child {
        border-bottom: none;
      }

      .cart-dropdown-item-image {
        width: 50px;
        height: 50px;
        border-radius: 5px;
        overflow: hidden;
        margin-right: 15px;
        background: #f9f9f9;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .cart-dropdown-item-image img {
        max-width: 100%;
        max-height: 100%;
      }

      .cart-dropdown-item-details {
        flex: 1;
      }

      .cart-dropdown-item-name {
        font-weight: 600;
        margin-bottom: 5px;
        color: #333;
      }

      .cart-dropdown-item-price {
        color: #e67e22;
        font-weight: 600;
      }

      .cart-dropdown-item-quantity {
        display: flex;
        align-items: center;
        margin-top: 5px;
      }

      .cart-dropdown-quantity-btn {
        background: #f5f5f5;
        border: none;
        width: 25px;
        height: 25px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 14px;
      }

      .cart-dropdown-quantity-value {
        margin: 0 10px;
        font-weight: 600;
      }

      .cart-dropdown-remove {
        background: none;
        border: none;
        color: #e74c3c;
        cursor: pointer;
        font-size: 16px;
        margin-left: 10px;
      }

      .cart-dropdown-footer {
        padding: 15px 20px;
        border-top: 1px solid #f0f0f0;
      }

      .cart-dropdown-total {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
        font-weight: 600;
        font-size: 1.1rem;
      }

      .cart-dropdown-checkout {
        width: 100%;
        padding: 12px;
        background: #e67e22;
        color: white;
        border: none;
        border-radius: 5px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.3s;
      }

      .cart-dropdown-checkout:hover {
        background: #d35400;
      }

      .cart-dropdown-empty {
        padding: 30px 20px;
        text-align: center;
        color: #777;
      }

      .cart-dropdown-empty i {
        font-size: 40px;
        margin-bottom: 15px;
        color: #ddd;
      }

      /* Header adjustments for dropdown positioning */
      .header-actions {
        position: relative;
      }

      /* Close dropdown when clicking outside */
      .cart-dropdown-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 999;
        display: none;
      }

      .cart-dropdown-overlay.active {
        display: block;
      }

      /* Mobile responsiveness */
      @media (max-width: 768px) {
        .cart-dropdown {
          width: 300px;
          right: -10px;
        }
      }

      @media (max-width: 480px) {
        .cart-dropdown {
          width: 280px;
          right: -15px;
        }
      }



      .popup-image {
        width: 100%;
        height: 200px;
        border-radius: 10px 10px 0 0;
      }

      .popup-content {
        padding: 20px;
      }

      .popup-style-buttons {
        flex-direction: column;
        gap: 10px;
      }

      .popup-style-option {
        width: 100%;
        padding: 12px;
      }

      .popup-actions {
        flex-direction: column;
        gap: 15px;
      }

      .quantity-selector {
        justify-content: center;
      }

      .popup-add-to-cart {
        width: 100%;
      }

      /* Flavor popup mobile */
      .flavor-popup {
        width: 95%;
        max-width: 400px;
        margin: 20px auto;
      }

      .flavor-popup-content {
        padding: 20px;
      }

      .popup-style-selection {
        flex-direction: column;
        gap: 10px;
      }

      .popup-style-btn {
        width: 100%;
        padding: 12px;
      }

      .flavor-grid {
        grid-template-columns: 1fr;
        gap: 10px;
      }

      .flavor-option {
        padding: 15px;
      }

      /* Cart sidebar mobile */
      .cart-sidebar {
        width: 100%;
        height: 100%;

      }

      .cart-sidebar.active {
        right: 0;
      }

      .cart-item {
        flex-direction: column;
        padding: 15px;
        gap: 10px;
      }

      .cart-item-image {
        width: 60px;
        height: 60px;
      }

      .cart-item-details {
        text-align: center;
      }

      .cart-item-actions {
        justify-content: center;
      }

      /* Footer mobile */
      .footer-content {
        flex-direction: column;
        gap: 30px;
        text-align: center;
      }

      .footer-column {
        width: 100%;
      }

      .social-icons {
        justify-content: center;
      }

      /* Button mobile adjustments */
      .btn {
        padding: 12px 20px;
        font-size: 0.9rem;
      }

      .add-to-cart-btn {
        padding: 10px 15px;
        font-size: 0.9rem;
      }

      /* Text size adjustments */
      h1 {
        font-size: 2rem;
      }

      h2 {
        font-size: 1.6rem;
      }

      h3 {
        font-size: 1.3rem;
      }

      h4 {
        font-size: 1.1rem;
      }

      /* Utility classes for mobile */
      .mobile-hidden {
        display: none !important;
      }

      .mobile-only {
        display: block !important;
      }

      /* Improved scrolling for mobile */
      .tab-content-area {
        overflow-x: hidden;
      }
    }

    /* Mobile landscape orientation adjustments */
    @media (max-width: 768px) and (orientation: landscape) {
      .hero {
        padding: 30px 0;
      }

      .svg-container {
        flex-direction: row;
        justify-content: center;
      }

      .cookie-img {
        max-width: 100px;
      }

      .features-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      /* Header adjustments for landscape */
      .header-container {
        padding: 0 10px;
      }

      .logo-img {
        max-width: 100px;
      }
    }

    /* High-resolution mobile devices */
    @media (max-width: 768px) and (-webkit-min-device-pixel-ratio: 2) {

      .cookie-img,
      .box-img,
      .logo-img {
        image-rendering: -webkit-optimize-contrast;
      }
    }

    /* ===== MOBILE FONT SIZE UPDATES (max-width: 768px) ===== */
    @media (max-width: 768px) {

      /* Base font size for mobile */
      body {
        font-size: 14px;
      }

      /* Header text sizes */
      .logo-img {
        height: 40px;
      }

      .nav-link {
        font-size: 1rem;
        padding: 12px 15px;
      }

      .nav-link i {
        font-size: 1.1rem;
      }

      .cart-count {
        font-size: 0.7rem;
      }

      /* Hero section text */
      .hero-title {
        font-size: 2.5rem;
        line-height: 1.1;
        margin-bottom: 15px;
      }

      .hero-subtitle {
        font-size: 1.1rem;
        margin-bottom: 25px;
        line-height: 1.4;
      }

      .team-label {
        font-size: 1rem;
        margin-top: 8px;
      }

      /* Section titles */
      .section-title {
        font-size: 1.8rem;
        margin-bottom: 25px;
      }

      .section-title::after {
        width: 60px;
        height: 3px;
        bottom: -12px;
      }

      .section-subtitle {
        font-size: 1rem;
        margin-bottom: 30px;
      }

      /* Feature cards */
      .feature-card h3 {
        font-size: 1.2rem;
        margin-bottom: 10px;
      }

      .feature-card p {
        font-size: 0.9rem;
        line-height: 1.4;
      }

      .feature-icon {
        font-size: 1.8rem;
        width: 60px;
        height: 60px;
        margin-bottom: 15px;
      }

      /* Box options */
      .box-option h4 {
        font-size: 1.1rem;
        margin-bottom: 8px;
      }

      .box-option p {
        font-size: 0.85rem;
        margin-bottom: 12px;
      }

      .price-display {
        font-size: 1.2rem;
      }

      /* Cookie cards */
      .cookie-details h3 {
        font-size: 1.1rem;
        min-height: auto;
        margin-bottom: 8px;
      }

      .cookie-details p {
        font-size: 0.85rem;
        margin-bottom: 15px;
        line-height: 1.3;
      }

      .cookie-price {
        font-size: 1.2rem;
      }

      .add-to-cart-btn {
        font-size: 0.9rem;
        padding: 10px 15px;
      }

      .click-indicator {
        font-size: 0.7rem;
        padding: 4px 8px;
      }

      .cookie-tag {
        font-size: 0.75rem;
        padding: 3px 8px;
      }

      /* Mystery section */
      .mystery-details h3 {
        font-size: 1.4rem;
        margin-bottom: 12px;
      }

      .mystery-details p {
        font-size: 0.9rem;
        margin-bottom: 12px;
        line-height: 1.4;
      }

      .mystery-details ul li {
        font-size: 0.85rem;
        margin-bottom: 8px;
      }

      .mystery-price {
        font-size: 1.5rem;
        margin: 15px 0;
      }

      .mystery-note {
        font-size: 0.8rem;
        margin-bottom: 15px;
      }

      .mystery-btn {
        font-size: 1rem;
        padding: 10px 15px;
      }

      /* Popup text sizes */
      .flavor-popup-header h3 {
        font-size: 1.3rem;
      }

      .popup-box-info h4 {
        font-size: 1.2rem;
      }

      .popup-box-info p {
        font-size: 0.9rem;
      }

      .popup-box-price {
        font-size: 1.3rem;
      }

      .flavor-instruction {
        font-size: 1rem;
      }

      .selection-counter {
        font-size: 0.9rem;
      }

      .flavor-label {
        font-size: 0.9rem;
      }

      .flavor-name {
        font-size: 0.95rem;
      }

      .flavor-type {
        font-size: 0.8rem;
      }

      .popup-style-btn {
        font-size: 0.85rem;
        padding: 10px 15px;
      }

      .add-to-cart-popup {
        font-size: 1rem;
        padding: 12px;
      }

      /* Cookie detail popup */
      .popup-content h2 {
        font-size: 1.5rem;
        margin-bottom: 12px;
      }

      .popup-content p {
        font-size: 0.9rem;
        margin-bottom: 15px;
      }

      .popup-style-option {
        font-size: 0.85rem;
        padding: 10px 12px;
      }

      .detail-text {
        font-size: 0.9rem;
      }

      .popup-price {
        font-size: 1.4rem;
        margin: 15px 0;
      }

      .quantity-value {
        font-size: 1rem;
      }

      .popup-add-to-cart {
        font-size: 1rem;
        padding: 10px 15px;
      }

      /* Cart sidebar */
      .cart-header h2 {
        font-size: 1.3rem;
      }

      .cart-item-name {
        font-size: 0.95rem;
      }

      .cart-item-price {
        font-size: 0.9rem;
      }

      .cart-total {
        font-size: 1.1rem;
      }

      .checkout-btn {
        font-size: 1rem;
        padding: 12px;
      }

      /* Footer */
      .footer-column h3 {
        font-size: 1.2rem;
        margin-bottom: 12px;
      }

      .footer-column p {
        font-size: 0.9rem;
        line-height: 1.4;
      }

      .social-icons {
        font-size: 1.3rem;
        gap: 1rem;
      }

      .copyright {
        font-size: 0.85rem;
        margin-top: 2rem;
      }

      /* Buttons */
      .btn {
        font-size: 0.9rem;
        padding: 10px 20px;
      }
    }

    /* Voucher Code Section */
    .voucher-section {
      margin: 1.5rem 0;
      padding: 1.5rem;
      background: var(--background);
      border-radius: 12px;
      border: 1px solid var(--secondary);
      box-sizing: border-box;
      /* Ensure padding is included in width */
    }

    .voucher-input-group {
      display: flex;
      gap: 0.8rem;
      margin-bottom: 1rem;
      width: 100%;
      /* Ensure it doesn't exceed container */
      box-sizing: border-box;
      /* Include padding in width calculation */
    }

    .voucher-input {
      flex: 1;
      padding: 0.8rem 1rem;
      border: 1px solid var(--primary);
      border-radius: 10px;
      font-size: 1rem;
      box-sizing: border-box;
      /* Include padding in width */
      min-width: 0;
      /* Prevent flex item from overflowing */
    }

    .apply-voucher-btn {
      padding: 0.8rem 1.5rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
      flex-shrink: 0;
      /* Prevent button from shrinking */
      white-space: nowrap;
      /* Prevent text wrapping */
    }

    .apply-voucher-btn:hover {
      background: var(--accent);
    }

    .voucher-message {
      font-size: 0.9rem;
      margin-top: 0.5rem;
      min-height: 1.2rem;
      word-wrap: break-word;
      /* Prevent long text from overflowing */
    }

    .voucher-success {
      color: var(--success);
    }

    .voucher-error {
      color: #e74c3c;
    }

    .breakdown-item.discount {
      color: var(--success);
      font-weight: 600;
    }

    @media (max-width: 768px) {
      .voucher-input-group {
        flex-direction: column;
      }

      .apply-voucher-btn {
        width: 100%;
      }

      .voucher-section {
        padding: 1rem;
        /* Reduce padding on mobile */
      }
    }

    /* For very small screens */
    @media (max-width: 480px) {
      .voucher-section {
        padding: 0.8rem;
        margin: 1rem 0;
      }

      .voucher-input {
        padding: 0.7rem 0.8rem;
      }

      .apply-voucher-btn {
        padding: 0.7rem 1rem;
      }
    }

    /* District/Zone Loading Styles */
    .district-loading {
      opacity: 0.6;
      pointer-events: none;
    }

    .district-loading::after {
      content: " (Loading...)";
      font-style: italic;
      color: var(--gray);
    }

    .loading-districts {
      position: relative;
    }

    .loading-districts::after {
      content: "";
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      width: 16px;
      height: 16px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .loading-spinner {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(5px);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }

    .loading-spinner.active {
      display: flex;
    }

    .loading-spinner .brand-name {
      font-family: 'Stella', cursive;
      font-size: 4.5rem;
      color: transparent;
      background: linear-gradient(90deg, var(--primary) 0%, var(--primary) 50%, transparent 50%);
      background-size: 200% 100%;
      background-clip: text;
      -webkit-background-clip: text;
      animation: colorFill 2s ease-in-out infinite;
      position: relative;
    }

    @keyframes colorFill {
      0% {
        background-position: 100% 0;
      }

      50% {
        background-position: 0% 0;
      }

      100% {
        background-position: 100% 0;
      }
    }

    /* Alternative pulse animation if you prefer */
    .loading-spinner .brand-name.pulse {
      animation: textPulse 1.5s ease-in-out infinite;
      color: var(--primary);
    }

    @keyframes textPulse {

      0%,
      100% {
        opacity: 0.7;
        transform: scale(1);
      }

      50% {
        opacity: 1;
        transform: scale(1.05);
      }
    }

    /* OTP Step Styles */
    .otp-container {
      text-align: center;
      max-width: 400px;
      margin: 0 auto;
    }

    .otp-inputs {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 2rem 0;
    }

    .otp-input {
      width: 50px;
      height: 60px;
      text-align: center;
      font-size: 1.5rem;
      border: 2px solid var(--primary);
      border-radius: 10px;
      background: white;
    }

    .otp-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--secondary);
    }

    .otp-message {
      margin: 1rem 0;
      min-height: 1.5rem;
      font-weight: 500;
    }

    .otp-success {
      color: var(--success);
    }

    .otp-error {
      color: #e74c3c;
    }

    .resend-otp {
      margin-top: 1rem;
      color: var(--primary);
      cursor: pointer;
      text-decoration: underline;
    }

    .resend-otp:hover {
      color: var(--accent);
    }

    .resend-otp.disabled {
      color: #999;
      cursor: not-allowed;
      text-decoration: none;
    }

    .otp-timer {
      margin-top: 0.5rem;
      font-size: 0.9rem;
      color: #666;
    }
  </style>
</head>

<body>
  <header>
    <div class="logo">
      <a href="index.html">
        <div class="logo-icon">
          <i class="fas fa-cookie-bite"></i>
        </div>
      </a>
      <a href="index.html">
        <div class="logo-text">
          <div class="brand-name">Syrine's Crumble</div>
        </div>
      </a>
    </div>
  </header>

  <!-- Progress -->
  <div class="progress-container">
    <div class="progress-bar">
      <div class="progress-step completed">
        <div class="step-icon"><i class="fas fa-shopping-cart"></i></div>
        <div class="step-label">Cart</div>
      </div>
      <div class="progress-step active">
        <div class="step-icon"><i class="fas fa-truck"></i></div>
        <div class="step-label">Shipping</div>
      </div>
      <div class="progress-step">
        <div class="step-icon"><i class="fas fa-mobile-alt"></i></div>
        <div class="step-label">OTP</div>
      </div>
      <div class="progress-step">
        <div class="step-icon"><i class="fas fa-credit-card"></i></div>
        <div class="step-label">Payment</div>
      </div>
      <div class="progress-step">
        <div class="step-icon"><i class="fas fa-check"></i></div>
        <div class="step-label">Confirmation</div>
      </div>
    </div>
  </div>

  <div class="checkout-container">
    <!-- Checkout Steps -->
    <div class="checkout-content">
      <!-- Step 1: Shipping -->
      <div id="step-shipping" class="checkout-step active">
        <h2 class="section-title">Shipping Information</h2>
        <form id="shipping-form">
          <div class="form-grid">
            <div class="form-group">
              <label for="first-name">First Name</label>
              <input type="text" id="first-name" required>
            </div>
            <div class="form-group">
              <label for="last-name">Last Name</label>
              <input type="text" id="last-name" required>
            </div>
          </div>

          <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" required>
          </div>

          <div class="form-group">
            <label for="phone">Phone</label>
            <input type="tel" id="phone" required>
          </div>

          <div class="form-group">
            <label for="street">Street</label>
            <input type="text" id="street" required>
          </div>

          <div class="form-grid">
            <div class="form-group">
              <label for="building">Building</label>
              <input type="text" id="building" required>
            </div>
            <div class="form-group">
              <label for="floor">Floor</label>
              <input type="text" id="floor" required>
            </div>
          </div>

          <div class="form-grid">
            <div class="form-group">
              <label for="apartment">Apartment</label>
              <input type="text" id="apartment" required>
            </div>

            <div class="form-group">
              <label for="city">City</label>
              <select id="city" required>
                <option value="" disabled selected>Select your city</option>
                <!-- Cities will be loaded dynamically -->
              </select>
            </div>
          </div>

          <!-- Replace the existing city section with this -->
          <div class="form-grid">

            <div class="form-group">
              <label for="district">District/Zone</label>
              <select id="district" required disabled>
                <option value="" disabled selected>Select city first</option>
                <!-- Districts will be loaded dynamically based on city -->
              </select>
            </div>
          </div>

          <div class="checkout-nav">
            <a href="index.html" class="btn btn-prev">
              <i class="fas fa-arrow-left"></i> Back
            </a>
            <button type="button" class="btn btn-next" id="to-payment-step">
              Continue <i class="fas fa-arrow-right"></i>
            </button>
          </div>
        </form>
      </div>

      <!-- Step 2: OTP Verification -->
      <div id="step-otp" class="checkout-step" style="display:none;">
        <h2 class="section-title">Verify Your Phone Number</h2>
        <div class="otp-container">
          <p>We've sent a 6-digit verification code to <span id="otp-phone-display"></span></p>

          <div class="otp-inputs">
            <input type="text" class="otp-input" maxlength="1" data-index="1">
            <input type="text" class="otp-input" maxlength="1" data-index="2">
            <input type="text" class="otp-input" maxlength="1" data-index="3">
            <input type="text" class="otp-input" maxlength="1" data-index="4">
            <input type="text" class="otp-input" maxlength="1" data-index="5">
            <input type="text" class="otp-input" maxlength="1" data-index="6">
          </div>

          <div class="otp-message" id="otp-message"></div>

          <div class="otp-timer" id="otp-timer">Resend code in <span id="countdown">60</span> seconds</div>
          <div class="resend-otp disabled" id="resend-otp">Resend Code</div>

          <div class="checkout-nav">
            <button type="button" class="btn btn-prev" id="back-to-shipping-from-otp">
              <i class="fas fa-arrow-left"></i> Back
            </button>
            <button type="button" class="btn btn-next" id="verify-otp" disabled>
              Verify & Continue <i class="fas fa-arrow-right"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Step 3: Payment -->
      <div id="step-payment" class="checkout-step" style="display:none;">
        <h2 class="section-title">Payment Method</h2>
        <div class="payment-methods">
          <div class="payment-option active" data-method="card">
            <i class="fas fa-credit-card"></i>
            <span>Debit / Credit Card</span>
          </div>
          <div class="payment-option" data-method="cash">
            <i class="fas fa-money-bill-wave"></i>
            <span>Cash Collection</span>
          </div>
        </div>
        <input type="hidden" name="payment-method" id="payment-method" value="card">

        <div class="checkout-nav">
          <button type="button" class="btn btn-prev" id="back-to-shipping">
            <i class="fas fa-arrow-left"></i> Back
          </button>
          <button type="button" class="btn btn-next" id="to-payment">
            Continue to Payment <i class="fas fa-arrow-right"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Order summary -->
    <div class="order-summary">
      <h3 class="summary-title">Order Summary</h3>
      <div class="summary-items"></div>

      <!-- Voucher Code Section -->
      <div class="voucher-section">
        <div class="voucher-input-group">
          <input type="text" class="voucher-input" id="voucher-code" placeholder="Enter voucher code">
          <button class="apply-voucher-btn" id="apply-voucher">
            <i class="fas fa-tag"></i> Apply
          </button>
        </div>
        <div class="voucher-message" id="voucher-message">Enter your voucher</div>
      </div>

      <div class="summary-item"><span>Subtotal</span><span id="subtotal">LE 0.00</span></div>
      <div class="summary-item"><span>Shipping</span><span id="shipping-cost">LE 0.00</span></div>
      <div class="summary-item discount" id="discount-row" style="display: none;">
        <span>Discount</span><span id="discount-amount">-LE 0.00</span>
      </div>
      <div class="summary-total"><span>Total</span><span class="total-amount" id="total-amount">LE 0.00</span></div>
    </div>
  </div>

  <!-- Payment Iframe Modal -->
  <div id="paymentModal" class="payment-modal">
    <div class="payment-modal-content">
      <span class="close-modal" id="closeModal">&times;</span>
      <iframe id="paymentIframe" frameborder="0"></iframe>
    </div>
  </div>

  <div id="loading-spinner" class="loading-spinner">
    <div class="brand-name">Syrine's Crumble</div>
  </div>

  <script type="module">

    const shippingStep = document.getElementById('step-shipping');
    const paymentStep = document.getElementById('step-payment');
    const progressSteps = document.querySelectorAll('.progress-step');

    let summaryItems = null;
    let shippingCities = [];
    let shippingZones = [];
    let otpCode = '';
    let otpTimer = null;
    let canResendOtp = false;



    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    const CART_KEY = 'syrines_crumble_cart';

    let shippingPrices = null;



    const SUPABASE_URL = 'https://kegjyekbrxagrhidvyse.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtlZ2p5ZWticnhhZ3JoaWR2eXNlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxOTYzOTUsImV4cCI6MjA3Mzc3MjM5NX0.Lf_Jz-Q8GUM4XChuNJOJXffA_cGNA2vkgZ-41d08eL8';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let appliedVoucher = null;

    let allVouchers = null;


    // Function to fetch shipping data
    async function fetchShippingData() {
      try {
        console.log('Fetching shipping data...');

        // Fetch cities
        const { data: citiesData, error: citiesError } = await supabase
          .from('shipping_prices')
          .select('*')
          .order('city', { ascending: true });

        if (citiesError) {
          console.error('Error fetching cities:', citiesError);
          return;
        }

        // Fetch zones
        const { data: zonesData, error: zonesError } = await supabase
          .from('shipping_zones')
          .select('*')
          .order('zone_name', { ascending: true });

        if (zonesError) {
          console.error('Error fetching zones:', zonesError);
          // Continue with cities even if zones fail
        }

        shippingCities = citiesData || [];
        shippingZones = zonesData || [];

        console.log('Shipping data loaded:', {
          cities: shippingCities.length,
          zones: shippingZones.length
        });

        // Populate cities dropdown
        populateCitiesDropdown();

      } catch (error) {
        console.error('Error fetching shipping data:', error);
      }
    }

    // Function to populate cities dropdown
    function populateCitiesDropdown() {
      const citySelect = document.getElementById('city');

      // Clear existing options except the first one
      while (citySelect.options.length > 1) {
        citySelect.remove(1);
      }

      // Add cities to dropdown
      shippingCities.forEach(city => {
        const option = document.createElement('option');
        option.value = city.city;
        option.textContent = city.city;
        citySelect.appendChild(option);
      });

      console.log('Cities dropdown populated with', shippingCities.length, 'cities');
    }

    // Function to load districts for selected city
    async function loadDistrictsForCity(cityName) {
      const districtSelect = document.getElementById('district');

      // Clear existing districts
      districtSelect.innerHTML = '<option value="" disabled selected>Select your district/zone</option>';
      districtSelect.disabled = true;

      // Show loading state
      districtSelect.classList.add('loading-districts');

      try {
        console.log('Loading districts for city:', cityName);

        // Find the city in our data
        const city = shippingCities.find(c => c.city === cityName);
        if (!city) {
          console.error('City not found:', cityName);
          return;
        }

        // Get zones for this city
        const cityZones = shippingZones.filter(zone => zone.city_id === city.id);

        console.log(`Found ${cityZones.length} zones for ${cityName}`);

        if (cityZones.length === 0) {
          // If no specific zones, create a default option
          const defaultOption = document.createElement('option');
          defaultOption.value = 'default';
          defaultOption.textContent = 'General Area';
          districtSelect.appendChild(defaultOption);
        } else {
          // Add zones to dropdown
          cityZones.forEach(zone => {
            const option = document.createElement('option');
            option.value = zone.zone_name;
            option.textContent = `${zone.zone_name} (LE ${zone.price})`;
            option.dataset.price = zone.price;
            districtSelect.appendChild(option);
          });
        }

        // Enable district selection
        districtSelect.disabled = false;
        districtSelect.classList.remove('loading-districts');

        // Trigger district change to update shipping cost
        districtSelect.dispatchEvent(new Event('change'));

      } catch (error) {
        console.error('Error loading districts:', error);
        districtSelect.classList.remove('loading-districts');
        districtSelect.innerHTML = '<option value="" disabled selected>Error loading districts</option>';
      }
    }

    // Function to fetch shipping prices
    async function fetchShippingPrices() {
      try {
        const { data: shippingData, error } = await supabase
          .from('shipping_prices')
          .select('*');

        if (error) {
          console.error('Error fetching shipping prices:', error);
          return;
        }

        shippingPrices = shippingData;
        console.log('Shipping prices loaded:', shippingPrices);

      } catch (error) {
        console.error('Error fetching shipping prices:', error);
      }
    }
    // Add this function after your supabase client initialization
    async function fetchAllVouchers() {
      try {
        const { data: vouchers, error } = await supabase
          .from('vouchers')
          .select('*')
          .eq('is_active', true);

        if (error) {
          console.error('Error fetching vouchers:', error);
          return;
        }

        console.log('Available vouchers:', vouchers);

        // You can store them in a variable for later use
        allVouchers = vouchers;

        // Or display them in console for debugging
        if (vouchers && vouchers.length > 0) {
          console.log('Active vouchers loaded:');
          vouchers.forEach(voucher => {
            console.log(`- ${voucher.code}: ${voucher.discount_value}% ${voucher.discount_type}`);
          });
        } else {
          console.log('No active vouchers found');
        }

      } catch (error) {
        console.error('Error fetching vouchers:', error);
      }
    }

    // Update the shipping display function
    function updateShippingDisplay() {
      const shippingCost = getShippingPrice();
      const shippingEl = document.getElementById('shipping-cost');
      const selectedCity = document.getElementById('city').value;
      const selectedDistrict = document.getElementById('district').value;

      if (!selectedCity) {
        shippingEl.textContent = '-';
        shippingEl.style.color = '#999';
      } else if (shippingCost === 0) {
        shippingEl.textContent = 'FREE';
        shippingEl.style.color = 'var(--success)';
      } else {
        shippingEl.textContent = `LE ${shippingCost.toFixed(2)}`;
        shippingEl.style.color = '';
      }

      console.log('Shipping updated - City:', selectedCity, 'District:', selectedDistrict, 'Cost:', shippingCost);
    }

    // Also update the initial page load to handle city selection better
    document.addEventListener('DOMContentLoaded', function () {
      fetchAllVouchers();
      fetchShippingData();

      // Add validation to require city selection
      const citySelect = document.getElementById('city');
      citySelect.required = true;

      // Set initial shipping display and render summary after a short delay
      setTimeout(() => {
        console.log('Initial page load - rendering summary');
        renderSummary();
        updateShippingDisplay();
      }, 100);
    });

    // Function to get shipping price for selected city and district - ENHANCED
    function getShippingPrice() {
      const selectedCity = document.getElementById('city').value;
      const selectedDistrict = document.getElementById('district').value;

      console.log('Getting shipping price for:', {
        city: selectedCity,
        district: selectedDistrict
      });

      if (!selectedCity) {
        console.log('No city selected, returning 0');
        return 0;
      }

      // If district is selected and has a specific price
      if (selectedDistrict && selectedDistrict !== 'default') {
        const districtSelect = document.getElementById('district');
        const selectedOption = districtSelect.options[districtSelect.selectedIndex];
        const districtPrice = parseFloat(selectedOption.dataset.price);

        if (!isNaN(districtPrice)) {
          console.log('Using district price:', districtPrice);
          return districtPrice;
        } else {
          console.log('District price not found or invalid, falling back to city price');
        }
      }

      // Fallback to city price
      const city = shippingCities.find(c => c.city === selectedCity);
      const cityPrice = city ? city.price : 0;
      console.log('Using city price:', cityPrice);
      return cityPrice;
    }

    // Enhanced form validation
    document.getElementById('shipping-form').addEventListener('submit', function (e) {
      const city = document.getElementById('city').value;
      const district = document.getElementById('district').value;

      if (!city) {
        e.preventDefault();
        alert('Please select your city');
        document.getElementById('city').focus();
        return;
      }

      if (!district) {
        e.preventDefault();
        alert('Please select your district/zone');
        document.getElementById('district').focus();
        return;
      }
    });

    // Move from Shipping → Payment
    document.getElementById('to-payment-step').addEventListener('click', () => {
      const form = document.getElementById('shipping-form');
      if (form.checkValidity()) {
        // Get phone number for OTP
        const phone = document.getElementById('phone').value;

        // Send OTP (simulate API call)
        sendOTP(phone);

        // Show OTP step
        shippingStep.style.display = "none";
        document.getElementById('step-otp').style.display = "block";

        // Update progress bar
        progressSteps[1].classList.remove("active");
        progressSteps[1].classList.add("completed");
        progressSteps[2].classList.add("active");
      } else {
        form.reportValidity();
      }
    });


    // Update the voucher application button to check for city first
    document.getElementById('apply-voucher').addEventListener('click', function () {
      const voucherCode = document.getElementById('voucher-code').value.toUpperCase();
      const messageEl = document.getElementById('voucher-message');
      const selectedCity = document.getElementById('city').value;

      // Check if city is selected first
      if (!selectedCity) {
        messageEl.textContent = 'Please enter your data first';
        messageEl.className = 'voucher-message voucher-error';
        // Highlight the city field
        document.getElementById('city').style.borderColor = '#e74c3c';
        return;
      }

      console.log('Voucher code entered (converted to uppercase):', voucherCode);

      if (voucherCode.trim() === '') {
        messageEl.textContent = 'Please enter a voucher code';
        messageEl.className = 'voucher-message voucher-error';
        console.log('Empty voucher code entered');
        return;
      }

      // Check if code exists (case-insensitive)
      const matched = allVouchers.find(v => v.code.toLowerCase() === voucherCode.toLowerCase());

      if (matched) {
        if (matched.is_active !== false) { // Check if voucher is active
          applyVoucherLogic(matched);
          messageEl.textContent = `Voucher "${voucherCode}" applied successfully!`;
          messageEl.className = 'voucher-message voucher-success';
          appliedVoucher = matched;
          console.log('Voucher applied:', matched);
        } else {
          messageEl.textContent = `Voucher "${voucherCode}" is no longer active`;
          messageEl.className = 'voucher-message voucher-error';
          console.log('Inactive voucher entered:', voucherCode);
        }
      } else {
        messageEl.textContent = `Voucher "${voucherCode}" is invalid`;
        messageEl.className = 'voucher-message voucher-error';
        console.log('Invalid voucher entered:', voucherCode);
      }
    });

    // Reset city field border when user selects a city
    document.getElementById('city').addEventListener('change', function () {
      this.style.borderColor = ''; // Reset to default
    });

    // Update the applyVoucherLogic function to use new shipping system
    function applyVoucherLogic(voucher) {
      const cart = getCart();
      const selectedCity = document.getElementById('city').value;

      // Check if city is selected
      if (!selectedCity) {
        const messageEl = document.getElementById('voucher-message');
        messageEl.textContent = 'Please select a city first to calculate shipping';
        messageEl.className = 'voucher-message voucher-error';
        return;
      }

      let subtotal = cart.reduce((sum, item) => sum + (item.unitPrice * item.quantity), 0);
      let discount = 0;
      let shippingCost = getShippingPrice();
      let freeShipping = false;

      console.log('Applying voucher logic:', voucher);
      console.log('Initial subtotal:', subtotal);
      console.log('Shipping cost:', shippingCost);

      // Condition 1: Free Shipping
      if (voucher.free_shipping) {
        console.log('Applying free shipping');
        freeShipping = true;
        discount += shippingCost;
        shippingCost = 0;
      }

      // Condition 2: Item-specific discount
      if (voucher.is_item && voucher.items && Array.isArray(voucher.items)) {
        console.log('Applying item-specific discount');
        console.log('Applicable items:', voucher.items);

        cart.forEach(item => {
          // Check if this item is in the voucher's applicable items list
          if (voucher.items.includes(item.cookieType) || voucher.items.includes(item.size)) {
            const itemTotal = item.unitPrice * item.quantity;
            let itemDiscount = 0;

            // Apply discount based on discount_number or discount_rate
            if (voucher.discount_number) {
              itemDiscount = Math.min(voucher.discount_number * item.quantity, itemTotal);
            } else if (voucher.discount_rate) {
              itemDiscount = (itemTotal * voucher.discount_rate) / 100;
            }

            discount += itemDiscount;
            console.log(`Discount for ${item.name}: ${itemDiscount}`);
          }
        });
      }

      // Condition 3: Total order discount
      if (voucher.total) {
        console.log('Applying total order discount');
        if (voucher.discount_number) {
          discount = Math.min(voucher.discount_number, subtotal);
        } else if (voucher.discount_rate) {
          discount = (subtotal * voucher.discount_rate) / 100;
        }
        console.log('Total discount:', discount);
      }

      // Update UI
      updateOrderSummary(subtotal, discount, shippingCost, freeShipping);
    }

    function renderSummary() {
      console.log('renderSummary called - updating order summary');
      const cart = getCart();
      const selectedCity = document.getElementById('city').value;
      const selectedDistrict = document.getElementById('district').value;

      summaryItems.innerHTML = '';
      let subtotal = 0;

      console.log('Current selection - City:', selectedCity, 'District:', selectedDistrict);
      console.log("cartcartcart", cart)
      cart.forEach(item => {
        const itemTotal = item.unitPrice * item.quantity;
        subtotal += itemTotal;

        // Build flavors block
        let flavorHTML = "";
        if (item.flavors && Array.isArray(item.flavors)) {
          flavorHTML = `
                <div class="item-flavors">
                    ${item.flavors.map(f => `
                        <div class="item-flavor">
                            <span class="flavor-details">
                                ${f.flavor.trim()}
                                <span style="font-weight:bold; font-size:1.2em;"> - </span>
                                x${f.quantity} - ${f.type}
                            </span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        const div = document.createElement('div');
        div.className = 'summary-item';
        div.innerHTML = `
            <div class="item-details">
                <div class="item-image"><img src="${item.img}" alt="${item.name}"></div>
                <div class="item-info">
                    <div class="item-name">${item.name}</div>
                    <div class="item-quantity">Qty: ${item.quantity}</div>
                    ${flavorHTML}
                </div>
            </div>
            <div class="item-price">LE ${itemTotal.toFixed(2)}</div>
        `;

        summaryItems.appendChild(div);
      });

      // Get shipping cost
      const shippingCost = getShippingPrice();
      console.log('Calculated shipping cost:', shippingCost);

      // Apply voucher if one is active
      if (appliedVoucher) {
        console.log('Voucher active, applying voucher logic');
        applyVoucherLogic(appliedVoucher);
      } else {
        // No voucher applied, show regular totals with shipping
        console.log('No voucher, updating regular totals');
        updateOrderSummary(subtotal, 0, shippingCost);
      }
    }

    function updateOrderSummary(subtotal, discount, shippingCost, freeShipping = false) {
      const subtotalEl = document.getElementById('subtotal');
      const shippingEl = document.getElementById('shipping-cost');
      const discountRow = document.getElementById('discount-row');
      const discountAmountEl = document.getElementById('discount-amount');
      const totalAmountEl = document.getElementById('total-amount');

      // Update subtotal
      subtotalEl.textContent = `LE ${subtotal.toFixed(2)}`;

      // Update shipping - use the actual shipping cost from getShippingPrice()
      const selectedCity = document.getElementById('city').value;
      const selectedDistrict = document.getElementById('district').value;

      // Get the actual current shipping cost (this handles district pricing)
      const currentShippingCost = getShippingPrice();

      console.log('Updating order summary - District:', selectedDistrict, 'Shipping Cost:', currentShippingCost);

      if (!selectedCity) {
        shippingEl.textContent = '-';
        shippingEl.style.color = '#999';
      } else if (freeShipping || currentShippingCost === 0) {
        console.log("currentShippingCost", currentShippingCost)
        shippingEl.textContent = 'FREE';
        shippingEl.style.color = 'var(--success)';
        shippingCost = 0; // Ensure shipping cost is 0 for free shipping
      } else {
        shippingEl.textContent = `LE ${currentShippingCost.toFixed(2)}`;
        shippingEl.style.color = '';
        shippingCost = currentShippingCost; // Use the district-based shipping cost
      }

      // Show/hide discount row
      if (discount > 0) {
        discountRow.style.display = 'flex';
        discountAmountEl.textContent = `-LE ${discount.toFixed(2)}`;
      } else {
        discountRow.style.display = 'none';
      }

      // Calculate and update total
      let total = subtotal - discount + shippingCost;
      total = Math.max(0, total);
      totalAmountEl.textContent = `LE ${total.toFixed(2)}`;

      console.log('Updated order summary - Subtotal:', subtotal, 'Discount:', discount, 'Shipping:', shippingCost, 'Total:', total);
    }

    // Also update the input field to show uppercase as user types
    document.getElementById('voucher-code').addEventListener('input', function (e) {
      // Convert input to uppercase in real-time
      e.target.value = e.target.value.toUpperCase();
      console.log('Voucher input changed (uppercase):', e.target.value);
    });

    // Allow pressing Enter to apply voucher
    document.getElementById('voucher-code').addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        console.log('Enter key pressed for voucher');
        document.getElementById('apply-voucher').click();
      }
    });

    // Add remove voucher functionality
    document.getElementById('voucher-code').addEventListener('keydown', function (e) {
      if (e.key === 'Escape' && appliedVoucher) {
        removeVoucher();
      }
    });

    // City change event - UPDATED
    document.getElementById('city').addEventListener('change', function () {
      const selectedCity = this.value;
      const districtSelect = document.getElementById('district');

      console.log('City changed to:', selectedCity);

      // Reset district
      districtSelect.innerHTML = '<option value="" disabled selected>Select your district/zone</option>';
      districtSelect.disabled = true;

      if (selectedCity) {
        loadDistrictsForCity(selectedCity);
      }

      // Update shipping cost immediately
      updateShippingDisplay();

      // Update the summary with new city (even before district is selected)
      const cart = getCart();
      const subtotal = cart.reduce((sum, item) => sum + (item.unitPrice * item.quantity), 0);
      const shippingCost = getShippingPrice();

      if (appliedVoucher) {
        applyVoucherLogic(appliedVoucher);
      } else {
        updateOrderSummary(subtotal, 0, shippingCost);
      }
    });

    // Log when voucher input changes
    document.getElementById('voucher-code').addEventListener('input', function (e) {
      console.log('Voucher input changed:', e.target.value);
    });

    // Log when voucher input is focused
    document.getElementById('voucher-code').addEventListener('focus', function () {
      console.log('Voucher input focused');
    });

    // Log when voucher input loses focus
    document.getElementById('voucher-code').addEventListener('blur', function () {
      console.log('Voucher input blurred');
    });

    // Back from OTP → Shipping
    document.getElementById('back-to-shipping-from-otp').addEventListener('click', () => {
      document.getElementById('step-otp').style.display = "none";
      shippingStep.style.display = "block";

      // Update progress bar
      progressSteps[2].classList.remove("active");
      progressSteps[1].classList.remove("completed");
      progressSteps[1].classList.add("active");

      // Clear OTP inputs and timer
      clearOTP();
    });


    function sendOTP(phone) {
      // Display phone number
      document.getElementById('otp-phone-display').textContent = phone;

      // Simulate sending OTP (in real app, call your backend API)
      console.log('Sending OTP to:', phone);

      // Generate random 6-digit OTP
      otpCode = Math.floor(100000 + Math.random() * 900000).toString();
      console.log('Generated OTP:', otpCode); // For testing

      // Start resend timer
      startOTPTimer();

      // In a real implementation, you would:
      // 1. Call your backend API to send OTP via SMS
      // 2. Handle success/error responses
      // 3. Update UI accordingly
    }

    function startOTPTimer() {
      let timeLeft = 60;
      const timerElement = document.getElementById('countdown');
      const resendButton = document.getElementById('resend-otp');

      // Disable resend button initially
      resendButton.classList.add('disabled');
      canResendOtp = false;

      otpTimer = setInterval(() => {
        timeLeft--;
        timerElement.textContent = timeLeft;

        if (timeLeft <= 0) {
          clearInterval(otpTimer);
          resendButton.classList.remove('disabled');
          canResendOtp = true;
          timerElement.textContent = '0';
        }
      }, 1000);
    }

    function clearOTP() {
      // Clear OTP inputs
      document.querySelectorAll('.otp-input').forEach(input => {
        input.value = '';
      });

      // Clear message
      document.getElementById('otp-message').textContent = '';
      document.getElementById('otp-message').className = 'otp-message';

      // Clear timer
      if (otpTimer) {
        clearInterval(otpTimer);
      }

      // Disable verify button
      document.getElementById('verify-otp').disabled = true;
    }

    // OTP Input Handling
    document.querySelectorAll('.otp-input').forEach(input => {
      input.addEventListener('input', function (e) {
        const value = e.target.value;
        const index = parseInt(this.dataset.index);

        // Only allow numbers
        if (!/^\d*$/.test(value)) {
          this.value = '';
          return;
        }

        // Auto-focus next input
        if (value && index < 6) {
          document.querySelector(`.otp-input[data-index="${index + 1}"]`).focus();
        }

        // Check if all inputs are filled
        checkOTPCompletion();
      });

      input.addEventListener('keydown', function (e) {
        // Handle backspace
        if (e.key === 'Backspace' && !this.value && this.dataset.index > 1) {
          document.querySelector(`.otp-input[data-index="${parseInt(this.dataset.index) - 1}"]`).focus();
        }
      });
    });

    function checkOTPCompletion() {
      const inputs = document.querySelectorAll('.otp-input');
      const isComplete = Array.from(inputs).every(input => input.value);

      document.getElementById('verify-otp').disabled = !isComplete;
    }

    // Verify OTP
    document.getElementById('verify-otp').addEventListener('click', () => {
      const enteredOTP = Array.from(document.querySelectorAll('.otp-input'))
        .map(input => input.value)
        .join('');

      const messageEl = document.getElementById('otp-message');

      if (enteredOTP === otpCode) {
        // OTP verified successfully
        messageEl.textContent = 'Phone number verified successfully!';
        messageEl.className = 'otp-message otp-success';

        // Move to payment step after short delay
        setTimeout(() => {
          document.getElementById('step-otp').style.display = "none";
          paymentStep.style.display = "block";

          // Update progress bar
          progressSteps[2].classList.remove("active");
          progressSteps[2].classList.add("completed");
          progressSteps[3].classList.add("active");
        }, 1000);
      } else {
        // Invalid OTP
        messageEl.textContent = 'Invalid verification code. Please try again.';
        messageEl.className = 'otp-message otp-error';

        // Clear OTP inputs
        document.querySelectorAll('.otp-input').forEach(input => {
          input.value = '';
        });

        // Refocus first input
        document.querySelector('.otp-input[data-index="1"]').focus();

        // Disable verify button
        document.getElementById('verify-otp').disabled = true;
      }
    });

    // Resend OTP
    document.getElementById('resend-otp').addEventListener('click', function () {
      if (!canResendOtp) return;

      const phone = document.getElementById('phone').value;
      sendOTP(phone);

      // Clear previous OTP inputs
      clearOTP();

      // Show message
      const messageEl = document.getElementById('otp-message');
      messageEl.textContent = 'New verification code sent!';
      messageEl.className = 'otp-message otp-success';

      // Refocus first input
      document.querySelector('.otp-input[data-index="1"]').focus();
    });

    // Back from Payment → Shipping
    document.getElementById('back-to-shipping').addEventListener('click', () => {
      paymentStep.style.display = "none";
      shippingStep.style.display = "block";

      // Update progress bar
      progressSteps[2].classList.remove("active");
      progressSteps[1].classList.remove("completed");
      progressSteps[1].classList.add("active");
    });
    function getCart() {
      const cartJSON = localStorage.getItem(CART_KEY);
      return cartJSON ? JSON.parse(cartJSON) : [];
    }
    document.addEventListener('DOMContentLoaded', function () {
      const CART_KEY = 'syrines_crumble_cart';
      // debugger
      //   const cartCount = document.getElementById('cart-count');
      summaryItems = document.querySelector('.summary-items');
      const subtotalEl = document.getElementById('subtotal');
      const totalAmountEl = document.querySelector('.total-amount');

      console.log("summaryItems", summaryItems)
      console.log("subtotalEl", subtotalEl)
      console.log("totalAmountEl", totalAmountEl)

      function getCart() {
        const cartJSON = localStorage.getItem(CART_KEY);
        return cartJSON ? JSON.parse(cartJSON) : [];
      }

      // City change event
      document.getElementById('city').addEventListener('change', function () {
        const selectedCity = this.value;
        const districtSelect = document.getElementById('district');

        // Reset district
        districtSelect.innerHTML = '<option value="" disabled selected>Select your district/zone</option>';
        districtSelect.disabled = true;

        if (selectedCity) {
          loadDistrictsForCity(selectedCity);
        }

        // Update shipping cost
        updateShippingDisplay();
      });

      // District change event - UPDATED
      document.getElementById('district').addEventListener('change', function () {
        console.log('District changed to:', this.value);
        updateShippingDisplay();

        // Re-render the entire summary to update totals
        renderSummary();

        // Re-apply voucher if one is active (to recalculate shipping)
        if (appliedVoucher) {
          console.log('Re-applying voucher after district change');
          applyVoucherLogic(appliedVoucher);
        } else {
          // No voucher, just update with new shipping cost
          const cart = getCart();
          const subtotal = cart.reduce((sum, item) => sum + (item.unitPrice * item.quantity), 0);
          const shippingCost = getShippingPrice();
          updateOrderSummary(subtotal, 0, shippingCost);
        }
      });
      // Update the renderSummary function to include shipping
      // Update the initial renderSummary to show correct shipping
      function renderSummary() {
        const cart = getCart();
        const selectedCity = document.getElementById('city').value;
        const summaryItems = document.querySelector('.summary-items');
        summaryItems.innerHTML = '';
        let subtotal = 0;
        console.log("cartcart", cart);

        cart.forEach(item => {
          const itemTotal = item.unitPrice * item.quantity;
          subtotal += itemTotal;

          // 🔹 Build flavors block
          let flavorHTML = "";
          if (item.flavors && Array.isArray(item.flavors)) {
            flavorHTML = `
        <div class="item-flavors">
          ${item.flavors.map(f => `
            <div class="item-flavor">
              <span class="flavor-details">
                ${f.flavor.trim()}
                <span style="font-weight:bold; font-size:1.2em;"> - </span>
                x${f.quantity} - ${f.type}
              </span>
            </div>
          `).join('')}
        </div>
      `;
          }

          const div = document.createElement('div');
          div.className = 'summary-item';
          div.innerHTML = `
      <div class="item-details">
        <div class="item-image"><img src="${item.img}" alt="${item.name}"></div>
        <div class="item-info">
          <div class="item-name">${item.name}</div>
          <div class="item-quantity">Qty: ${item.quantity}</div>
          ${flavorHTML}
        </div>
      </div>
      <div class="item-price">LE ${itemTotal}.00</div>
    `;

          summaryItems.appendChild(div);
        });

        // Get shipping cost
        const shippingCost = getShippingPrice(selectedCity);

        // Apply voucher if one is active
        if (appliedVoucher) {
          applyVoucherLogic(appliedVoucher);
        } else {
          // No voucher applied, show regular totals with shipping
          updateOrderSummary(subtotal, 0, shippingCost);
        }
      }



      renderSummary();

      // Payment method selection
      document.querySelectorAll('.payment-option').forEach(option => {
        option.addEventListener('click', () => {
          document.querySelectorAll('.payment-option').forEach(opt => opt.classList.remove('active'));
          option.classList.add('active');
          document.getElementById('payment-method').value = option.dataset.method;

          console.log("document.getElementById('payment-method').value", document.getElementById('payment-method').value)
        });
      });


      // Add function to remove voucher
      function removeVoucher() {
        appliedVoucher = null;
        document.getElementById('voucher-code').value = '';
        document.getElementById('voucher-message').textContent = 'Enter your voucher';
        document.getElementById('voucher-message').className = 'voucher-message';
        renderSummary();
      }

      document.getElementById('to-payment').addEventListener('click', async function () {
        const form = document.getElementById('shipping-form');

        // Validate form
        if (form.checkValidity()) {
          // Additional validation for district
          const selectedCity = document.getElementById('city').value;
          const selectedDistrict = document.getElementById('district').value;

          if (!selectedDistrict) {
            alert('Please select your district/zone');
            document.getElementById('district').focus();
            return;
          }

          const cart = getCart();

          if (cart.length === 0) {
            alert('Your cart is empty!');
            return;
          }

          let subtotal = cart.reduce((sum, item) => sum + (item.unitPrice * item.quantity), 0);
          let discount = 0;
          let shippingCost = getShippingPrice();
          let freeShipping = false;

          // Calculate discount and shipping if voucher is applied
          if (appliedVoucher) {
            console.log('Applying voucher in payment:', appliedVoucher);

            // Check for free shipping
            if (appliedVoucher.free_shipping) {
              freeShipping = true;
              discount += shippingCost;
              shippingCost = 0;
              console.log('Free shipping applied');
            }

            // Calculate discount based on voucher type
            if (appliedVoucher.is_item && appliedVoucher.items && Array.isArray(appliedVoucher.items)) {
              // Item-specific discount
              cart.forEach(item => {
                if (appliedVoucher.items.includes(item.cookieType) || appliedVoucher.items.includes(item.size)) {
                  const itemTotal = item.unitPrice * item.quantity;
                  let itemDiscount = 0;

                  if (appliedVoucher.discount_number) {
                    itemDiscount = Math.min(appliedVoucher.discount_number * item.quantity, itemTotal);
                  } else if (appliedVoucher.discount_rate) {
                    itemDiscount = (itemTotal * appliedVoucher.discount_rate) / 100;
                  }

                  discount += itemDiscount;
                  console.log(`Discount for ${item.name}: ${itemDiscount}`);
                }
              });
            } else if (appliedVoucher.total) {
              // Total order discount
              if (appliedVoucher.discount_number) {
                discount = Math.min(appliedVoucher.discount_number, subtotal);
              } else if (appliedVoucher.discount_rate) {
                discount = (subtotal * appliedVoucher.discount_rate) / 100;
              }
              console.log('Total discount applied:', discount);
            }
          }

          const total = Math.max(0, subtotal - discount + shippingCost);
          console.log('Final amount for payment - Subtotal:', subtotal, 'Discount:', discount, 'Shipping:', shippingCost, 'Total:', total);

          const spinner = document.getElementById('loading-spinner');
          spinner.classList.add("active");

          try {
            if (document.getElementById('payment-method').value === "card") {
              // 🔹 Debit/Credit Card via Paymob
              const paymentData = {
                amount: total,
                subtotal: subtotal,
                discount: discount,
                shipping_cost: shippingCost,
                free_shipping: freeShipping,
                firstName: document.getElementById('first-name').value,
                lastName: document.getElementById('last-name').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                street: document.getElementById('street').value,
                building: document.getElementById('building').value,
                floor: document.getElementById('floor').value,
                apartment: document.getElementById('apartment').value,
                city: document.getElementById('city').value,
                district: document.getElementById('district').value,
                country: "EG",
                voucher: appliedVoucher ? {
                  code: appliedVoucher.code,
                  discount_amount: discount,
                  free_shipping: freeShipping,
                  voucher_id: appliedVoucher.id
                } : null,
                items: cart.map(item => ({
                  name: item.name,
                  amount_cents: item.price * 100, // Convert to cents for payment gateway
                  description: item.name,
                  quantity: item.quantity,
                  flavors: item.flavors ? item.flavors.map(f => ({
                    flavor: f.flavor.trim(),
                    quantity: f.quantity,
                    type: f.type
                  })) : []
                }))
              };

              console.log('Sending payment data for card:', paymentData);
              const verificationToken = localStorage.getItem('verification_token');

              const res = await fetch("https://backend-quiet-glitter-4571.fly.dev/create-online-payment", {
                method: "POST",
                headers: { "Content-Type": "application/json", "x-verification-token": verificationToken },
                body: JSON.stringify(paymentData)
              });

              const result = await res.json();
              if (result.iframeUrl) {
                document.getElementById('paymentIframe').src = result.iframeUrl;
                document.getElementById('paymentModal').style.display = "flex";

                // Clear voucher after successful payment initiation
                appliedVoucher = null;
              } else {
                alert("Error: " + (result.error || "Failed to start payment"));
              }
            }
            else if (document.getElementById('payment-method').value === "cash") {
              // 🔹 Cash on Delivery
              const paymentData = {
                amount: total,
                subtotal: subtotal,
                discount: discount,
                shipping_cost: shippingCost,
                free_shipping: freeShipping,
                firstName: document.getElementById('first-name').value,
                lastName: document.getElementById('last-name').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                street: document.getElementById('street').value,
                building: document.getElementById('building').value,
                floor: document.getElementById('floor').value,
                apartment: document.getElementById('apartment').value,
                city: document.getElementById('city').value,
                district: document.getElementById('district').value,
                country: "EG",
                voucher: appliedVoucher ? {
                  code: appliedVoucher.code,
                  voucher_id: appliedVoucher.id,
                  discount_amount: discount,
                  free_shipping: freeShipping
                } : null,
                items: cart.map(item => ({
                  name: item.name,
                  amount_cents: item.price * 100, // Convert to cents
                  description: item.name,
                  quantity: item.quantity,
                  flavors: item.flavors ? item.flavors.map(f => ({
                    flavor: f.flavor.trim(),
                    quantity: f.quantity,
                    type: f.type
                  })) : []
                }))
              };

              console.log('Sending cash payment data:', paymentData);
              const verificationToken = localStorage.getItem('verification_token');
              const res = await fetch("https://backend-quiet-glitter-4571.fly.dev/create-cash-payment", {
                method: "POST",
                headers: { "Content-Type": "application/json", "x-verification-token": verificationToken },
                body: JSON.stringify(paymentData)
              });

              const result = await res.json();

              if (result.success) {
                const orderData = {
                  orderId: result.orderId,
                  amount: total,
                  subtotal: subtotal,
                  discount: discount,
                  shipping_cost: shippingCost,
                  free_shipping: freeShipping,
                  voucher: appliedVoucher ? {
                    code: appliedVoucher.code,
                    voucher_id: appliedVoucher.id,
                    discount_amount: discount,
                    free_shipping: freeShipping
                  } : null,
                  firstName: document.getElementById('first-name').value,
                  lastName: document.getElementById('last-name').value,
                  email: document.getElementById('email').value,
                  phone: document.getElementById('phone').value,
                  street: document.getElementById('street').value,
                  building: document.getElementById('building').value,
                  floor: document.getElementById('floor').value,
                  apartment: document.getElementById('apartment').value,
                  city: document.getElementById('city').value,
                  district: document.getElementById('district').value,
                  country: "EG",
                  paymentMethod: "cash",
                  items: cart.map(item => ({
                    name: item.name,
                    amount_cents: item.price,
                    description: item.name,
                    quantity: item.quantity,
                    flavors: item.flavors ? item.flavors.map(f => ({
                      flavor: f.flavor.trim(),
                      quantity: f.quantity,
                      type: f.type
                    })) : []
                  }))
                };

                // Clear voucher and cart after successful order
                appliedVoucher = null;
                localStorage.removeItem(CART_KEY);

                const encodedData = encodeURIComponent(JSON.stringify(orderData));
                window.location.href = `thankyou.html?success=true&payment=cash&data=${encodedData}`;

              } else {
                window.location.href = "thankyou.html?success=false";
              }
            }

          } catch (e) {
            console.error('Payment error:', e);
            alert('Payment failed: ' + e.message);
          } finally {
            spinner.classList.remove("active");
          }
        } else {
          form.reportValidity();
        }
      });

      // Close modal
      document.getElementById('closeModal').addEventListener('click', function () {
        document.getElementById('paymentModal').style.display = "none";
        document.getElementById('paymentIframe').src = ""; // clear iframe
      });

    });

  </script>
  <!-- Payment Iframe Modal -->
  <div id="paymentModal" class="payment-modal">
    <div class="payment-modal-content">
      <span class="close-modal" id="closeModal">&times;</span>
      <iframe id="paymentIframe" frameborder="0"></iframe>
    </div>
  </div>

  <div id="loading-spinner" class="loading-spinner">
    <div class="brand-name pulse">Syrine's Crumble</div>
  </div>


</body>

</html>