<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | Syrine's Crumble</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #C0394F;
            --primary-light: #FF6B8A;
            --primary-dark: #8B2635;
            --secondary: #FFD7DF;
            --dark: #1e293b;
            --light: #FFFFFF;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --gray: #64748b;
            --gray-light: #e2e8f0;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --border-radius: 12px;
            --border-radius-sm: 8px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.15);
            --transition: all 0.3s ease;
            --sidebar-width: 250px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8fafc;
            color: var(--dark);
            line-height: 1.6;
            padding: 1rem;
            display: grid;
            grid-template-columns: var(--sidebar-width) 1fr;
            grid-template-rows: auto 1fr;
            gap: 1.5rem;
            grid-template-areas:
                "sidebar notifications"
                "sidebar main";
            align-items: start;
        }


        /* Sidebar positioning */
        .sidebar {
            grid-area: sidebar;
            width: var(--sidebar-width);
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            height: fit-content;
            position: sticky;
            top: 1rem;
        }

        .sidebar-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--secondary);
        }

        .sidebar-tabs {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .sidebar-tab {
            padding: 1rem 1.2rem;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 500;
            border: none;
            background: transparent;
            text-align: left;
            width: 100%;
            color: var(--gray);
        }

        .sidebar-tab:hover {
            background: var(--secondary);
            color: var(--primary);
        }

        .sidebar-tab.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(192, 57, 79, 0.2);
        }

        .main-content {
            flex: 1;
            /* max-width: calc(100% - var(--sidebar-width) - 1.5rem); */
        }

        .main-content {
            grid-area: main;
            max-width: 100%;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding: 1.2rem 1.5rem;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        h1 {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .live-badge {
            font-size: 0.7rem;
            background: var(--danger);
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 20px;
            animation: pulse 1.5s infinite;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--primary-light);
            border-radius: 20px;
            font-weight: 500;
            color: var(--primary);
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success);
        }

        /* Notification panel positioning */
        .notification-panel {
            grid-area: notifications;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-top: 0;
            display: flex;
            flex-direction: column;
            height: fit-content;
            max-height: 80px;
            transition: max-height 0.3s ease;
            border: 1px solid #e5e5e5;
        }

        .notification-header {
            padding: 1rem 1.5rem;
            background: var(--primary);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .notification-header h3 {
            margin: 0;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .notification-header .indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .notification-header .badge {
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .notification-content {
            padding: 0.5rem;
            max-height: 250px;
            overflow-y: auto;
        }

        .notification-item {
            padding: 1rem;
            border-radius: 8px;
            margin: 0.5rem;
            background: var(--light);
            animation: notificationFadeIn 0.5s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition);
            cursor: pointer;
        }

        .notification-item:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
        }

        .notification-item.new {
            background: var(--primary-light);
            border-left: 3px solid var(--primary);
        }

        .notification-info {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--primary);
        }

        .notification-details {
            font-size: 0.85rem;
            color: var(--gray);
            display: flex;
            gap: 1rem;
        }

        .notification-detail {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .notification-time {
            font-size: 0.8rem;
            color: var(--gray);
        }

        .notification-actions {
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: var(--transition);
        }

        .notification-item:hover .notification-actions {
            opacity: 1;
        }

        .notification-actions button {
            padding: 0.4rem 0.8rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: var(--transition);
        }

        .view-order {
            background: var(--primary);
            color: white;
        }

        .view-order:hover {
            background: var(--primary-dark);
        }

        .dismiss {
            background: var(--gray-light);
            color: var(--gray);
        }

        .dismiss:hover {
            background: #d1d9e6;
        }

        /* Dashboard Stats */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin: 0.5rem 0;
        }

        .stat-label {
            color: var(--gray);
            font-size: 0.9rem;
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-btn {
            padding: 0.6rem 1.2rem;
            background: white;
            border: 1px solid var(--gray-light);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .filter-btn:hover {
            background: var(--primary-light);
            border-color: var(--primary);
        }

        .search-container {
            position: relative;
            flex-grow: 1;
            max-width: 300px;
        }

        .status-option.disabled {
            opacity: 0.5;
            cursor: not-allowed !important;
        }

        .status-option.disabled:hover {
            transform: none !important;
            box-shadow: none !important;
            background: white !important;
            color: var(--gray) !important;
            border-color: var(--gray-light) !important;
        }

        .search-box {
            padding: 0.6rem 1rem 0.6rem 2.5rem;
            border: 1px solid var(--gray-light);
            border-radius: 8px;
            width: 100%;
            transition: var(--transition);
            font-size: 0.9rem;
        }

        .search-box:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(192, 57, 79, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 0.8rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }

        /* Table */
        .table-container {
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            max-height: 60vh;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 1rem;
            text-align: left;
            font-size: 0.9rem;
            cursor: pointer;
        }

        th {
            background: var(--primary);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            cursor: pointer;
            user-select: none;
            transition: var(--transition);
        }

        th:hover {
            background: var(--primary-dark);
        }

        tr {
            transition: var(--transition);
            border-bottom: 1px solid var(--gray-light);
        }

        tr:last-child {
            border-bottom: none;
        }

        tr:hover {
            background: var(--primary-light);
        }

        /* Status badges */
        .status-badge {
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            display: inline-block;
            text-align: center;
            min-width: 90px;
            cursor: pointer;
            transition: var(--transition);
        }

        .status-badge:hover {
            transform: scale(1.05);
        }

        .status-pending {
            background: #ffeed9;
            color: #e68a00;
        }

        .status-confirmed {
            background: #d9f5e8;
            color: #0c9d58;
        }

        .status-preparing {
            background: #e0e7ff;
            color: #4f46e5;
        }

        .status-delivering {
            background: #e0f2fe;
            color: #0284c7;
        }

        .status-completed {
            background: #f1f5f9;
            color: #64748b;
        }

        .status-cancelled {
            background: #fee2e2;
            color: #dc2626;
        }

        .status-failed {
            background: #fef3c7;
            color: #d97706;
        }

        /* Cookies & Boxes table specific styles */
        .status-available {
            background: #d9f5e8;
            color: #0c9d58;
        }

        .status-low-stock {
            background: #fef3c7;
            color: #d97706;
        }

        .status-out-of-stock {
            background: #fee2e2;
            color: #dc2626;
        }

        .action-btn {
            padding: 0.4rem 0.8rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: var(--transition);
            margin-right: 0.3rem;
        }

        .edit-btn {
            background: var(--primary);
            color: white;
        }

        .edit-btn:hover {
            background: var(--primary-dark);
        }

        .delete-btn {
            background: var(--danger);
            color: white;
        }

        .delete-btn:hover {
            background: #dc2626;
        }

        /* Highlight animation */
        .highlight {
            animation: highlightFade 3s ease;
        }

        @keyframes highlightFade {
            0% {
                background-color: var(--primary-light);
            }

            100% {
                background-color: transparent;
            }
        }

        /* Toast notification */
        #toast {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: var(--primary);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            font-weight: 500;
            z-index: 1000;
            animation: toastFadeIn 0.3s ease;
        }

        @keyframes toastFadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }

            100% {
                opacity: 1;
            }
        }

        /* Loading indicator */
        .loading {
            display: flex;
            justify-content: center;
            padding: 2rem;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Order detail modal - ENHANCED */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
            padding: 20px;
            animation: modalBgFadeIn 0.3s ease;
        }

        @keyframes modalBgFadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: modalFadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            position: relative;
        }

        .modal-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.5), transparent);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .modal-title::before {
            content: 'ðŸ“‹';
            font-size: 1.2em;
        }

        .close-modal {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            font-size: 1.5rem;
            color: white;
        }

        .close-modal:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 2rem;
            flex: 1;
            overflow-y: auto;
            /* display: grid; */
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        @media (max-width: 768px) {
            .modal-body {
                grid-template-columns: 1fr;
                padding: 1.5rem;
                gap: 1.5rem;
            }
        }

        .modal-section {
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--secondary);
        }

        .section-title::before {
            font-size: 1.2em;
        }

        .order-info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        @media (max-width: 480px) {
            .order-info-grid {
                grid-template-columns: 1fr;
            }
        }

        .info-item {
            margin-bottom: 0.75rem;
        }

        .info-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .info-value {
            font-size: 1rem;
            font-weight: 500;
            color: var(--dark);
            padding: 0.5rem 0;
            word-break: break-word;
        }

        .highlight-value {
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }

        /* Items list styling */
        .items-container {
            background: var(--gray-100);
            border-radius: 12px;
            padding: 1.25rem;
            margin-top: 0.5rem;
        }

        .item-card {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: var(--transition);
        }

        .item-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .item-name {
            font-weight: 600;
            color: var(--dark);
        }

        .item-quantity {
            background: var(--primary-light);
            color: #fff;
            padding: 0.2rem 0.6rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .item-details {
            display: flex;
            justify-content: space-between;
            color: var(--gray);
            font-size: 0.9rem;
        }

        .item-price {
            font-weight: 600;
            color: var(--primary);
        }

        .flavor-list {
            margin-top: 0.5rem;
            padding-left: 1rem;
            border-left: 2px solid var(--secondary);
        }

        .flavor-item {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            padding: 0.25rem 0;
            color: var(--gray);
        }

        /* Status progress section */
        .status-section {
            grid-column: 1 / -1;
            background: var(--gray-100);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .status-progress-container {
            position: relative;
            margin: 1.5rem 0;
        }

        .status-progress {
            display: flex;
            justify-content: space-between;
            position: relative;
            z-index: 2;
        }

        .status-step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gray-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--gray);
            position: relative;
            z-index: 2;
            transition: all 0.3s ease;
        }

        .status-step.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 0 0 6px rgba(192, 57, 79, 0.2);
            transform: scale(1.1);
        }

        .status-step.completed {
            background: var(--success);
            color: white;
        }

        .status-progress-line {
            position: absolute;
            top: 30%;
            left: 20px;
            right: 20px;
            height: 4px;
            background: var(--gray-light);
            transform: translateY(-50%);
            z-index: 1;
        }

        .status-progress-fill {
            height: 100%;
            background: var(--success);
            border-radius: 2px;
            transition: width 0.8s ease;
        }

        .status-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 0.75rem;
        }

        .status-label {
            font-size: 0.8rem;
            color: var(--gray);
            text-align: center;
            width: 80px;
            margin-left: -20px;
            font-weight: 500;
        }

        .status-label.active {
            color: var(--primary);
            font-weight: 600;
        }

        /* Status update section */
        .status-update-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border-left: 4px solid var(--primary);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-top: 1rem;
        }

        .status-options {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .status-option {
            padding: 0.7rem 1.2rem;
            border: 1px solid var(--gray-light);
            border-radius: 30px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .status-option.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(192, 57, 79, 0.2);
        }

        .status-option[data-status="Pending"]:hover {
            background: #ffeed9;
            border-color: #e68a00;
        }

        .status-option[data-status="confirmed"]:hover {
            background: #d9f5e8;
            border-color: #0c9d58;
        }

        .status-option[data-status="preparing"]:hover {
            background: #e0e7ff;
            border-color: #4f46e5;
        }

        .status-option[data-status="delivering"]:hover {
            background: #e0f2fe;
            border-color: #0284c7;
        }

        .status-option[data-status="completed"]:hover {
            background: #f1f5f9;
            border-color: #64748b;
        }

        .status-option[data-status="cancelled"]:hover {
            background: #fee2e2;
            border-color: #dc2626;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            padding: 1.5rem 2rem;
            background: var(--gray-100);
            border-top: 1px solid var(--gray-light);
        }

        @media (max-width: 768px) {
            .modal-actions {
                flex-direction: column;
            }
        }

        .modal-btn {
            padding: 0.9rem 2rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-width: 140px;
            justify-content: center;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(192, 57, 79, 0.3);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(192, 57, 79, 0.4);
        }

        .btn-secondary {
            background: white;
            color: var(--gray);
            border: 1px solid var(--gray-light);
        }

        .btn-secondary:hover {
            background: var(--gray-100);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }

        /* Footer */
        footer {
            text-align: center;
            margin-top: 2rem;
            color: var(--gray);
            font-size: 0.9rem;
            padding: 1rem;
        }

        /* Sound button */
        #enable-sound {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 18px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: var(--transition);
            font-size: 0.9rem;
            font-weight: 500;
            box-shadow: var(--shadow);
        }

        #enable-sound:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Theme toggle */
        .theme-toggle {
            position: fixed;
            bottom: 70px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .theme-toggle:hover {
            background: var(--primary-dark);
            transform: translateY(-2px) rotate(15deg);
            box-shadow: var(--shadow-lg);
        }

        /* Quick actions menu */
        .quick-actions {
            position: fixed;
            bottom: 130px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 2000;
        }

        .quick-action-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .quick-action-btn:hover {
            transform: translateY(-3px) scale(1.1);
            background: var(--primary-dark);
            box-shadow: var(--shadow-lg);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            body {
                padding: 0.5rem;
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                position: static;
                margin-bottom: 1rem;
            }

            .main-content {
                max-width: 100%;
            }

            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            th,
            td {
                padding: 0.8rem;
                font-size: 0.85rem;
            }

            .dashboard-stats {
                grid-template-columns: 1fr 1fr;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .search-container {
                max-width: 100%;
            }

            .notification-details {
                flex-direction: column;
                gap: 0.25rem;
            }

            .order-details-grid {
                grid-template-columns: 1fr;
            }

            .status-options {
                flex-direction: column;
            }

            .modal-content {
                width: 95%;
                max-height: 95vh;
            }

            .modal-header {
                padding: 1.2rem;
            }

            .modal-body {
                padding: 1.2rem;
            }

            .modal-actions {
                padding: 1.2rem;
                flex-direction: column;
            }

            .modal-btn {
                width: 100%;
                justify-content: center;
            }

            .status-labels .status-label {
                font-size: 0.7rem;
                width: 60px;
                margin-left: -15px;
            }
        }

        @media (max-width: 480px) {
            .dashboard-stats {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 1.5rem;
            }

            .stat-value {
                font-size: 1.8rem;
            }

            .notification-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .notification-actions {
                align-self: flex-end;
            }

            .status-progress {
                margin: 1rem 0;
            }

            .status-step {
                width: 28px;
                height: 28px;
                font-size: 0.8rem;
            }

            .status-label {
                font-size: 0.65rem;
                width: 50px;
                margin-left: -12px;
            }
        }

        /* Dark mode */
        body.dark-mode {
            background-color: #0f172a;
            color: #e2e8f0;
        }

        body.dark-mode header,
        body.dark-mode .stat-card,
        body.dark-mode .table-container,
        body.dark-mode .notification-panel,
        body.dark-mode .filter-btn,
        body.dark-mode .search-box,
        body.dark-mode .sidebar {
            background-color: #1e293b;
            color: #e2e8f0;
        }

        body.dark-mode .stat-label,
        body.dark-mode .notification-detail,
        body.dark-mode .notification-time,
        body.dark-mode .order-detail-label {
            color: #94a3b8;
        }

        body.dark-mode .filter-btn {
            border-color: #334155;
        }

        body.dark-mode .search-box {
            border-color: #334155;
            background-color: #1e293b;
            color: #e2e8f0;
        }

        body.dark-mode .search-box:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(192, 57, 79, 0.2);
        }

        body.dark-mode tr {
            border-bottom-color: #334155;
        }

        body.dark-mode .items-container,
        body.dark-mode .status-update,
        body.dark-mode .modal-actions {
            background-color: #1e293b;
        }

        body.dark-mode .modal-content {
            background-color: #1e293b;
            color: #e2e8f0;
        }

        body.dark-mode .order-detail-value {
            color: #e2e8f0;
        }

        body.dark-mode .item-row,
        body.dark-mode .modal-header,
        body.dark-mode .status-update {
            border-color: #334155;
        }

        body.dark-mode .btn-secondary {
            background-color: #334155;
            color: #cbd5e1;
        }

        body.dark-mode .btn-secondary:hover {
            background-color: #475569;
        }

        /* Dark mode adjustments for modal */
        body.dark-mode .modal-content {
            background-color: #1e293b;
            color: #e2e8f0;
        }

        body.dark-mode .info-value {
            color: #e2e8f0;
        }

        body.dark-mode .item-card {
            background-color: #0f172a;
        }

        body.dark-mode .items-container,
        body.dark-mode .status-section,
        body.dark-mode .status-update-section {
            background-color: #0f172a;
        }

        body.dark-mode .btn-secondary {
            background-color: #334155;
            color: #cbd5e1;
            border-color: #475569;
        }

        body.dark-mode .btn-secondary:hover {
            background-color: #475569;
        }

        /* Animation for status update */
        @keyframes statusUpdate {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        .status-updated {
            animation: statusUpdate 0.5s ease;
        }

        /* New order highlight styles */
        .new-order {
            background-color: rgba(255, 215, 223, 0.3) !important;
            /* Light pink background */
            border-left: 4px solid var(--primary) !important;
            transition: all 0.3s ease;
        }

        .new-order:hover {
            background-color: transparent !important;
            border-left-color: transparent !important;
        }

        /* Animation for new orders */
        @keyframes newOrderPulse {
            0% {
                background-color: rgba(255, 215, 223, 0.5);
            }

            50% {
                background-color: rgba(255, 215, 223, 0.8);
            }

            100% {
                background-color: rgba(255, 215, 223, 0.3);
            }
        }

        .new-order-pulse {
            animation: newOrderPulse 2s ease-in-out 3;
        }

        .edit-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            font-weight: 600;
            color: var(--dark);
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group textarea {
            padding: 0.75rem;
            border: 1px solid var(--gray-light);
            border-radius: var(--border-radius-sm);
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(192, 57, 79, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Dark mode support */
        body.dark-mode .form-group label {
            color: #e2e8f0;
        }

        body.dark-mode .form-group input,
        body.dark-mode .form-group textarea {
            background-color: #1e293b;
            border-color: #334155;
            color: #e2e8f0;
        }

        body.dark-mode .form-group input:focus,
        body.dark-mode .form-group textarea:focus {
            border-color: var(--primary);
        }

        /* Add to your existing CSS */
        .item-image {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
            border: 2px solid var(--gray-light);
            transition: var(--transition);
        }

        .item-image:hover {
            transform: scale(1.1);
            border-color: var(--primary);
        }

        .edit-form small {
            color: var(--gray);
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }

        /* Add to your existing CSS */
        .current-image-container {
            text-align: center;
            margin: 1rem 0;
        }

        .current-image {
            max-width: 150px;
            max-height: 150px;
            border-radius: 8px;
            border: 2px solid var(--gray-light);
        }

        .file-input {
            padding: 0.5rem;
            border: 2px dashed var(--gray-light);
            border-radius: var(--border-radius-sm);
            width: 100%;
            background: var(--gray-100);
            transition: var(--transition);
        }

        .file-input:hover {
            border-color: var(--primary);
            background: var(--secondary);
        }

        .file-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .image-preview {
            margin-top: 1rem;
            text-align: center;
            padding: 1rem;
            border: 2px solid var(--success);
            border-radius: var(--border-radius-sm);
            background: rgba(16, 185, 129, 0.1);
        }

        .image-preview img {
            max-width: 200px;
            max-height: 200px;
            border-radius: 4px;
        }

        .remove-preview-btn {
            margin-top: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: var(--transition);
        }

        .remove-preview-btn:hover {
            background: #dc2626;
        }

        /* Dark mode support */
        body.dark-mode .file-input {
            background: #1e293b;
            border-color: #334155;
        }

        body.dark-mode .file-input:hover {
            border-color: var(--primary);
            background: #2d3748;
        }

        body.dark-mode .image-preview {
            background: rgba(16, 185, 129, 0.2);
            border-color: var(--success);
        }

        /* Add to your existing CSS */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            border-radius: 16px;
        }

        body.dark-mode .loading-overlay {
            background: rgba(30, 41, 59, 0.95);
        }

        .upload-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        .loading-overlay p {
            color: var(--primary);
            font-weight: 600;
            font-size: 1.1rem;
        }

        /* Enhanced button loading states */
        .modal-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .modal-btn:disabled:hover {
            background: var(--primary);
            transform: none;
            box-shadow: none;
        }

        /* Progress bar for upload (optional) */
        .upload-progress {
            width: 80%;
            height: 6px;
            background: var(--gray-light);
            border-radius: 3px;
            margin: 1rem 0;
            overflow: hidden;
        }

        .upload-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }

        /* Update the existing spin animation */
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Enhanced file input loading state */
        .file-input:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .file-input:disabled:hover {
            border-color: var(--gray-light);
            background: var(--gray-100);
        }

        /* Add to your existing CSS */
        .upload-waiting-message {
            background: #fff3cd !important;
            border: 1px solid #ffeaa7 !important;
            border-radius: 8px !important;
            padding: 1rem !important;
            margin: 1rem 0 !important;
            text-align: center !important;
        }

        .upload-waiting-message strong {
            color: #856404 !important;
        }

        .upload-waiting-message p {
            margin: 0.5rem 0 0 0 !important;
            color: #856404 !important;
            font-size: 0.9rem !important;
        }

        /* Add to your existing CSS */
        #upload-waiting-modal .modal-content {
            background: white;
            border-radius: 16px;
            /* max-width: 500px; */
            animation: modalFadeIn 0.3s ease;
        }

        #upload-waiting-modal .modal-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 1.5rem 2rem;
            border-radius: 16px 16px 0 0;
        }

        /* #upload-waiting-modal .modal-body {
            padding: 2rem;
        } */

        /* Dark mode support for waiting modal */
        body.dark-mode #upload-waiting-modal .modal-content {
            background: #1e293b;
            color: #e2e8f0;
        }

        body.dark-mode #upload-waiting-modal .modal-body {
            background: #1e293b;
        }

        /* Invoice/Receipt styles for restaurant/cafe format */
        .invoice-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .invoice-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.3rem;
            flex: 1;
            min-width: 120px;
            justify-content: center;
        }

        .invoice-preview {
            background: var(--primary);
            color: white;
        }

        .invoice-preview:hover {
            background: var(--primary-dark);
        }

        .invoice-download {
            background: var(--success);
            color: white;
        }

        .invoice-download:hover {
            background: #0d9c4d;
        }

        /* Restaurant/Cafe Receipt Modal Styles */
        .invoice-modal .modal-content {
            max-width: 320px;
            /* Much narrower for receipt format */
            width: 95%;
            font-family: 'Courier New', monospace;
            /* Monospace for receipt look */
        }

        .invoice-header {
            text-align: center;
            padding: 1rem;
            border-bottom: 1px dashed #ccc;
            margin-bottom: 1rem;
        }

        .invoice-title {
            font-size: 1.2rem;
            color: #000;
            margin-bottom: 0.3rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .invoice-subtitle {
            color: #666;
            font-size: 0.8rem;
        }

        .invoice-body {
            padding: 0 1rem 1rem;
            font-size: 0.9rem;
        }

        .invoice-info {
            margin-bottom: 1rem;
        }

        .invoice-section {
            margin-bottom: 1rem;
        }

        .invoice-section-title {
            font-weight: bold;
            margin-bottom: 0.3rem;
            border-bottom: 1px dotted #ccc;
            padding-bottom: 0.3rem;
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        .invoice-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.2rem;
            padding: 0.1rem 0;
            font-size: 0.8rem;
        }

        .invoice-label {
            font-weight: normal;
            color: #000;
        }

        .invoice-value {
            font-weight: bold;
        }

        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            font-size: 0.8rem;
        }

        .invoice-table th {
            background: #f5f5f5;
            color: #000;
            padding: 0.4rem;
            text-align: left;
            font-weight: bold;
            border-bottom: 1px dashed #ccc;
            font-size: 0.8rem;
        }

        .invoice-table td {
            padding: 0.4rem;
            border-bottom: 1px dotted #eee;
            vertical-align: top;
        }

        .invoice-table .item-name {
            font-weight: bold;
        }

        .invoice-table .flavor-item {
            padding-left: 1rem;
            font-style: italic;
            color: #666;
            font-size: 0.75rem;
        }

        .invoice-total {
            background: #f5f5f5;
            font-weight: bold;
            font-size: 0.9rem;
            border-top: 2px solid #000;
            border-bottom: 2px solid #000;
        }

        .invoice-footer {
            text-align: center;
            margin-top: 1rem;
            padding-top: 0.5rem;
            border-top: 1px dashed #ccc;
            color: #666;
            font-size: 0.7rem;
            line-height: 1.2;
        }

        .thank-you {
            font-weight: bold;
            margin: 0.5rem 0;
            font-size: 0.9rem;
        }

        /* Print styles for receipt format */
        @media print {
            body * {
                visibility: hidden;
            }

            .invoice-modal,
            .invoice-modal * {
                visibility: visible;
            }

            .invoice-modal {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                max-width: 320px;
                box-shadow: none;
                margin: 0;
                padding: 0;
            }

            .modal-actions,
            .close-modal {
                display: none !important;
            }

            .invoice-body {
                padding: 0 0.5rem 0.5rem;
            }
        }

        /* Dark mode support for receipt */
        body.dark-mode .invoice-modal .modal-content {
            background: white !important;
            color: black !important;
        }

        body.dark-mode .invoice-table th {
            background: #f5f5f5 !important;
            color: #000 !important;
        }

        body.dark-mode .invoice-total {
            background: #f5f5f5 !important;
        }

        /* Make invoice modal scrollable */
        .invoice-modal .modal-content {
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .invoice-body {
            flex: 1;
            overflow-y: auto;
            max-height: calc(90vh - 120px);
            /* Account for header and actions */
            padding: 0 1rem 1rem;
        }

        /* Custom scrollbar for invoice modal */
        .invoice-body::-webkit-scrollbar {
            width: 6px;
        }

        .invoice-body::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .invoice-body::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .invoice-body::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Vouchers specific styles */
        .voucher-code {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            background: var(--secondary);
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            color: var(--primary);
        }

        /* Form checkbox groups */
        .form-group label input[type="checkbox"] {
            margin-right: 0.5rem;
        }

        /* Responsive adjustments for vouchers table */
        @media (max-width: 768px) {

            #vouchers-tab-content th:nth-child(4),
            #vouchers-tab-content th:nth-child(5),
            #vouchers-tab-content th:nth-child(6),
            #vouchers-tab-content td:nth-child(4),
            #vouchers-tab-content td:nth-child(5),
            #vouchers-tab-content td:nth-child(6) {
                display: none;
            }
        }

        /* Discount field readonly states */
        .discount-field-readonly {
            background-color: #f5f5f5 !important;
            border-color: #ddd !important;
            color: #999 !important;
            cursor: not-allowed !important;
        }

        .discount-field-editable {
            background-color: white !important;
            border-color: var(--gray-light) !important;
            color: var(--dark) !important;
            cursor: text !important;
        }

        /* Dark mode support for readonly fields */
        body.dark-mode .discount-field-readonly {
            background-color: #374151 !important;
            border-color: #4B5563 !important;
            color: #9CA3AF !important;
        }

        body.dark-mode .discount-field-editable {
            background-color: #1F2937 !important;
            border-color: #4B5563 !important;
            color: #E5E7EB !important;
        }

        /* Form input focus states */
        #voucher-discount-rate:not([readonly]):focus,
        #voucher-discount-amount:not([readonly]):focus {
            border-color: var(--primary) !important;
            box-shadow: 0 0 0 3px rgba(192, 57, 79, 0.1) !important;
        }

        /* Multi-select dropdown styles */
        #voucher-items {
            font-family: inherit;
            font-size: 0.9rem;
            background: white;
            transition: var(--transition);
        }

        #voucher-items:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(192, 57, 79, 0.1);
        }

        #voucher-items option {
            padding: 0.5rem;
            border-bottom: 1px solid var(--gray-light);
        }

        #voucher-items option:hover {
            background-color: var(--secondary);
        }

        #voucher-items option:checked {
            background-color: var(--primary);
            color: white;
        }

        /* Dark mode support */
        body.dark-mode #voucher-items {
            background: #1e293b;
            color: #e2e8f0;
            border-color: #334155;
        }

        body.dark-mode #voucher-items option {
            background: #1e293b;
            color: #e2e8f0;
        }

        body.dark-mode #voucher-items option:hover {
            background-color: var(--primary-light);
        }

        body.dark-mode #voucher-items option:checked {
            background-color: var(--primary);
            color: white;
        }

        /* Loading state for dropdown */
        .loading-dropdown {
            opacity: 0.6;
            pointer-events: none;
        }

        .loading-dropdown::after {
            content: " (Loading...)";
            font-style: italic;
            color: var(--gray);
        }

        /* Voucher status badges */
        .status-available {
            background: #d9f5e8;
            color: #0c9d58;
            cursor: pointer;
            transition: var(--transition);
        }

        .status-available:hover {
            background: #c0ebd9;
            transform: scale(1.05);
        }

        .status-out-of-stock {
            background: #fee2e2;
            color: #dc2626;
            cursor: pointer;
            transition: var(--transition);
        }

        .status-out-of-stock:hover {
            background: #fecaca;
            transform: scale(1.05);
        }

        /* Status cell styling */
        .status-cell {
            cursor: pointer;
            text-align: center;
        }

        .status-cell:hover .status-badge {
            transform: scale(1.05);
        }

        /* Dark mode support */
        body.dark-mode .status-available {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        body.dark-mode .status-out-of-stock {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .voucher-code {
            background: var(--secondary);
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            color: var(--primary);
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }

        /* Add to your existing CSS */
        .voucher-applied {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--success);
            border-radius: 8px;
            padding: 0.75rem;
            margin: 0.5rem 0;
        }

        .voucher-code-display {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            background: var(--secondary);
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            color: var(--primary);
            display: inline-block;
        }

        .discount-amount {
            color: var(--success);
            font-weight: bold;
        }

        /* Zone item styles */
        .zone-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--gray-100);
            border-radius: 6px;
            margin-bottom: 0.5rem;
            border: 1px solid var(--gray-light);
            transition: var(--transition);
        }

        .zone-item:hover {
            background: var(--gray-200);
            transform: translateY(-1px);
        }

        .zone-info {
            flex: 1;
        }

        .zone-name {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.25rem;
        }

        .zone-price {
            font-size: 0.8rem;
            color: var(--gray);
        }

        .zone-actions {
            display: flex;
            gap: 0.5rem;
        }

        .empty-zones-message {
            text-align: center;
            color: var(--gray);
            padding: 2rem;
            font-style: italic;
        }

        /* Dark mode support */
        body.dark-mode .zone-item {
            background: #1e293b;
            border-color: #334155;
        }

        body.dark-mode .zone-item:hover {
            background: #2d3748;
        }

        /* Infinite Scroll Loading Styles */
        .loading-more {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            padding: 2rem;
            text-align: center;
            color: var(--gray);
        }

        .loading-more .loading-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .end-of-results {
            text-align: center;
            padding: 2rem;
            color: var(--gray);
            font-style: italic;
            border-top: 1px solid var(--gray-light);
        }


        /* Keep your existing notification panel styles, just update positioning */
        .notification-panel.open {
            max-height: 58px;
        }

        .notification-header {
            padding: 1rem 1.5rem;
            background: var(--primary);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .notification-content {
            padding: 0.5rem;
            max-height: 250px;
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            body {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto 1fr;
                grid-template-areas:
                    "sidebar"
                    "notifications"
                    "main";
                gap: 1rem;
            }

            .sidebar {
                width: 100%;
                position: static;
                margin-bottom: 0;
            }

            .notification-panel {
                margin-top: 0;
            }
        }

        /* Facebook-style Chat Notification Panel */
        .notification-panel {
            grid-area: notifications;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-top: 0;
            display: flex;
            flex-direction: column;
            height: fit-content;
            max-height: 80px;
            /* Start collapsed like Facebook chat */
            transition: max-height 0.3s ease;
            border: 1px solid #e5e5e5;
        }

        .notification-panel.open {
            max-height: 400px;
            /* Expand when open */
            /* min-height: 300px; */
        }

        .notification-header {
            padding: 1rem 1.5rem;
            background: var(--primary);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            flex-shrink: 0;
            position: relative;
        }

        .notification-header h3 {
            margin: 0;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
        }

        .notification-header .indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
        }

        .notification-header .badge {
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .notification-content {
            padding: 0;
            overflow-y: auto;
            flex: 1;
            max-height: 342px;
            background: #f8f9fa;
        }

        /* Chat list styling */
        .chat-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .chat-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s ease;
            background: white;
        }

        .chat-item:hover {
            background-color: #f5f5f5;
        }

        .chat-item.active {
            background-color: #e9f0ff;
            border-left: 3px solid var(--primary);
        }

        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-light);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;
            font-weight: bold;
            color: var(--primary);
        }

        .chat-info {
            flex: 1;
            min-width: 0;
        }

        .chat-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: #1c1e21;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-preview {
            font-size: 0.8rem;
            color: #65676b;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-time {
            font-size: 0.7rem;
            color: #8a8d91;
            white-space: nowrap;
        }

        .chat-status {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
        }

        .status-indicator.pending {
            background: var(--warning);
        }

        .status-indicator.new {
            background: var(--danger);
            animation: pulse 1.5s infinite;
        }

        /* Chat actions */
        .chat-actions {
            display: flex;
            padding: 12px 16px;
            background: white;
            border-top: 1px solid #f0f0f0;
            gap: 8px;
        }

        .chat-action-btn {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .chat-action-btn:hover {
            background: #f5f5f5;
            border-color: #d0d0d0;
        }

        /* Empty state */
        .chat-empty {
            text-align: center;
            padding: 40px 20px;
            color: #8a8d91;
        }

        .chat-empty-icon {
            font-size: 2rem;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .chat-empty-text {
            font-size: 0.9rem;
            margin-bottom: 16px;
        }

        /* Search in chat */
        .chat-search {
            padding: 12px 16px;
            background: white;
            border-bottom: 1px solid #f0f0f0;
        }

        .search-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #e5e5e5;
            border-radius: 20px;
            font-size: 0.85rem;
            outline: none;
            transition: border-color 0.2s ease;
        }

        .search-input:focus {
            border-color: var(--primary);
        }

        /* Animation for new orders */
        @keyframes highlightChat {
            0% {
                background-color: rgba(255, 215, 223, 0.8);
            }

            100% {
                background-color: white;
            }
        }

        .chat-item.new-order {
            animation: highlightChat 2s ease;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .notification-panel {
                margin-top: 0;
            }

            .notification-panel.open {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 90%;
                max-width: 400px;
                height: 70vh;
                max-height: 70vh;
                z-index: 1000;
            }

            .notification-header {
                padding: 0.8rem 1rem;
            }

            .chat-item {
                padding: 10px 12px;
            }
        }

        /* Dark mode support */
        body.dark-mode .notification-panel {
            background: #1e293b;
            border-color: #334155;
        }

        body.dark-mode .notification-content {
            background: #0f172a;
        }

        body.dark-mode .chat-item {
            background: #1e293b;
            border-bottom-color: #334155;
        }

        body.dark-mode .chat-item:hover {
            background-color: #2d3748;
        }

        body.dark-mode .chat-item.active {
            background-color: #2d3748;
        }

        body.dark-mode .chat-name {
            color: #e2e8f0;
        }

        body.dark-mode .chat-preview {
            color: #94a3b8;
        }

        body.dark-mode .chat-time {
            color: #64748b;
        }

        body.dark-mode .chat-actions {
            background: #1e293b;
            border-top-color: #334155;
        }

        body.dark-mode .chat-action-btn {
            background: #1e293b;
            border-color: #334155;
            color: #e2e8f0;
        }

        body.dark-mode .chat-action-btn:hover {
            background: #2d3748;
        }

        body.dark-mode .chat-search {
            background: #1e293b;
            border-bottom-color: #334155;
        }

        body.dark-mode .search-input {
            background: #0f172a;
            border-color: #334155;
            color: #e2e8f0;
        }

        body.dark-mode .search-input:focus {
            border-color: var(--primary);
        }

        /* Discount styles */
        .discount-badge {
            background: linear-gradient(135deg, var(--danger), var(--primary));
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 0.5rem;
            display: inline-block;
        }

        .discount-price {
            color: var(--danger);
            text-decoration: line-through;
            font-size: 0.9em;
            margin-right: 0.5rem;
        }

        .current-price {
            color: var(--success);
            font-weight: bold;
            font-size: 1.1em;
        }

        .discount-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .discount-input {
            width: 80px;
            padding: 0.3rem;
            border: 1px solid var(--gray-light);
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .discount-type-select {
            padding: 0.3rem;
            border: 1px solid var(--gray-light);
            border-radius: 4px;
            font-size: 0.8rem;
            background: white;
        }

        .discount-toggle {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: var(--transition);
        }

        .discount-toggle:hover {
            background: var(--primary-dark);
        }

        .discount-toggle.active {
            background: var(--success);
        }

        .discount-section {
            background: var(--gray-100);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            border-left: 4px solid var(--primary);
        }

        .discount-section-title {
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .discount-variant {
            background: white;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border: 1px solid var(--gray-light);
        }

        .discount-variant:last-child {
            margin-bottom: 0;
        }

        .discount-variant-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .price-display {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .original-price {
            color: var(--gray);
            text-decoration: line-through;
        }

        .final-price {
            color: var(--success);
            font-weight: bold;
            font-size: 1.1em;
        }

        .discount-amount {
            color: var(--danger);
            font-weight: 600;
        }

        .discount-preview {
            background: linear-gradient(135deg, var(--secondary), var(--primary-light));
            border-radius: 6px;
            padding: 0.75rem;
            margin-top: 0.5rem;
            border: 1px solid var(--primary-light);
        }

        .discount-preview-item {
            display: flex;
            justify-content: space-between;
            padding: 0.2rem 0;
            font-size: 0.9rem;
        }

        .discount-preview-label {
            color: var(--gray);
        }

        .discount-preview-value {
            font-weight: 600;
        }

        /* Dark mode support */
        body.dark-mode .discount-variant {
            background: #1e293b;
            border-color: #334155;
        }

        body.dark-mode .discount-preview {
            background: rgba(192, 57, 79, 0.1);
            border-color: var(--primary);
        }
    </style>
</head>

<body>
    <!-- Sidebar with tabs -->
    <div class="sidebar">
        <div class="sidebar-title">
            <span>ðŸ“Š</span> Dashboard
        </div>
        <div class="sidebar-tabs">
            <button class="sidebar-tab active" data-tab="orders">
                <span>ðŸ“‹</span> Orders
                <span class="badge" id="notification-count">0</span>
            </button>
            <button class="sidebar-tab" data-tab="cookies">
                <span>ðŸª</span> Cookies & Boxes
            </button>
            <button class="sidebar-tab" data-tab="vouchers">
                <span>ðŸŽ«</span> Vouchers
            </button>
            <button class="sidebar-tab" data-tab="shipping">
                <span>ðŸšš</span> Shipping Prices
            </button>
        </div>
    </div>

    <!-- Notification Panel at the top -->
    <div class="notification-panel" id="notification-panel">
        <div class="notification-header" id="notification-header">
            <h3>
                <span>ðŸ“‹</span>
                Recent Orders
                <span class="badge" id="notification-count">0</span>
            </h3>
            <div class="indicator">
                <span id="notification-indicator-text">No new orders</span>
                <span class="dropdown-arrow">â–¼</span>
            </div>
        </div>
        <div class="notification-content" id="notification-list">
            <!-- Notifications will be added here dynamically -->
            <div class="notification-item" style="text-align: center; color: #999;">
                No orders yet
            </div>
        </div>
    </div>

    <!-- Main content area -->
    <div class="main-content">
        <header>
            <h1>Admin Panel | Syrine's Crumble <span class="live-badge">LIVE</span></h1>
        </header>

        <div class="container">
            <!-- Orders Tab Content (default) -->
            <div id="orders-tab-content">

                <div class="dashboard-stats">
                    <div class="stat-card" id="total-orders-card">
                        <div class="stat-label">TOTAL ORDERS</div>
                        <div class="stat-value" id="total-orders">0</div>
                    </div>
                    <div class="stat-card" id="today-orders-card">
                        <div class="stat-label">TODAY'S ORDERS</div>
                        <div class="stat-value" id="today-orders">0</div>
                    </div>
                    <div class="stat-card" id="pending-orders-card">
                        <div class="stat-label">PENDING ORDERS</div>
                        <div class="stat-value" id="pending-orders">0</div>
                    </div>
                    <div class="stat-card" id="revenue-card">
                        <div class="stat-label">REVENUE</div>
                        <div class="stat-value" id="total-revenue">EGP 0</div>
                    </div>
                </div>

                <div class="controls">
                    <button class="filter-btn active" data-filter="all">
                        <span>ðŸ“‹</span> All Orders
                    </button>
                    <button class="filter-btn" data-filter="Pending">
                        <span>â³</span> Pending
                    </button>
                    <button class="filter-btn" data-filter="confirmed">
                        <span>âœ…</span> Confirmed
                    </button>
                    <button class="filter-btn" data-filter="preparing">
                        <span>ðŸ‘¨â€ðŸ³</span> Preparing
                    </button>
                    <button class="filter-btn" data-filter="delivering">
                        <span>ðŸšš</span> Delivering
                    </button>
                    <button class="filter-btn" data-filter="failed">
                        <span>âš ï¸</span> Failed
                    </button>
                    <div class="filter-btn" data-status="cancelled">
                        <span>âŒ</span> Cancelled
                    </div>

                    <div class="search-container">
                        <span class="search-icon">ðŸ”</span>
                        <input type="text" class="search-box" placeholder="Search orders..." id="search-input">
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th data-sort="id">Order ID â†•</th>
                                <th data-sort="customer_name">Name â†•</th>
                                <th data-sort="phone">Phone â†•</th>
                                <th data-sort="total">Total (EGP) â†•</th>
                                <th>Items</th>
                                <th data-sort="payment_method">Payment Method â†•</th>
                                <th data-sort="status">Status â†•</th>
                                <th data-sort="created_at">Time â†•</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table">
                            <tr>
                                <td colspan="8">
                                    <div class="loading">
                                        <div class="loading-spinner"></div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <!-- Add after orders table container -->
                <div class="loading-more" id="orders-loading" style="display: none;">
                    <div class="loading-spinner"></div>
                    <span>Loading more orders...</span>
                </div>
            </div>

            <!-- Cookies & Boxes Tab Content (hidden by default) -->
            <div id="cookies-tab-content" style="display: none;">
                <div class="dashboard-stats">
                    <div class="stat-card">
                        <div class="stat-label">TOTAL ITEMS</div>
                        <div class="stat-value" id="total-items">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">IN STOCK</div>
                        <div class="stat-value" id="in-stock">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">LOW STOCK</div>
                        <div class="stat-value" id="low-stock">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">OUT OF STOCK</div>
                        <div class="stat-value" id="out-of-stock">0</div>
                    </div>
                </div>

                <div class="controls">
                    <button class="filter-btn active" data-filter-cookies="all">
                        <span>ðŸª</span> All Items
                    </button>
                    <button class="filter-btn" data-filter-cookies="cookies">
                        <span>ðŸª</span> Cookies
                    </button>
                    <button class="filter-btn" data-filter-cookies="boxes">
                        <span>ðŸ“¦</span> Boxes
                    </button>
                    <button class="filter-btn" id="add-item-btn">
                        <span>âž•</span> Add New Item
                    </button>

                    <div class="search-container">
                        <span class="search-icon">ðŸ”</span>
                        <input type="text" class="search-box" placeholder="Search items..." id="search-cookies-input">
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Image</th>
                                <th data-sort="id">ID â†•</th>
                                <th data-sort="name">Name â†•</th>
                                <th data-sort="type">Type â†•</th>
                                <th data-sort="chewy_price">Chewy Price (EGP) â†•</th>
                                <th data-sort="crumble_price">Crumble Price (EGP) â†•</th>
                                <th>Description</th>
                                <th>Slug</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="cookies-table">
                            <tr>
                                <td colspan="7">
                                    <div class="loading">
                                        <div class="loading-spinner"></div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <!-- Add after cookies table container -->
                <div class="loading-more" id="cookies-loading" style="display: none;">
                    <div class="loading-spinner"></div>
                    <span>Loading more items...</span>
                </div>
            </div>

            <!-- Vouchers Tab Content (hidden by default) -->
            <div id="vouchers-tab-content" style="display: none;">
                <div class="dashboard-stats">
                    <div class="stat-card">
                        <div class="stat-label">TOTAL VOUCHERS</div>
                        <div class="stat-value" id="total-vouchers">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ACTIVE VOUCHERS</div>
                        <div class="stat-value" id="active-vouchers">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">FREE SHIPPING</div>
                        <div class="stat-value" id="free-shipping-vouchers">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">On Item/s</div>
                        <div class="stat-value" id="free-item-vouchers">0</div>
                    </div>
                </div>

                <div class="controls">
                    <button class="filter-btn active" data-filter-vouchers="all">
                        <span>ðŸŽ«</span> All Vouchers
                    </button>
                    <button class="filter-btn" data-filter-vouchers="free_shipping">
                        <span>ðŸšš</span> Free Shipping
                    </button>
                    <button class="filter-btn" data-filter-vouchers="free_item">
                        <span>ðŸŽ</span> On Item/s
                    </button>
                    <button class="filter-btn" data-filter-vouchers="discount">
                        <span>ðŸ’°</span> Discounts
                    </button>
                    <button class="filter-btn" id="add-voucher-btn">
                        <span>âž•</span> Add New Voucher
                    </button>

                    <div class="search-container">
                        <span class="search-icon">ðŸ”</span>
                        <input type="text" class="search-box" placeholder="Search vouchers..."
                            id="search-vouchers-input">
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th data-sort="id">ID â†•</th>
                                <th data-sort="code">Code â†•</th>
                                <th data-sort="free_shipping">Free Shipping â†•</th>
                                <th data-sort="is_item">On Item/s â†•</th>
                                <th data-sort="discount_rate">Discount Rate â†•</th>
                                <th data-sort="discount_number">Discount Amount â†•</th>
                                <th data-sort="total">Total Discount â†•</th>
                                <th>Items</th>
                                <th data-sort="is_active">Status â†•</th>
                                <th data-sort="created_at">Created â†•</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="vouchers-table">
                            <tr>
                                <td colspan="10">
                                    <div class="loading">
                                        <div class="loading-spinner"></div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <!-- Add after vouchers table container -->
                <div class="loading-more" id="vouchers-loading" style="display: none;">
                    <div class="loading-spinner"></div>
                    <span>Loading more vouchers...</span>
                </div>
            </div>

            <!-- Update the shipping prices tab content -->
            <div id="shipping-tab-content" style="display: none;">
                <div class="dashboard-stats">
                    <div class="stat-card">
                        <div class="stat-label">TOTAL CITIES</div>
                        <div class="stat-value" id="total-cities">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">TOTAL ZONES</div>
                        <div class="stat-value" id="total-zones">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">AVG. ZONE PRICE</div>
                        <div class="stat-value" id="avg-zone-price">EGP 0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">HIGHEST ZONE PRICE</div>
                        <div class="stat-value" id="highest-zone-price">EGP 0</div>
                    </div>
                </div>

                <div class="controls">
                    <button class="filter-btn active" data-filter-shipping="all">
                        <span>ðŸ™ï¸</span> All Cities
                    </button>
                    <button class="filter-btn" data-filter-shipping="with-zones">
                        <span>ðŸ“</span> Cities with Zones
                    </button>
                    <button class="filter-btn" data-filter-shipping="no-zones">
                        <span>âŒ</span> Cities without Zones
                    </button>
                    <button class="filter-btn" id="add-city-btn">
                        <span>âž•</span> Add City
                    </button>

                    <div class="search-container">
                        <span class="search-icon">ðŸ”</span>
                        <input type="text" class="search-box" placeholder="Search cities..." id="search-shipping-input">
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th data-sort="id">ID â†•</th>
                                <th data-sort="city">City â†•</th>
                                <th>Zones</th>
                                <th>Price Range</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="cities-table">
                            <tr>
                                <td colspan="5">
                                    <div class="loading">
                                        <div class="loading-spinner"></div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <!-- Add after shipping table container -->
                <div class="loading-more" id="shipping-loading" style="display: none;">
                    <div class="loading-spinner"></div>
                    <span>Loading more cities...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Order detail modal -->
    <div class="modal" id="order-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Order Details</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Order details will be populated here -->
            </div>

            <div class="modal-actions">
                <button class="modal-btn btn-secondary" id="close-modal-btn">
                    <span>âœ•</span> Close
                </button>
                <button class="modal-btn btn-primary" id="update-status-btn">
                    <span>âœ“</span> Update Status
                </button>
            </div>
        </div>
    </div>

    <!-- Toast notification -->
    <div id="toast">New order received!</div>

    <!-- Sound button -->
    <button id="enable-sound">
        <span>ðŸ””</span> Enable Sound
    </button>

    <!-- Theme toggle -->
    <button class="theme-toggle" id="theme-toggle">
        <span>ðŸŒ™</span>
    </button>

    <!-- Quick actions menu -->
    <div class="quick-actions">
        <button class="quick-action-btn" id="refresh-btn" title="Refresh orders">
            <span>ðŸ”„</span>
        </button>
        <button class="quick-action-btn" id="export-btn" title="Export data">
            <span>ðŸ“Š</span>
        </button>
    </div>

    <!-- Add the invoice modal HTML at the bottom of the body, after the existing modals -->
    <div class="modal invoice-modal" id="invoice-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Order Invoice</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="invoice-body" id="invoice-content">
                <!-- Invoice content will be populated here -->
            </div>
            <div class="modal-actions">
                <button class="modal-btn btn-secondary" id="close-invoice-btn">
                    <span>âœ•</span> Close
                </button>
                <button class="modal-btn btn-primary" id="print-invoice-btn">
                    <span>ðŸ–¨ï¸</span> Print Invoice
                </button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Voucher Modal -->
    <div class="modal" id="voucher-modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title" id="voucher-modal-title">Add New Voucher</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="voucher-form" class="edit-form">
                    <div class="form-group">
                        <label for="voucher-code">Voucher Code:</label>
                        <input type="text" id="voucher-code" required>
                        <small>Unique code that customers will use</small>
                    </div>

                    <div class="form-group">
                        <label for="voucher-is-active" style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="voucher-is-active" checked>
                            <span>âœ… Active Voucher</span>
                        </label>
                        <small>Uncheck to temporarily disable this voucher</small>
                    </div>

                    <div class="form-group">
                        <label>Voucher Type:</label>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="voucher-free-shipping">
                                <span>ðŸšš Free Shipping</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="voucher-free-item">
                                <span>ðŸŽ On Item/s</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="voucher-total">
                                <span>ðŸ’° Total Order Discount</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group" id="discount-rate-group" style="display: none;">
                        <label for="voucher-discount-rate">Discount Rate (%):</label>
                        <input type="number" id="voucher-discount-rate" min="0" max="100" step="0.1">
                        <small>Percentage discount (0-100%)</small>
                    </div>

                    <div class="form-group" id="discount-amount-group" style="display: none;">
                        <label for="voucher-discount-amount">Discount Amount (EGP):</label>
                        <input type="number" id="voucher-discount-amount" min="0" step="0.01">
                        <small>Fixed amount discount</small>
                    </div>

                    <div class="form-group" id="items-group" style="display: none;">
                        <label for="voucher-items">Applicable Items:</label>
                        <select id="voucher-items" multiple
                            style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-light); border-radius: var(--border-radius-sm); min-height: 100px;">
                            <option value="" disabled>Loading items...</option>
                        </select>
                        <small>Hold Ctrl/Cmd to select multiple items. Leave empty for all items.</small>
                    </div>

                    <div class="form-group">
                        <label for="voucher-description">Description (Optional):</label>
                        <textarea id="voucher-description" rows="3"
                            placeholder="Describe what this voucher offers..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-actions">
                <button class="modal-btn btn-secondary" id="cancel-voucher-btn">
                    <span>âœ•</span> Cancel
                </button>
                <button class="modal-btn btn-primary" id="save-voucher-btn">
                    <span>âœ“</span> Save Voucher
                </button>
            </div>
        </div>
    </div>

    <!-- Update the City Modal to include zones management -->
    <div class="modal" id="city-modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title" id="city-modal-title">Manage City</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="city-form" class="edit-form">
                    <div class="form-group">
                        <label for="city-name">City Name:</label>
                        <input type="text" id="city-name" required>
                        <small>e.g., "Cairo", "Alexandria", "Giza"</small>
                    </div>

                    <!-- Zones Section -->
                    <div class="form-group">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <label style="margin: 0;">Zones:</label>
                            <button type="button" class="action-btn edit-btn" id="add-zone-btn">
                                <span>ðŸ“</span> Add Zone
                            </button>
                        </div>

                        <div id="zones-container"
                            style="border: 1px solid var(--gray-light); border-radius: 8px; padding: 1rem; max-height: 300px; overflow-y: auto;">
                            <!-- Zones will be added here dynamically -->
                            <div style="text-align: center; color: var(--gray); padding: 2rem;">
                                No zones added yet
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-actions">
                <button class="modal-btn btn-secondary" id="cancel-city-btn">
                    <span>âœ•</span> Cancel
                </button>
                <button class="modal-btn btn-primary" id="save-city-btn">
                    <span>âœ“</span> Save City
                </button>
            </div>
        </div>
    </div>

    <!-- Zone Edit Modal -->
    <div class="modal" id="zone-edit-modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title" id="zone-edit-modal-title">Edit Zone</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="zone-edit-form" class="edit-form">
                    <div class="form-group">
                        <label for="edit-zone-name">Zone Name:</label>
                        <input type="text" id="edit-zone-name" required>
                        <small>e.g., "Downtown", "Nasr City", "Maadi"</small>
                    </div>
                    <div class="form-group">
                        <label for="edit-zone-price">Price (EGP):</label>
                        <input type="number" id="edit-zone-price" step="0.01" min="0" required>
                        <small>Shipping price for this zone</small>
                    </div>
                </form>
            </div>
            <div class="modal-actions">
                <button class="modal-btn btn-secondary" id="cancel-zone-edit-btn">
                    <span>âœ•</span> Cancel
                </button>
                <button class="modal-btn btn-primary" id="save-zone-edit-btn">
                    <span>âœ“</span> Save Zone
                </button>
            </div>
        </div>
    </div>

    <!-- Zone Modal -->
    <div class="modal" id="zone-modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title" id="zone-modal-title">Add Zone</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="zone-form" class="edit-form">
                    <div class="form-group">
                        <label for="zone-city">City:</label>
                        <select id="zone-city" required>
                            <option value="">Select a city</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="zone-name">Zone Name:</label>
                        <input type="text" id="zone-name" required>
                        <small>e.g., "Downtown", "Nasr City", "Maadi"</small>
                    </div>

                    <div class="form-group">
                        <label for="zone-price">Price (EGP):</label>
                        <input type="number" id="zone-price" step="0.01" min="0" required>
                        <small>Shipping price for this specific zone</small>
                    </div>
                </form>
            </div>
            <div class="modal-actions">
                <button class="modal-btn btn-secondary" id="cancel-zone-btn">
                    <span>âœ•</span> Cancel
                </button>
                <button class="modal-btn btn-primary" id="save-zone-btn">
                    <span>âœ“</span> Save Zone
                </button>
            </div>
        </div>
    </div>

    <!-- Audio notification -->
    <audio id="notification-sound" src="sound.wav" preload="auto"></audio>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

        let GITHUB_USERNAME = '';
        let GITHUB_REPO = '';
        let GITHUB_TOKEN = '';
        // Update tracking variables
        let shippingCities = []
        let shippingZones = []
        let currentShippingView = 'cities'
        let shippingSearchQuery = ''
        let selectedCity = null
        let selectedZone = null
        let currentShippingFilter = 'all'
        let selectedShippingZone = null

        // Infinite scroll state for each tab
        const infiniteScrollState = {
            orders: {
                currentPage: 1,
                pageSize: 10,
                hasMore: true,
                isLoading: false,
                allData: [] // Store all loaded data
            },
            cookies: {
                currentPage: 1,
                pageSize: 10,
                hasMore: true,
                isLoading: false,
                allData: []
            },
            vouchers: {
                currentPage: 1,
                pageSize: 10,
                hasMore: true,
                isLoading: false,
                allData: []
            },
            shipping: {
                currentPage: 1,
                pageSize: 10,
                hasMore: true,
                isLoading: false,
                allData: []
            }
        };

        // Vouchers tracking
        let vouchers = []
        let currentVouchersFilter = 'all'
        let vouchersSearchQuery = ''
        let selectedVoucher = null

        // Add this section to the showOrderDetails function after the status update section
        let invoiceActionsHTML = `
    <div class="invoice-actions">
        <button class="invoice-btn invoice-preview" id="preview-invoice-btn">
            <span>ðŸ‘ï¸</span> Preview Invoice
        </button>
        <button class="invoice-btn invoice-download" id="download-invoice-btn">
            <span>ðŸ“¥</span> Download Invoice
        </button>
        <button class="invoice-btn invoice-download" id="download-receipt-btn">
            <span>ðŸ§¾</span> Download Receipt
        </button>
    </div>
`;

        const SUPABASE_URL = 'https://kegjyekbrxagrhidvyse.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtlZ2p5ZWticnhhZ3JoaWR2eXNlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxOTYzOTUsImV4cCI6MjA3Mzc3MjM5NX0.Lf_Jz-Q8GUM4XChuNJOJXffA_cGNA2vkgZ-41d08eL8'
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)


        // DOM Elements
        const tableBody = document.getElementById('orders-table')
        const toast = document.getElementById('toast')
        const sound = document.getElementById('notification-sound')
        const searchInput = document.getElementById('search-input')
        const enableSoundBtn = document.getElementById('enable-sound')
        const notificationPanel = document.getElementById('notification-panel')
        const notificationHeader = document.getElementById('notification-header')
        const notificationList = document.getElementById('notification-list')
        const notificationCount = document.getElementById('notification-count')
        const notificationIndicatorText = document.getElementById('notification-indicator-text')
        const themeToggle = document.getElementById('theme-toggle')
        const orderModal = document.getElementById('order-modal')
        const modalBody = document.getElementById('modal-body')
        const closeModalBtn = document.getElementById('close-modal-btn')
        const updateStatusBtn = document.getElementById('update-status-btn')
        const refreshBtn = document.getElementById('refresh-btn')
        const exportBtn = document.getElementById('export-btn')

        // Tab elements
        const sidebarTabs = document.querySelectorAll('.sidebar-tab')
        const ordersTabContent = document.getElementById('orders-tab-content')
        const cookiesTabContent = document.getElementById('cookies-tab-content')
        const vouchersTabContent = document.getElementById('vouchers-tab-content')
        const shippingTabContent = document.getElementById('shipping-tab-content')
        const cookiesTable = document.getElementById('cookies-table')
        const searchCookiesInput = document.getElementById('search-cookies-input')

        // Track notifications
        let notifications = []
        let unreadCount = 0
        let panelOpen = false
        let sortField = 'created_at'
        let sortDirection = 'desc'
        let selectedOrder = null
        let selectedStatus = null

        // Track orders for stats and filtering
        let orders = []
        let today = new Date().toISOString().split('T')[0]
        let currentFilter = 'all'
        let searchQuery = ''

        // Track cookies/boxes
        let cookies = []
        let currentCookiesFilter = 'all'
        let cookiesSearchQuery = ''

        initializeApp();



        async function loadShippingData(loadMore = false) {
            const state = infiniteScrollState.shipping;

            if (state.isLoading) return;

            try {
                state.isLoading = true;

                if (!loadMore) {
                    state.currentPage = 1;
                    state.allData = [];
                } else {
                    document.getElementById('shipping-loading').style.display = 'flex';
                }

                const { data: citiesData, error: citiesError } = await supabase
                    .from('shipping_prices')
                    .select('*')
                    .order('id', { ascending: true });

                if (citiesError) {
                    console.error('Error loading shipping cities:', citiesError);
                    showToast('Error loading shipping cities');
                    return;
                }

                const { data: zonesData, error: zonesError } = await supabase
                    .from('shipping_zones')
                    .select(`
                *,
                shipping_prices!shipping_zones_city_id_fkey (city)
            `)
                    .order('city_id', { ascending: true });

                if (zonesError) {
                    console.error('Error loading shipping zones:', zonesError);
                    showToast('Error loading shipping zones');
                    return;
                }

                // Apply pagination to cities data
                const startIndex = (state.currentPage - 1) * state.pageSize;
                const endIndex = startIndex + state.pageSize;
                const pageCitiesData = citiesData.slice(startIndex, endIndex);

                state.hasMore = endIndex < citiesData.length;

                if (loadMore) {
                    state.allData = [...state.allData, ...pageCitiesData];
                } else {
                    state.allData = pageCitiesData;
                }

                state.currentPage++;

                shippingCities = state.allData;
                shippingZones = zonesData;

                updateShippingStats();
                renderShippingViews();

                document.getElementById('shipping-loading').style.display = 'none';

                if (!state.hasMore && state.allData.length > 0) {
                    const existingEndMessage = document.getElementById('shipping-end-message');
                    if (!existingEndMessage) {
                        const endMessage = document.createElement('div');
                        endMessage.id = 'shipping-end-message';
                        endMessage.className = 'end-of-results';
                        endMessage.textContent = 'No more cities to load';
                        document.getElementById('shipping-tab-content').appendChild(endMessage);
                    }
                }

            } catch (err) {
                console.error('Failed to load shipping data:', err);
                showToast('Failed to load shipping data');
            } finally {
                state.isLoading = false;
            }
        }

        // Scroll detection for infinite scroll
        function setupInfiniteScroll() {
            const tableContainers = document.querySelectorAll('.table-container');

            tableContainers.forEach(container => {
                container.addEventListener('scroll', function () {
                    // Check if scrolled to bottom (within 100px)
                    const scrollTop = this.scrollTop;
                    const scrollHeight = this.scrollHeight;
                    const clientHeight = this.clientHeight;

                    if (scrollHeight - scrollTop - clientHeight < 100) {
                        // Determine which tab is active and load more data
                        if (ordersTabContent.style.display !== 'none') {
                            if (infiniteScrollState.orders.hasMore && !infiniteScrollState.orders.isLoading) {
                                loadOrders(true);
                            }
                        } else if (cookiesTabContent.style.display !== 'none') {
                            if (infiniteScrollState.cookies.hasMore && !infiniteScrollState.cookies.isLoading) {
                                loadCookies(true);
                            }
                        } else if (vouchersTabContent.style.display !== 'none') {
                            if (infiniteScrollState.vouchers.hasMore && !infiniteScrollState.vouchers.isLoading) {
                                loadVouchers(true);
                            }
                        } else if (shippingTabContent.style.display !== 'none') {
                            if (infiniteScrollState.shipping.hasMore && !infiniteScrollState.shipping.isLoading) {
                                loadShippingData(true);
                            }
                        }
                    }
                });
            });
        }

        // Initialize infinite scroll
        setupInfiniteScroll();

        function updateShippingStats() {
            const totalCitiesEl = document.getElementById('total-cities')
            const totalZonesEl = document.getElementById('total-zones')
            const avgZonePriceEl = document.getElementById('avg-zone-price')
            const highestZonePriceEl = document.getElementById('highest-zone-price')

            totalCitiesEl.textContent = shippingCities.length
            totalZonesEl.textContent = shippingZones.length

            if (shippingZones.length > 0) {
                const prices = shippingZones.map(zone => parseFloat(zone.price))
                const avgPrice = prices.reduce((sum, price) => sum + price, 0) / prices.length
                const highestPrice = Math.max(...prices)

                avgZonePriceEl.textContent = `EGP ${avgPrice.toFixed(2)}`
                highestZonePriceEl.textContent = `EGP ${highestPrice.toFixed(2)}`
            } else {
                avgZonePriceEl.textContent = 'EGP 0'
                highestZonePriceEl.textContent = 'EGP 0'
            }
        }

        function renderShippingViews() {
            if (currentShippingView === 'cities') {
                renderCitiesView()
            } else {
                renderZonesView()
            }
        }

        // Update the renderCitiesView function
        function renderCitiesView() {
            const citiesTable = document.getElementById('cities-table')
            const filteredCities = filterCities()

            if (filteredCities.length === 0) {
                citiesTable.innerHTML = `
            <tr>
                <td colspan="5" style="text-align: center; padding: 2rem;">
                    No cities found matching your criteria
                </td>
            </tr>
        `
                return
            }

            citiesTable.innerHTML = ''


            filteredCities.forEach(city => {
                const row = document.createElement('tr')

                // Get zones for this city
                const cityZones = shippingZones.filter(zone => zone.city_id === city.id)
                const zonesCount = cityZones.length

                // Calculate price range
                let priceRange = 'No zones'
                if (zonesCount > 0) {
                    const prices = cityZones.map(zone => parseFloat(zone.price))
                    const minPrice = Math.min(...prices)
                    const maxPrice = Math.max(...prices)
                    priceRange = minPrice === maxPrice ?
                        `EGP ${minPrice.toFixed(2)}` :
                        `EGP ${minPrice.toFixed(2)} - EGP ${maxPrice.toFixed(2)}`
                }

                // Format zones display
                let zonesDisplay = 'No zones'
                if (zonesCount > 0) {
                    if (zonesCount <= 3) {
                        zonesDisplay = cityZones.map(zone => `
                    <div style="display: inline-block; background: var(--secondary); padding: 0.2rem 0.5rem; border-radius: 4px; margin: 0.1rem; font-size: 0.8rem;">
                        ${zone.zone_name} (EGP ${parseFloat(zone.price).toFixed(2)})
                    </div>
                `).join('')
                    } else {
                        zonesDisplay = `
                    <div style="display: inline-block; background: var(--primary-light); color: var(--primary); padding: 0.2rem 0.5rem; border-radius: 4px; margin: 0.1rem; font-size: 0.8rem;">
                        ${zonesCount} zones
                    </div>
                `
                    }
                }

                row.innerHTML = `
            <td>${city.id}</td>
            <td><strong>${city.city}</strong></td>
            <td>${zonesDisplay}</td>
            <td>${priceRange}</td>
            <td>
                <button class="action-btn edit-btn" data-id="${city.id}" data-type="city">Manage</button>
                <button class="action-btn delete-btn" data-id="${city.id}" data-type="city">Delete</button>
            </td>
        `

                // Add event listeners
                row.querySelector('.edit-btn').addEventListener('click', (e) => {
                    e.stopPropagation()
                    editCity(city.id)
                })

                row.querySelector('.delete-btn').addEventListener('click', (e) => {
                    e.stopPropagation()
                    deleteCity(city.id, city.city)
                })

                citiesTable.appendChild(row)
            })
        }

        function renderZonesView() {
            const zonesTable = document.getElementById('zones-table')
            const filteredZones = filterZones()

            if (filteredZones.length === 0) {
                zonesTable.innerHTML = `
            <tr>
                <td colspan="5" style="text-align: center; padding: 2rem;">
                    No zones found matching your criteria
                </td>
            </tr>
        `
                return
            }

            zonesTable.innerHTML = ''

            filteredZones.forEach(zone => {
                const row = document.createElement('tr')

                // Get city name from the nested relationship
                const cityName = zone.shipping_prices?.city || 'Unknown'

                row.innerHTML = `
            <td>${zone.id}</td>
            <td><strong>${cityName}</strong></td>
            <td>${zone.zone_name}</td>
            <td>EGP ${parseFloat(zone.price).toFixed(2)}</td>
            <td>
                <button class="action-btn edit-btn" data-id="${zone.id}" data-type="zone">Edit</button>
                <button class="action-btn delete-btn" data-id="${zone.id}" data-type="zone">Delete</button>
            </td>
        `

                // Add event listeners
                row.querySelector('.edit-btn').addEventListener('click', (e) => {
                    e.stopPropagation()
                    editZone(zone.id)
                })

                row.querySelector('.delete-btn').addEventListener('click', (e) => {
                    e.stopPropagation()
                    deleteZone(zone.id, zone.zone_name)
                })

                zonesTable.appendChild(row)
            })
        }

        // Update the filterCities function
        function filterCities() {
            return shippingCities.filter(city => {
                // Apply status filter
                const cityZones = shippingZones.filter(zone => zone.city_id === city.id)

                if (currentShippingFilter === 'with-zones' && cityZones.length === 0) {
                    return false
                }
                if (currentShippingFilter === 'no-zones' && cityZones.length > 0) {
                    return false
                }

                // Apply search filter
                if (shippingSearchQuery) {
                    const searchTerm = shippingSearchQuery.toLowerCase()
                    return city.city.toLowerCase().includes(searchTerm)
                }

                return true
            })
        }

        function filterZones() {
            return shippingZones.filter(zone => {
                if (shippingSearchQuery) {
                    const searchTerm = shippingSearchQuery.toLowerCase()
                    const cityName = zone.shipping_prices?.city || ''
                    return (
                        cityName.toLowerCase().includes(searchTerm) ||
                        zone.zone_name.toLowerCase().includes(searchTerm)
                    )
                }
                return true
            })
        }

        // Update the showCityModal function to use the new modal system
        function showCityModal(city = null) {
            selectedCity = city;
            console.log("selectedCity", selectedCity)
            const modal = document.getElementById('city-modal');
            const title = document.getElementById('city-modal-title');
            const zonesContainer = document.getElementById('zones-container');

            if (city) {
                title.textContent = `Manage City: ${city.city}`;
                document.getElementById('city-name').value = city.city;

                // Load and display zones for this city
                const cityZones = shippingZones.filter(zone => zone.city_id === city.id);
                console.log("cityZones", cityZones)
                renderZonesInModal(cityZones);
            } else {
                title.textContent = 'Add New City';
                document.getElementById('city-form').reset();
                zonesContainer.innerHTML = `
                <div class="empty-zones-message">
                    No zones added yet
                </div>
            `;
            }

            // Setup add zone button to use modal
            const addZoneBtn = document.getElementById('add-zone-btn');
            addZoneBtn.onclick = () => showZoneEditModal();

            modal.style.display = 'flex';
        }
        // Function to add a new zone in the modal
        function addZoneToModal(zone = null, zoneIndex = null) {
            const zoneName = prompt('Enter zone name:')
            if (!zoneName) return

            const zonePrice = parseFloat(prompt('Enter zone price (EGP):'))
            if (isNaN(zonePrice) || zonePrice < 0) {
                showToast('Please enter a valid price')
                return
            }

            const zonesContainer = document.getElementById('zones-container')

            // Remove "no zones" message if it exists
            if (zonesContainer.querySelector('div[style*="text-align: center"]')) {
                zonesContainer.innerHTML = ''
            }

            const newZoneHTML = `
        <div class="zone-item" data-zone-index="${zoneIndex || Date.now()}" style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--gray-100); border-radius: 6px; margin-bottom: 0.5rem;">
            <div style="flex: 1;">
                <div style="font-weight: 600;">${zoneName}</div>
                <div style="font-size: 0.8rem; color: var(--gray);">EGP ${zonePrice.toFixed(2)}</div>
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <button type="button" class="action-btn edit-btn edit-zone-btn" data-zone-index="${zoneIndex || Date.now()}">
                    Edit
                </button>
                <button type="button" class="action-btn delete-btn delete-zone-btn" data-zone-index="${zoneIndex || Date.now()}">
                    Delete
                </button>
            </div>
        </div>
    `

            if (zoneIndex !== null) {
                // Replace existing zone
                const existingZone = zonesContainer.querySelector(`[data-zone-index="${zoneIndex}"]`)
                if (existingZone) {
                    existingZone.outerHTML = newZoneHTML
                }
            } else {
                // Add new zone
                zonesContainer.innerHTML += newZoneHTML
            }

            // Re-attach event listeners
            const newZoneElement = zonesContainer.querySelector(`[data-zone-index="${zoneIndex || Date.now()}"]`)
            if (newZoneElement) {
                newZoneElement.querySelector('.edit-zone-btn').addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.zoneIndex)
                    const zoneName = newZoneElement.querySelector('div:first-child div:first-child').textContent
                    const zonePrice = parseFloat(newZoneElement.querySelector('div:first-child div:last-child').textContent.replace('EGP ', ''))
                    editZoneInModal({ zone_name: zoneName, price: zonePrice }, index)
                })

                newZoneElement.querySelector('.delete-zone-btn').addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.zoneIndex)
                    deleteZoneFromModal(index)
                })
            }
        }



        // Update the renderZonesInModal function
        function renderZonesInModal(zones) {
            const zonesContainer = document.getElementById('zones-container');

            if (zones.length === 0) {
                zonesContainer.innerHTML = `
            <div class="empty-zones-message">
                No zones added yet
            </div>
        `;
                return;
            }

            zonesContainer.innerHTML = zones.map((zone, index) => `
        <div class="zone-item" data-zone-index="${index}" data-zone-name="${zone.zone_name}" data-zone-price="${zone.price}">
            <div class="zone-info">
                <div class="zone-name">${zone.zone_name}</div>
                <div class="zone-price">EGP ${parseFloat(zone.price).toFixed(2)}</div>
            </div>
            <div class="zone-actions">
                <button type="button" class="action-btn edit-btn edit-zone-modal-btn">
                    Edit
                </button>
                <button type="button" class="action-btn delete-btn delete-zone-btn">
                    Delete
                </button>
            </div>
        </div>
    `).join('');

            // Add event listeners
            attachZoneEventListeners();
        }



        // Function to edit a zone in the modal
        function editZoneInModal(zone, zoneIndex) {
            const newZoneName = prompt('Enter new zone name:', zone.zone_name)
            if (!newZoneName) return

            const newZonePrice = parseFloat(prompt('Enter new zone price (EGP):', zone.price))
            if (isNaN(newZonePrice) || newZonePrice < 0) {
                showToast('Please enter a valid price')
                return
            }

            addZoneToModal({ zone_name: newZoneName, price: newZonePrice }, zoneIndex)
        }

        // Add modal event listeners for the zone edit modal
        function setupZoneEditModalEvents() {
            const zoneEditModal = document.getElementById('zone-edit-modal');
            const cancelBtn = document.getElementById('cancel-zone-edit-btn');
            const saveBtn = document.getElementById('save-zone-edit-btn');
            const closeBtn = zoneEditModal.querySelector('.close-modal');

            const closeModal = () => {
                zoneEditModal.style.display = 'none';
            };

            cancelBtn.addEventListener('click', closeModal);
            closeBtn.addEventListener('click', closeModal);
            saveBtn.addEventListener('click', saveZoneFromModal);

            zoneEditModal.addEventListener('click', (e) => {
                if (e.target === zoneEditModal) {
                    closeModal();
                }
            });

            // Allow Enter key to save
            zoneEditModal.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveZoneFromModal();
                }
            });
        }


        async function saveCity() {
            try {
                const cityName = document.getElementById('city-name').value.trim();

                if (!cityName) {
                    showToast('City name is required');
                    return;
                }

                // Collect zones from the modal
                const zonesContainer = document.getElementById('zones-container');
                const zoneElements = zonesContainer.querySelectorAll('.zone-item:not(.empty-zones-message)');
                const zonesData = [];

                zoneElements.forEach(zoneElement => {
                    // Get data from the data attributes we set
                    const zoneName = zoneElement.dataset.zoneName;
                    const zonePrice = parseFloat(zoneElement.dataset.zonePrice);

                    if (zoneName && !isNaN(zonePrice)) {
                        zonesData.push({
                            zone_name: zoneName,
                            price: zonePrice
                        });
                    }
                });

                console.log('Saving city with zones:', { cityName, zonesData });

                let error;
                if (selectedCity) {
                    // Update existing city
                    const { error: updateError } = await supabase
                        .from('shipping_prices')
                        .update({ city: cityName })
                        .eq('id', selectedCity.id);
                    error = updateError;

                    if (!error) {
                        // Delete existing zones and insert new ones
                        const { error: deleteError } = await supabase
                            .from('shipping_zones')
                            .delete()
                            .eq('city_id', selectedCity.id);

                        if (!deleteError && zonesData.length > 0) {
                            const zonesToInsert = zonesData.map(zone => ({
                                city_id: selectedCity.id,
                                zone_name: zone.zone_name,
                                price: zone.price
                            }));

                            const { error: insertError } = await supabase
                                .from('shipping_zones')
                                .insert(zonesToInsert);
                            error = insertError;
                        }
                    }
                } else {
                    // Create new city
                    const { data: newCity, error: insertCityError } = await supabase
                        .from('shipping_prices')
                        .insert([{ city: cityName }])
                        .select()
                        .single();
                    error = insertCityError;

                    if (!error && newCity && zonesData.length > 0) {
                        const zonesToInsert = zonesData.map(zone => ({
                            city_id: newCity.id,
                            zone_name: zone.zone_name,
                            price: zone.price
                        }));

                        const { error: insertZonesError } = await supabase
                            .from('shipping_zones')
                            .insert(zonesToInsert);
                        error = insertZonesError;
                    }
                }

                if (error) {
                    console.error('Error saving city:', error);
                    showToast('Error saving city: ' + error.message);
                    return;
                }

                showToast(`City ${selectedCity ? 'updated' : 'created'} successfully`);
                document.getElementById('city-modal').style.display = 'none';
                loadShippingData();

            } catch (err) {
                console.error('Failed to save city:', err);
                showToast('Failed to save city');
            }
        }

        // Add this function to debug the current zones
        function debugCurrentZones() {
            const zonesContainer = document.getElementById('zones-container');
            const zoneElements = zonesContainer.querySelectorAll('.zone-item');
            console.log('Current zones in modal:', zoneElements.length);

            zoneElements.forEach((zone, index) => {
                console.log(`Zone ${index}:`, {
                    name: zone.dataset.zoneName,
                    price: zone.dataset.zonePrice,
                    element: zone
                });
            });
        }

        // Call this in your saveCity function temporarily to debug
        // Add this line at the beginning of saveCity function:
        console.log('=== DEBUG: Starting saveCity ===');
        debugCurrentZones();

        async function deleteCity(id, cityName) {
            if (confirm(`Are you sure you want to delete city "${cityName}"? This will also delete all zones in this city.`)) {
                try {
                    const { error } = await supabase
                        .from('shipping_prices')
                        .delete()
                        .eq('id', id)

                    if (error) {
                        console.error('Error deleting city:', error)
                        showToast('Error deleting city')
                        return
                    }

                    showToast('City deleted successfully')
                    loadShippingData()

                } catch (err) {
                    console.error('Failed to delete city:', err)
                    showToast('Failed to delete city')
                }
            }
        }

        // Zone CRUD operations
        async function showZoneModal(zone = null) {
            selectedZone = zone
            const modal = document.getElementById('zone-modal')
            const title = document.getElementById('zone-modal-title')
            const citySelect = document.getElementById('zone-city')

            // Populate cities dropdown
            citySelect.innerHTML = '<option value="">Select a city</option>'
            shippingCities.forEach(city => {
                const option = document.createElement('option')
                option.value = city.id
                option.textContent = city.city
                citySelect.appendChild(option)
            })

            if (zone) {
                title.textContent = `Edit Zone: ${zone.zone_name}`
                document.getElementById('zone-city').value = zone.city_id
                document.getElementById('zone-name').value = zone.zone_name
                document.getElementById('zone-price').value = zone.price
            } else {
                title.textContent = 'Add New Zone'
                document.getElementById('zone-form').reset()
            }

            modal.style.display = 'flex'
        }

        async function saveZone() {
            try {
                const cityId = parseInt(document.getElementById('zone-city').value)
                const zoneName = document.getElementById('zone-name').value.trim()
                const price = parseFloat(document.getElementById('zone-price').value) || 0

                if (!cityId) {
                    showToast('Please select a city')
                    return
                }

                if (!zoneName) {
                    showToast('Zone name is required')
                    return
                }

                if (price < 0) {
                    showToast('Price cannot be negative')
                    return
                }

                const zoneData = {
                    city_id: cityId,
                    zone_name: zoneName,
                    price: price
                }

                let error
                if (selectedZone) {
                    const { error: updateError } = await supabase
                        .from('shipping_zones')
                        .update(zoneData)
                        .eq('id', selectedZone.id)
                    error = updateError
                } else {
                    const { error: insertError } = await supabase
                        .from('shipping_zones')
                        .insert([zoneData])
                    error = insertError
                }

                if (error) {
                    console.error('Error saving zone:', error)
                    showToast('Error saving zone: ' + error.message)
                    return
                }

                showToast(`Zone ${selectedZone ? 'updated' : 'created'} successfully`)
                document.getElementById('zone-modal').style.display = 'none'
                loadShippingData()

            } catch (err) {
                console.error('Failed to save zone:', err)
                showToast('Failed to save zone')
            }
        }

        async function deleteZone(id, zoneName) {
            if (confirm(`Are you sure you want to delete zone "${zoneName}"?`)) {
                try {
                    const { error } = await supabase
                        .from('shipping_zones')
                        .delete()
                        .eq('id', id)

                    if (error) {
                        console.error('Error deleting zone:', error)
                        showToast('Error deleting zone')
                        return
                    }

                    showToast('Zone deleted successfully')
                    loadShippingData()

                } catch (err) {
                    console.error('Failed to delete zone:', err)
                    showToast('Failed to delete zone')
                }
            }
        }

        // Edit functions
        async function editCity(id) {
            const city = shippingCities.find(c => c.id === id)
            if (city) {
                showCityModal(city)
            }
        }

        async function editZone(id) {
            const zone = shippingZones.find(z => z.id === id)
            if (zone) {
                showZoneModal(zone)
            }
        }


        // Update the setupShippingEventListeners function
        function setupShippingEventListeners() {
            // Filter buttons
            document.querySelectorAll('.filter-btn[data-filter-shipping]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn[data-filter-shipping]').forEach(b => b.classList.remove('active'))
                    btn.classList.add('active')
                    currentShippingFilter = btn.dataset.filterShipping
                    renderCitiesView()
                })
            })

            // Search input
            document.getElementById('search-shipping-input').addEventListener('input', () => {
                shippingSearchQuery = document.getElementById('search-shipping-input').value
                renderCitiesView()
            })

            // Add city button
            document.getElementById('add-city-btn').addEventListener('click', () => {
                showCityModal()
            })

            // Modal events
            document.getElementById('cancel-city-btn').addEventListener('click', () => {
                document.getElementById('city-modal').style.display = 'none'
            })

            document.getElementById('save-city-btn').addEventListener('click', saveCity)

            // Close modal on background click and close button
            document.getElementById('city-modal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('city-modal') || e.target.classList.contains('close-modal')) {
                    document.getElementById('city-modal').style.display = 'none'
                }
            })
        }
        // Add this initialization function
        async function initializeApp() {
            try {
                // Fetch credentials from your API
                const githubResponse = await fetch('https://backend-quiet-glitter-4571.fly.dev/github-credentials');
                const githubConfig = await githubResponse.json();

                // Set the credentials
                GITHUB_USERNAME = githubConfig.username;
                GITHUB_REPO = githubConfig.repo;
                GITHUB_TOKEN = githubConfig.token;

                // Start your application
                loadOrders();
                setupEventListeners();
                setupShippingEventListeners()
                setupZoneEditModalEvents();

            } catch (error) {
                console.error('Failed to initialize app:', error);
                showToast('Failed to load application configuration');
            }
        }


        // Unlock sound on user interaction
        enableSoundBtn.addEventListener('click', () => {
            sound.play().then(() => {
                console.log("Sound enabled")
                enableSoundBtn.style.display = 'none'
            }).catch(err => {
                console.log("Failed to enable sound:", err)
            })
        })


        // Function to show the zone edit modal
        function showZoneEditModal(zone = null, zoneIndex = null) {
            const modal = document.getElementById('zone-edit-modal');
            const title = document.getElementById('zone-edit-modal-title');
            const form = document.getElementById('zone-edit-form');

            if (zone) {
                title.textContent = 'Edit Zone';
                document.getElementById('edit-zone-name').value = zone.zone_name || '';
                document.getElementById('edit-zone-price').value = zone.price || '';
            } else {
                title.textContent = 'Add New Zone';
                form.reset();
            }

            // Store the zone data for saving
            modal.dataset.zoneIndex = zoneIndex !== null ? zoneIndex : '';
            modal.dataset.zoneData = zone ? JSON.stringify(zone) : '';

            modal.style.display = 'flex';

            // Focus on the name field for better UX
            setTimeout(() => {
                document.getElementById('edit-zone-name').focus();
            }, 100);
        }


        // Function to save zone from modal
        function saveZoneFromModal() {
            const modal = document.getElementById('zone-edit-modal');
            const zoneIndex = modal.dataset.zoneIndex;
            const existingZoneData = modal.dataset.zoneData ? JSON.parse(modal.dataset.zoneData) : null;

            const zoneName = document.getElementById('edit-zone-name').value.trim();
            const zonePrice = parseFloat(document.getElementById('edit-zone-price').value);

            if (!zoneName) {
                showToast('Zone name is required');
                return;
            }

            if (isNaN(zonePrice) || zonePrice < 0) {
                showToast('Please enter a valid price');
                return;
            }

            const zonesContainer = document.getElementById('zones-container');

            // Remove "no zones" message if it exists
            if (zonesContainer.querySelector('.empty-zones-message')) {
                zonesContainer.innerHTML = '';
            }

            // Create the new zone HTML
            const newZoneHTML = `
        <div class="zone-item" data-zone-name="${zoneName}" data-zone-price="${zonePrice}">
            <div class="zone-info">
                <div class="zone-name">${zoneName}</div>
                <div class="zone-price">EGP ${zonePrice.toFixed(2)}</div>
            </div>
            <div class="zone-actions">
                <button type="button" class="action-btn edit-btn edit-zone-modal-btn">
                    Edit
                </button>
                <button type="button" class="action-btn delete-btn delete-zone-btn">
                    Delete
                </button>
            </div>
        </div>
    `;

            if (zoneIndex !== null && zoneIndex !== '' && zoneIndex !== 'null') {
                // Replace existing zone
                const existingZone = zonesContainer.querySelector(`[data-zone-index="${zoneIndex}"]`);
                if (existingZone) {
                    existingZone.outerHTML = newZoneHTML;
                    // Update the data attribute for the new element
                    const newZone = zonesContainer.querySelector(`[data-zone-name="${zoneName}"]`);
                    if (newZone) {
                        newZone.setAttribute('data-zone-index', zoneIndex);
                    }
                }
            } else {
                // Add new zone - generate a unique index
                const newIndex = 'zone_' + Date.now();
                const zoneWithIndex = newZoneHTML.replace(
                    'class="zone-item"',
                    `class="zone-item" data-zone-index="${newIndex}"`
                );
                zonesContainer.innerHTML += zoneWithIndex;
            }

            // Re-attach event listeners
            attachZoneEventListeners();

            // Close modal
            modal.style.display = 'none';

            showToast(`Zone ${existingZoneData ? 'updated' : 'added'} successfully`);
        }
        // Function to attach event listeners to zone buttons
        function attachZoneEventListeners() {
            const zonesContainer = document.getElementById('zones-container');

            // Edit zone buttons
            zonesContainer.querySelectorAll('.edit-zone-modal-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const zoneItem = e.target.closest('.zone-item');
                    const zoneName = zoneItem.querySelector('.zone-name').textContent;
                    const zonePrice = parseFloat(zoneItem.querySelector('.zone-price').textContent.replace('EGP ', ''));
                    const zoneIndex = zoneItem.dataset.zoneIndex;

                    showZoneEditModal({
                        zone_name: zoneName,
                        price: zonePrice
                    }, zoneIndex);
                });
            });

            // Delete zone buttons
            zonesContainer.querySelectorAll('.delete-zone-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const zoneItem = e.target.closest('.zone-item');
                    const zoneName = zoneItem.querySelector('.zone-name').textContent;
                    deleteZoneFromModal(zoneItem.dataset.zoneIndex, zoneName);
                });
            });
        }


        // Function to delete zone with confirmation
        function deleteZoneFromModal(zoneIndex, zoneName) {
            if (confirm(`Are you sure you want to delete zone "${zoneName}"?`)) {
                const zoneElement = document.querySelector(`[data-zone-index="${zoneIndex}"]`);
                if (zoneElement) {
                    zoneElement.remove();
                }

                // Show "no zones" message if all zones are deleted
                const zonesContainer = document.getElementById('zones-container');
                if (zonesContainer.children.length === 0) {
                    zonesContainer.innerHTML = `
                <div class="empty-zones-message">
                    No zones added yet
                </div>
            `;
                }

                showToast('Zone deleted successfully');
            }
        }

        // Function to generate restaurant/cafe receipt HTML with voucher information
        function generateInvoiceHTML(order, type = 'invoice') {
            const items = order.items ? JSON.parse(order.items) : [];
            const subtotal = order.subtotal || items.reduce((sum, item) => sum + ((item.amount_cents || item.price * 100) / 100 * item.quantity), 0);
            const discount = order.discount || 0;
            const shippingCost = order.shipping_cost || 0;
            const freeShipping = order.free_shipping || false;
            const total = order.total || subtotal - discount + shippingCost;

            const currentDate = new Date().toLocaleDateString('en-EG', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });

            const orderTime = new Date(order.created_at).toLocaleTimeString('en-EG', {
                hour: '2-digit',
                minute: '2-digit'
            });

            const orderDate = new Date(order.created_at).toLocaleDateString('en-EG', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });

            // Voucher information section
            let voucherHTML = '';
            if (order.voucher_code || order.voucher_id) {
                voucherHTML = `
            <div class="invoice-section">
                <div class="invoice-section-title">Voucher Applied</div>
                <div class="invoice-row">
                    <span class="invoice-label">Voucher Code:</span>
                    <span class="invoice-value" style="color: var(--success); font-weight: bold;">${order.voucher_code || 'N/A'}</span>
                </div>
                ${discount > 0 ? `
                <div class="invoice-row">
                    <span class="invoice-label">Discount Applied:</span>
                    <span class="invoice-value" style="color: var(--success);">-EGP ${discount.toFixed(2)}</span>
                </div>
                ` : ''}
                ${freeShipping ? `
                <div class="invoice-row">
                    <span class="invoice-label">Free Shipping:</span>
                    <span class="invoice-value" style="color: var(--success);">âœ… Applied</span>
                </div>
                ` : ''}
            </div>
        `;
            }

            return `
        <div class="invoice-header">
            <h1 class="invoice-title">Syrine's Crumble</h1>
            <div class="invoice-subtitle">Order ${type === 'invoice' ? 'Invoice' : 'Receipt'}</div>
        </div>
        
        <div class="invoice-info">
            <div class="invoice-section">
                <div class="invoice-section-title">Order Details</div>
                <div class="invoice-row">
                    <span class="invoice-label">Order #:</span>
                    <span class="invoice-value">${order.order_id}</span>
                </div>
                <div class="invoice-row">
                    <span class="invoice-label">Date:</span>
                    <span class="invoice-value">${orderDate}</span>
                </div>
                <div class="invoice-row">
                    <span class="invoice-label">Time:</span>
                    <span class="invoice-value">${orderTime}</span>
                </div>
                <div class="invoice-row">
                    <span class="invoice-label">Customer:</span>
                    <span class="invoice-value">${order.customer_name}</span>
                </div>
                <div class="invoice-row">
                    <span class="invoice-label">Payment:</span>
                    <span class="invoice-value">${order.payment_method}</span>
                </div>
            </div>
        </div>
        
        ${voucherHTML}
        
        <table class="invoice-table">
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Qty</th>
                    <th>Price</th>
                </tr>
            </thead>
            <tbody>
                ${items.map(item => `
                    <tr>
                        <td class="item-name">${item.name}</td>
                        <td>${item.quantity}</td>
                        <td>${((item.amount_cents / 100) * item.quantity).toFixed(2)}</td>
                    </tr>
                    ${item.flavors && item.flavors.map(flavor => `
                        <tr class="flavor-item">
                            <td>+ ${flavor.flavor}</td>
                            <td>${flavor.quantity}</td>
                            <td>-</td>
                        </tr>
                    `).join('') || ''}
                `).join('')}
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="2" style="text-align: right; font-weight: bold;">Subtotal:</td>
                    <td style="font-weight: bold;">EGP ${subtotal.toFixed(2)}</td>
                </tr>
                ${discount > 0 ? `
                <tr>
                    <td colspan="2" style="text-align: right; font-weight: bold; color: var(--success);">Discount:</td>
                    <td style="font-weight: bold; color: var(--success);">-EGP ${discount.toFixed(2)}</td>
                </tr>
                ` : ''}
                <tr>
                    <td colspan="2" style="text-align: right; font-weight: bold;">Shipping:</td>
                    <td style="font-weight: bold;">${freeShipping || shippingCost === 0 ? 'FREE' : `EGP ${shippingCost.toFixed(2)}`}</td>
                </tr>
                <tr class="invoice-total">
                    <td colspan="2" style="text-align: right;">TOTAL:</td>
                    <td>EGP ${total.toFixed(2)}</td>
                </tr>
            </tfoot>
        </table>
        
        ${order.address ? `
        <div class="invoice-section">
            <div class="invoice-section-title">Delivery Address</div>
            <div class="invoice-row">
                <span style="font-size: 0.8rem;">${order.address}</span>
            </div>
        </div>
        ` : ''}
        
        ${order.special_instructions ? `
        <div class="invoice-section">
            <div class="invoice-section-title">Special Instructions</div>
            <div class="invoice-row">
                <span style="font-size: 0.8rem;">${order.special_instructions}</span>
            </div>
        </div>
        ` : ''}
        
        <div class="invoice-footer">
            <div class="thank-you">Thank you for your order!</div>
            <div>Contact: +20 104 493 0284</div>
            <div>Follow us on social media</div>
            <div style="margin-top: 0.5rem;">* Please keep this receipt for your records *</div>
        </div>
    `;
        }

        // Function to show receipt preview
        function showInvoicePreview(order, type = 'invoice') {
            const invoiceModal = document.getElementById('invoice-modal');
            const invoiceContent = document.getElementById('invoice-content');

            // Update modal title based on type
            const modalTitle = invoiceModal.querySelector('.modal-title');
            modalTitle.textContent = type === 'invoice' ? 'Order Invoice' : 'Order Receipt';

            // Generate and set receipt content
            invoiceContent.innerHTML = generateInvoiceHTML(order, type);

            // Show the modal
            invoiceModal.style.display = 'flex';

            // Set up event listeners for this modal
            setupInvoiceModalEvents(order, type);
        }

        // Function to setup invoice modal events
        function setupInvoiceModalEvents(order, type) {
            const invoiceModal = document.getElementById('invoice-modal');
            const closeInvoiceBtn = document.getElementById('close-invoice-btn');
            const printInvoiceBtn = document.getElementById('print-invoice-btn');
            const closeModalBtn = invoiceModal.querySelector('.close-modal');

            const closeModal = () => {
                invoiceModal.style.display = 'none';
            };

            closeInvoiceBtn.addEventListener('click', closeModal);
            closeModalBtn.addEventListener('click', closeModal);

            invoiceModal.addEventListener('click', (e) => {
                if (e.target === invoiceModal) closeModal();
            });

            printInvoiceBtn.addEventListener('click', () => {
                window.print();
            });
        }

        // Function to reset notification count on hover
        function setupNotificationResetOnHover() {
            const orderRows = document.querySelectorAll('#orders-table tr[data-order-id]');

            orderRows.forEach(row => {
                row.addEventListener('mouseenter', () => {
                    if (row.classList.contains('new-order')) {
                        // Reset notification count
                        unreadCount = 0;
                        notificationCount.textContent = '0';
                        notificationCount.style.display = 'none';
                        notificationIndicatorText.textContent = 'No new orders';

                        // Remove new-order class from this row
                        row.classList.remove('new-order', 'new-order-pulse');
                    }
                });
            });
        }

        // Function to download receipt as PDF
        function downloadInvoice(order, type = 'invoice') {
            // Create a printable version of the receipt
            const invoiceHTML = generateInvoiceHTML(order, type);

            // Create a new window with the receipt content
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>${type === 'invoice' ? 'Invoice' : 'Receipt'} #${order.order_id}</title>
            <style>
                @media print {
                    @page {
                        size: 80mm auto; /* Thermal receipt paper size */
                        margin: 2mm;
                    }
                    body { 
                        font-family: 'Courier New', monospace; 
                        font-size: 12px; 
                        margin: 0;
                        padding: 2mm;
                        width: 76mm;
                    }
                }
                body { 
                    font-family: 'Courier New', monospace; 
                    font-size: 12px; 
                    margin: 0;
                    padding: 5mm;
                    width: 70mm;
                }
                .invoice-header { text-align: center; margin-bottom: 3mm; border-bottom: 1px dashed #000; padding-bottom: 2mm; }
                .invoice-title { font-size: 14px; font-weight: bold; margin-bottom: 1mm; text-transform: uppercase; }
                .invoice-subtitle { font-size: 10px; color: #666; }
                .invoice-info { margin-bottom: 3mm; }
                .invoice-section-title { font-weight: bold; margin-bottom: 1mm; border-bottom: 1px dotted #000; padding-bottom: 1mm; font-size: 11px; text-transform: uppercase; }
                .invoice-row { display: flex; justify-content: space-between; margin-bottom: 1mm; }
                .invoice-table { width: 100%; border-collapse: collapse; margin: 2mm 0; font-size: 11px; }
                .invoice-table th { background: #f5f5f5; padding: 1mm; text-align: left; font-weight: bold; border-bottom: 1px dashed #000; }
                .invoice-table td { padding: 1mm; border-bottom: 1px dotted #eee; }
                .invoice-table .item-name { font-weight: bold; }
                .invoice-table .flavor-item { padding-left: 2mm; font-style: italic; color: #666; font-size: 10px; }
                .invoice-total { background: #f5f5f5; font-weight: bold; border-top: 2px solid #000; border-bottom: 2px solid #000; }
                .invoice-footer { text-align: center; margin-top: 3mm; padding-top: 2mm; border-top: 1px dashed #000; font-size: 10px; line-height: 1.2; }
                .thank-you { font-weight: bold; margin: 2mm 0; }
            </style>
        </head>
        <body>
            ${invoiceHTML}
            <script>
                window.onload = function() {
                    window.print();
                    setTimeout(function() {
                        window.close();
                    }, 500);
                };
           <\/script>
        </body>
        </html>
    `);

            printWindow.document.close();
        }
        // Toggle notification panel
        notificationHeader.addEventListener('click', () => {
            panelOpen = !panelOpen
            if (panelOpen) {
                notificationPanel.classList.add('open')
                unreadCount = 0
                notificationCount.textContent = '0'
                notificationCount.style.display = 'none'
                notificationIndicatorText.textContent = 'Click to collapse'

                // Mark all notifications as read
                document.querySelectorAll('.notification-item').forEach(item => {
                    item.classList.remove('new')
                })
            } else {
                notificationPanel.classList.remove('open')
                notificationIndicatorText.textContent = unreadCount > 0 ? `${unreadCount} new orders` : 'No new orders'
            }
        })

        document.addEventListener('click', function (e) {
            if (e.target && (e.target.id === 'preview-invoice-btn' ||
                e.target.id === 'download-invoice-btn' ||
                e.target.id === 'download-receipt-btn')) {

                if (!selectedOrder) return;

                if (e.target.id === 'preview-invoice-btn') {
                    showInvoicePreview(selectedOrder, 'invoice');
                } else if (e.target.id === 'download-invoice-btn') {
                    downloadInvoice(selectedOrder, 'invoice');
                } else if (e.target.id === 'download-receipt-btn') {
                    downloadInvoice(selectedOrder, 'receipt');
                }
            }
        });

        // Theme toggle
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode')
            themeToggle.innerHTML = document.body.classList.contains('dark-mode') ? '<span>â˜€ï¸</span>' : '<span>ðŸŒ™</span>'
            // Save theme preference to localStorage
            localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light')
        })

        // Check for saved theme preference
        if (localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-mode')
            themeToggle.innerHTML = '<span>â˜€ï¸</span>'
        }

        // Update the tab switching to include vouchers
        sidebarTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                sidebarTabs.forEach(t => t.classList.remove('active'))
                tab.classList.add('active')

                const tabName = tab.getAttribute('data-tab')
                if (tabName === 'orders') {
                    ordersTabContent.style.display = 'block'
                    cookiesTabContent.style.display = 'none'
                    vouchersTabContent.style.display = 'none'
                    shippingTabContent.style.display = 'none';

                    loadOrders();

                } else if (tabName === 'cookies') {
                    ordersTabContent.style.display = 'none'
                    cookiesTabContent.style.display = 'block'
                    vouchersTabContent.style.display = 'none'
                    shippingTabContent.style.display = 'none';

                    if (cookies.length === 0) {
                        loadCookies()
                    } else {
                        renderCookies()
                    }
                } else if (tabName === 'vouchers') {
                    ordersTabContent.style.display = 'none'
                    cookiesTabContent.style.display = 'none'
                    vouchersTabContent.style.display = 'block'
                    shippingTabContent.style.display = 'none';
                    if (vouchers.length === 0) {
                        loadVouchers()
                    } else {
                        renderVouchers()
                    }
                } else if (tabName === 'shipping') {
                    ordersTabContent.style.display = 'none';
                    cookiesTabContent.style.display = 'none';
                    vouchersTabContent.style.display = 'none';
                    shippingTabContent.style.display = 'block';


                    loadShippingData();
                }
            })
        })

        // Modal handlers
        closeModalBtn.addEventListener('click', () => {
            orderModal.style.display = 'none'
            // Reset status selection
            document.querySelectorAll('.status-option').forEach(opt => opt.classList.remove('selected'))
            selectedStatus = null
        })

        document.querySelector('.close-modal').addEventListener('click', () => {
            orderModal.style.display = 'none'
            // Reset status selection
            document.querySelectorAll('.status-option').forEach(opt => opt.classList.remove('selected'))
            selectedStatus = null
        })

        window.addEventListener('click', (e) => {
            if (e.target === orderModal) {
                orderModal.style.display = 'none'
                // Reset status selection
                document.querySelectorAll('.status-option').forEach(opt => opt.classList.remove('selected'))
                selectedStatus = null
            }
        })


        async function loadVouchers(loadMore = false) {
            const state = infiniteScrollState.vouchers;

            if (state.isLoading) return;

            try {
                state.isLoading = true;

                const vouchersTable = document.getElementById('vouchers-table');

                if (!loadMore) {
                    vouchersTable.innerHTML = `
                <tr>
                    <td colspan="11">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                        </div>
                    </td>
                </tr>
            `;
                    state.currentPage = 1;
                    state.allData = [];
                } else {
                    document.getElementById('vouchers-loading').style.display = 'flex';
                }

                const from = (state.currentPage - 1) * state.pageSize;
                const to = from + state.pageSize - 1;

                const { data, error, count } = await supabase
                    .from('vouchers')
                    .select('*', { count: 'exact' })
                    .order('created_at', { ascending: false })
                    .range(from, to);

                if (error) {
                    console.error('Error loading vouchers:', error);
                    showToast('Error loading vouchers');
                    return;
                }

                const totalLoaded = state.currentPage * state.pageSize;
                state.hasMore = totalLoaded < count;

                if (loadMore) {
                    state.allData = [...state.allData, ...data];
                } else {
                    state.allData = data;
                }

                state.currentPage++;

                vouchers = state.allData;
                updateVouchersStats();
                renderVouchers();

                document.getElementById('vouchers-loading').style.display = 'none';

                if (!state.hasMore && state.allData.length > 0) {
                    const existingEndMessage = document.getElementById('vouchers-end-message');
                    if (!existingEndMessage) {
                        const endMessage = document.createElement('div');
                        endMessage.id = 'vouchers-end-message';
                        endMessage.className = 'end-of-results';
                        endMessage.textContent = 'No more vouchers to load';
                        document.getElementById('vouchers-tab-content').appendChild(endMessage);
                    }
                }

            } catch (err) {
                console.error('Failed to load vouchers:', err);
                showToast('Failed to load vouchers');
            } finally {
                state.isLoading = false;
            }
        }

        // Update vouchers statistics
        function updateVouchersStats() {
            const totalVouchersEl = document.getElementById('total-vouchers')
            const activeVouchersEl = document.getElementById('active-vouchers')
            const freeShippingVouchersEl = document.getElementById('free-shipping-vouchers')
            const freeItemVouchersEl = document.getElementById('free-item-vouchers')

            totalVouchersEl.textContent = vouchers.length
            activeVouchersEl.textContent = vouchers.filter(v => v.is_active !== false).length // Count active vouchers
            freeShippingVouchersEl.textContent = vouchers.filter(v => v.free_shipping && v.is_active !== false).length
            freeItemVouchersEl.textContent = vouchers.filter(v => v.is_item && v.is_active !== false).length
        }

        // Filter vouchers
        function filterVouchers() {
            return vouchers.filter(voucher => {
                // Apply type filter
                if (currentVouchersFilter !== 'all') {
                    if (currentVouchersFilter === 'free_shipping' && !voucher.free_shipping) {
                        return false
                    }
                    if (currentVouchersFilter === 'free_item' && !voucher.is_item) {
                        return false
                    }
                    if (currentVouchersFilter === 'discount' && (!voucher.discount_rate && !voucher.discount_number)) {
                        return false
                    }
                }

                // Apply search filter
                if (vouchersSearchQuery) {
                    const searchTerm = vouchersSearchQuery.toLowerCase()
                    const searchableFields = [
                        voucher.id.toString(),
                        voucher.code.toLowerCase(),
                        voucher.discount_rate ? voucher.discount_rate.toString() : '',
                        voucher.discount_number ? voucher.discount_number.toString() : '',
                        voucher.items ? voucher.items.join(' ') : ''
                    ]

                    return searchableFields.some(field => field.includes(searchTerm))
                }

                return true
            })
        }

        // Update the renderVouchers function
        function renderVouchers() {
            const filteredVouchers = filterVouchers()
            const vouchersTable = document.getElementById('vouchers-table')

            if (filteredVouchers.length === 0) {
                vouchersTable.innerHTML = `
            <tr>
                <td colspan="11" style="text-align: center; padding: 2rem;">
                    No vouchers found matching your criteria
                </td>
            </tr>
        `
                return
            }

            vouchersTable.innerHTML = ''

            filteredVouchers.forEach(voucher => {
                const row = document.createElement('tr')

                // Format items for display
                let itemsDisplay = 'All items'
                if (voucher.items && voucher.items.length > 0) {
                    if (voucher.items.length <= 3) {
                        itemsDisplay = voucher.items.join(', ')
                    } else {
                        itemsDisplay = `${voucher.items.length} items`
                    }
                }

                // Status badge with toggle functionality
                const statusBadge = voucher.is_active ?
                    '<span class="status-badge status-available" title="Active - Click to deactivate">Active</span>' :
                    '<span class="status-badge status-out-of-stock" title="Inactive - Click to activate">Inactive</span>'

                row.innerHTML = `
            <td>${voucher.id}</td>
            <td><strong class="voucher-code">${voucher.code}</strong></td>
            <td>${voucher.free_shipping ? 'âœ… Yes' : 'âŒ No'}</td>
            <td>${voucher.is_item ? 'âœ… Yes' : 'âŒ No'}</td>
            <td>${voucher.discount_rate ? `${voucher.discount_rate}%` : '-'}</td>
            <td>${voucher.discount_number ? `EGP ${voucher.discount_number}` : '-'}</td>
            <td>${voucher.total ? 'âœ… Yes' : 'âŒ No'}</td>
            <td title="${voucher.items ? voucher.items.join(', ') : 'All items'}">${itemsDisplay}</td>
            <td class="status-cell">${statusBadge}</td>
            <td>${formatDateTime(voucher.created_at)}</td>
            <td>
                <button class="action-btn edit-btn" data-id="${voucher.id}">Edit</button>
                <button class="action-btn delete-btn" data-id="${voucher.id}">Delete</button>
            </td>
        `

                // Add click event to status badge for quick toggle
                const statusCell = row.querySelector('.status-cell')
                statusCell.addEventListener('click', (e) => {
                    e.stopPropagation()
                    toggleVoucherStatus(voucher.id, !voucher.is_active)
                })

                // Add event listeners to action buttons
                row.querySelector('.edit-btn').addEventListener('click', (e) => {
                    e.stopPropagation()
                    editVoucher(voucher.id)
                })

                row.querySelector('.delete-btn').addEventListener('click', (e) => {
                    e.stopPropagation()
                    deleteVoucher(voucher.id, voucher.code)
                })

                vouchersTable.appendChild(row)
            })
        }

        // Toggle voucher status
        async function toggleVoucherStatus(voucherId, newStatus) {
            try {
                const { error } = await supabase
                    .from('vouchers')
                    .update({ is_active: newStatus })
                    .eq('id', voucherId)

                if (error) {
                    console.error('Error toggling voucher status:', error)
                    showToast('Error updating voucher status')
                    return
                }

                // Update local data
                const voucherIndex = vouchers.findIndex(v => v.id === voucherId)
                if (voucherIndex !== -1) {
                    vouchers[voucherIndex].is_active = newStatus
                }

                showToast(`Voucher ${newStatus ? 'activated' : 'deactivated'} successfully`)
                renderVouchers()
                updateVouchersStats()

            } catch (err) {
                console.error('Failed to toggle voucher status:', err)
                showToast('Failed to update voucher status')
            }
        }

        // Enhanced show voucher modal function
        function showVoucherModal(voucher = null) {
            selectedVoucher = voucher
            const modal = document.getElementById('voucher-modal')
            const title = document.getElementById('voucher-modal-title')
            const form = document.getElementById('voucher-form')

            if (voucher) {
                title.textContent = `Edit Voucher: ${voucher.code}`
                // Populate form with existing data
                document.getElementById('voucher-code').value = voucher.code
                document.getElementById('voucher-free-shipping').checked = voucher.free_shipping
                document.getElementById('voucher-free-item').checked = voucher.is_item
                document.getElementById('voucher-total').checked = voucher.total
                document.getElementById('voucher-discount-rate').value = voucher.discount_rate || ''
                document.getElementById('voucher-discount-amount').value = voucher.discount_number || ''
                document.getElementById('voucher-description').value = voucher.description || ''
                document.getElementById('voucher-is-active').checked = voucher.is_active !== false // Default to true if null/undefined

                // Populate items dropdown with previously selected items
                const selectedItems = voucher.items || []
                populateItemsDropdown(selectedItems)

            } else {
                title.textContent = 'Add New Voucher'
                form.reset()
                // Default is_active to true for new vouchers
                document.getElementById('voucher-is-active').checked = true
                // Populate items dropdown with no pre-selected items
                populateItemsDropdown([])
            }

            // Show/hide relevant fields based on voucher type
            updateVoucherFormVisibility()

            // Set up readonly logic for discount fields
            setupDiscountFieldsReadonly()

            modal.style.display = 'flex'
        }

        // Setup readonly logic for discount fields
        function setupDiscountFieldsReadonly() {
            const discountRateInput = document.getElementById('voucher-discount-rate')
            const discountAmountInput = document.getElementById('voucher-discount-amount')

            // Clear any existing event listeners
            discountRateInput.replaceWith(discountRateInput.cloneNode(true))
            discountAmountInput.replaceWith(discountAmountInput.cloneNode(true))

            // Get fresh references
            const freshRateInput = document.getElementById('voucher-discount-rate')
            const freshAmountInput = document.getElementById('voucher-discount-amount')

            // Set initial readonly state based on current values
            updateDiscountFieldsReadonly()

            // Add event listeners for input changes
            freshRateInput.addEventListener('input', updateDiscountFieldsReadonly)
            freshAmountInput.addEventListener('input', updateDiscountFieldsReadonly)

            // Also update on paste events
            freshRateInput.addEventListener('paste', () => setTimeout(updateDiscountFieldsReadonly, 10))
            freshAmountInput.addEventListener('paste', () => setTimeout(updateDiscountFieldsReadonly, 10))

            // Update when fields become visible
            freshRateInput.addEventListener('focus', updateDiscountFieldsReadonly)
            freshAmountInput.addEventListener('focus', updateDiscountFieldsReadonly)
        }

        // Update readonly state of discount fields
        function updateDiscountFieldsReadonly() {
            const discountRateInput = document.getElementById('voucher-discount-rate')
            const discountAmountInput = document.getElementById('voucher-discount-amount')

            const hasRateValue = discountRateInput.value && discountRateInput.value.trim() !== '' && parseFloat(discountRateInput.value) > 0
            const hasAmountValue = discountAmountInput.value && discountAmountInput.value.trim() !== '' && parseFloat(discountAmountInput.value) > 0

            if (hasRateValue && hasAmountValue) {
                // If both have values, clear the one that wasn't just edited
                // We can't easily detect which one was just edited, so we'll clear the amount
                discountAmountInput.value = ''
                discountAmountInput.readOnly = true
                discountRateInput.readOnly = false
            } else if (hasRateValue) {
                // If rate has value, make amount readonly
                discountAmountInput.readOnly = true
                discountRateInput.readOnly = false
                discountAmountInput.placeholder = "Clear rate to enter amount"
            } else if (hasAmountValue) {
                // If amount has value, make rate readonly
                discountRateInput.readOnly = true
                discountAmountInput.readOnly = false
                discountRateInput.placeholder = "Clear amount to enter rate"
            } else {
                // If both are empty, make both editable
                discountRateInput.readOnly = false
                discountAmountInput.readOnly = false
                discountRateInput.placeholder = ""
                discountAmountInput.placeholder = ""
            }

            // Update visual styling based on readonly state
            updateDiscountFieldStyles()
        }

        // Update visual styling for discount fields
        function updateDiscountFieldStyles() {
            const discountRateInput = document.getElementById('voucher-discount-rate')
            const discountAmountInput = document.getElementById('voucher-discount-amount')

            if (discountRateInput.readOnly) {
                discountRateInput.style.backgroundColor = '#f5f5f5'
                discountRateInput.style.borderColor = '#ddd'
                discountRateInput.style.color = '#999'
                discountRateInput.style.cursor = 'not-allowed'
            } else {
                discountRateInput.style.backgroundColor = ''
                discountRateInput.style.borderColor = ''
                discountRateInput.style.color = ''
                discountRateInput.style.cursor = ''
            }

            if (discountAmountInput.readOnly) {
                discountAmountInput.style.backgroundColor = '#f5f5f5'
                discountAmountInput.style.borderColor = '#ddd'
                discountAmountInput.style.color = '#999'
                discountAmountInput.style.cursor = 'not-allowed'
            } else {
                discountAmountInput.style.backgroundColor = ''
                discountAmountInput.style.borderColor = ''
                discountAmountInput.style.color = ''
                discountAmountInput.style.cursor = ''
            }
        }


        // Enhanced update form field visibility
        function updateVoucherFormVisibility() {
            const freeShipping = document.getElementById('voucher-free-shipping').checked
            const freeItem = document.getElementById('voucher-free-item').checked
            const totalDiscount = document.getElementById('voucher-total').checked

            const discountRateGroup = document.getElementById('discount-rate-group')
            const discountAmountGroup = document.getElementById('discount-amount-group')
            const itemsGroup = document.getElementById('items-group')

            // Show discount fields only for free items or total discounts
            const showDiscountFields = freeItem || totalDiscount

            discountRateGroup.style.display = showDiscountFields ? 'block' : 'none'
            discountAmountGroup.style.display = showDiscountFields ? 'block' : 'none'
            itemsGroup.style.display = freeItem ? 'block' : 'none'

            // If discount fields are hidden, clear and enable them
            if (!showDiscountFields) {
                document.getElementById('voucher-discount-rate').value = ''
                document.getElementById('voucher-discount-amount').value = ''
                document.getElementById('voucher-discount-rate').readOnly = false
                document.getElementById('voucher-discount-amount').readOnly = false
                updateDiscountFieldStyles()
            } else {
                // If discount fields are shown, setup readonly logic
                setupDiscountFieldsReadonly()
            }

            // If items group is shown and dropdown is empty, populate it
            if (itemsGroup.style.display === 'block') {
                const itemsDropdown = document.getElementById('voucher-items')
                if (itemsDropdown.children.length <= 2) { // Only has loading/empty options
                    const selectedItems = selectedVoucher ? selectedVoucher.items || [] : []
                    populateItemsDropdown(selectedItems)
                }
            }
        }

        // Enhanced save voucher function
        async function saveVoucher() {
            try {
                const code = document.getElementById('voucher-code').value.trim()
                const freeShipping = document.getElementById('voucher-free-shipping').checked
                const isItem = document.getElementById('voucher-free-item').checked
                const total = document.getElementById('voucher-total').checked
                const discountRate = document.getElementById('voucher-discount-rate').value
                const discountNumber = document.getElementById('voucher-discount-amount').value
                const itemsDropdown = document.getElementById('voucher-items')
                const description = document.getElementById('voucher-description').value
                const isActive = document.getElementById('voucher-is-active').checked

                if (!code) {
                    showToast('Voucher code is required')
                    return
                }

                // Validate discount fields
                if ((isItem || total) && !discountRate && !discountNumber) {
                    showToast('Please enter either discount rate or discount amount for discount vouchers')
                    return
                }

                if (discountRate && discountNumber) {
                    showToast('Please enter only one: discount rate OR discount amount, not both')
                    return
                }

                // Get selected items from dropdown
                let selectedItems = []
                if (isItem && itemsDropdown) {
                    const selectedOptions = Array.from(itemsDropdown.selectedOptions)
                    selectedItems = selectedOptions
                        .map(option => option.value)
                        .filter(value => value && value !== 'all') // Exclude "all" option and empty values

                    // If "all" is selected or no items selected, set to null (apply to all items)
                    const hasAllSelected = selectedOptions.some(option => option.value === 'all')
                    if (hasAllSelected || selectedItems.length === 0) {
                        selectedItems = null
                    }
                }

                const voucherData = {
                    code: code.toUpperCase(),
                    free_shipping: freeShipping,
                    is_item: isItem,
                    total: total,
                    discount_rate: discountRate ? parseFloat(discountRate) : null,
                    discount_number: discountNumber ? parseFloat(discountNumber) : null,
                    items: selectedItems, // This will be an array or null
                    description: description || null,
                    is_active: isActive
                }

                let error
                if (selectedVoucher) {
                    // Update existing voucher
                    const { error: updateError } = await supabase
                        .from('vouchers')
                        .update(voucherData)
                        .eq('id', selectedVoucher.id)
                    error = updateError
                } else {
                    // Create new voucher
                    const { error: insertError } = await supabase
                        .from('vouchers')
                        .insert([voucherData])
                    error = insertError
                }

                if (error) {
                    console.error('Error saving voucher:', error)
                    showToast('Error saving voucher: ' + error.message)
                    return
                }

                showToast(`Voucher ${selectedVoucher ? 'updated' : 'created'} successfully`)
                document.getElementById('voucher-modal').style.display = 'none'

                // Reset readonly states
                const discountRateInput = document.getElementById('voucher-discount-rate')
                const discountAmountInput = document.getElementById('voucher-discount-amount')
                discountRateInput.readOnly = false
                discountAmountInput.readOnly = false
                updateDiscountFieldStyles()

                loadVouchers()

            } catch (err) {
                console.error('Failed to save voucher:', err)
                showToast('Failed to save voucher')
            }
        }

        // Edit voucher
        async function editVoucher(id) {
            const voucher = vouchers.find(v => v.id === id)
            if (voucher) {
                showVoucherModal(voucher)
            }
        }

        // Delete voucher
        async function deleteVoucher(id, code) {
            if (confirm(`Are you sure you want to delete voucher "${code}"? This action cannot be undone.`)) {
                try {
                    const { error } = await supabase
                        .from('vouchers')
                        .delete()
                        .eq('id', id)

                    if (error) {
                        console.error('Error deleting voucher:', error)
                        showToast('Error deleting voucher')
                        return
                    }

                    showToast('Voucher deleted successfully')
                    loadVouchers()

                } catch (err) {
                    console.error('Failed to delete voucher:', err)
                    showToast('Failed to delete voucher')
                }
            }
        }

        // Update status button handler - FIXED VERSION
        updateStatusBtn.addEventListener('click', async () => {
            if (!selectedOrder || !selectedStatus) {
                showToast('Please select a status')
                return
            }

            try {
                console.log("Updating order:", selectedOrder.order_id, "to status:", selectedStatus)

                // Update the order status in the database - FIXED: using selectedStatus instead of selectedOrder.status
                const { error } = await supabase
                    .from('orders')
                    .update({ status: selectedStatus }) // FIXED: Changed from selectedOrder.status to selectedStatus
                    .eq('order_id', selectedOrder.order_id)

                if (error) {
                    console.error('Error updating order status:', error)
                    showToast('Error updating status: ' + error.message)
                    return
                }


                // Update the order in the local array
                const orderIndex = orders.findIndex(o => o.id === selectedOrder.id)
                if (orderIndex !== -1) {
                    orders[orderIndex].status = selectedStatus // FIXED: Changed from selectedOrder.status to selectedStatus
                }

                // Update the UI
                renderOrders()
                updateStats()

                // Close the modal and show success message
                showToast(`Order #${selectedOrder.order_id} status updated to ${selectedStatus}`) // FIXED: Changed from selectedOrder.status to selectedStatus
                orderModal.style.display = 'none'

                // Reset status selection
                document.querySelectorAll('.status-option').forEach(opt => opt.classList.remove('selected'))
                selectedStatus = null

                // modalBody.remove();

            } catch (err) {
                console.error('Failed to update order status:', err)
                showToast('Failed to update status')
            }
        })

        // Quick actions
        refreshBtn.addEventListener('click', () => {
            if (ordersTabContent.style.display !== 'none') {
                loadOrders()
                showToast('Orders refreshed')
            } else {
                loadCookies()
                showToast('Items refreshed')
            }
        })

        exportBtn.addEventListener('click', () => {
            if (ordersTabContent.style.display !== 'none') {
                exportOrders()
            } else {
                exportCookies()
            }
        })

        // Stats elements
        const totalOrdersEl = document.getElementById('total-orders')
        const todayOrdersEl = document.getElementById('today-orders')
        const pendingOrdersEl = document.getElementById('pending-orders')
        const totalRevenueEl = document.getElementById('total-revenue')

        // Cookies stats elements
        const totalItemsEl = document.getElementById('total-items')
        const inStockEl = document.getElementById('in-stock')
        const lowStockEl = document.getElementById('low-stock')
        const outOfStockEl = document.getElementById('out-of-stock')

        // Stats cards
        const totalOrdersCard = document.getElementById('total-orders-card')
        const todayOrdersCard = document.getElementById('today-orders-card')
        const pendingOrdersCard = document.getElementById('pending-orders-card')
        const revenueCard = document.getElementById('revenue-card')

        // Add click handlers to stats cards
        totalOrdersCard.addEventListener('click', () => {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'))
            document.querySelector('.filter-btn[data-filter="all"]').classList.add('active')
            currentFilter = 'all'
            renderOrders()
        })

        todayOrdersCard.addEventListener('click', () => {
            // Filter to show only today's orders
            const today = new Date().toISOString().split('T')[0]
            const todayOrders = orders.filter(order => {
                const orderDate = new Date(order.created_at).toISOString().split('T')[0]
                return orderDate === today
            })
            renderFilteredOrders(todayOrders, "Today's Orders")
        })

        pendingOrdersCard.addEventListener('click', () => {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'))
            document.querySelector('.filter-btn[data-filter="Pending"]').classList.add('active')
            currentFilter = 'Pending'
            renderOrders()
        })

        revenueCard.addEventListener('click', () => {
            // Sort by highest value orders
            const sortedByRevenue = [...orders].sort((a, b) => b.total - a.total)
            renderFilteredOrders(sortedByRevenue, "Sorted by Revenue (High to Low)")
        })

        // Request permission for browser notifications
        if (Notification.permission !== 'granted') {
            Notification.requestPermission()
        }

        function showToast(message) {
            toast.textContent = message
            toast.style.display = 'inline'
            setTimeout(() => toast.style.display = 'none', 4000)
        }

        function playSound() {
            sound.currentTime = 0
            sound.play().catch(e => console.log("Audio play failed:", e))
        }

        function showBrowserNotification(message) {
            if (Notification.permission === 'granted') {
                new Notification('New Order', { body: message })
            }
        }

        // Add a new notification
        function addNotification(order) {
            const notification = {
                id: order.order_id,
                title: `Order #${order.order_id}`,
                customer: order.customer_name,
                total: order.total,
                items: order.items ? JSON.parse(order.items).length : 0,
                time: new Date().toLocaleTimeString(),
                isNew: true
            }

            notifications.unshift(notification)

            // Keep only the latest 10 notifications
            if (notifications.length > 10) {
                notifications.pop()
            }

            // Update notification UI
            renderNotifications()

            // Update badge count
            unreadCount++
            notificationCount.textContent = unreadCount
            notificationCount.style.display = 'flex'
            notificationIndicatorText.textContent = `${unreadCount} new order${unreadCount !== 1 ? 's' : ''}`

            // Auto-open panel if it's the first notification
            if (unreadCount === 1 && !panelOpen) {
                notificationPanel.classList.add('open')
                panelOpen = true
            }
        }

        // Render notifications in the panel
        function renderNotifications() {
            if (notifications.length === 0) {
                notificationList.innerHTML = `
                    <div class="notification-item" style="text-align: center; color: #999;">
                        No orders yet
                    </div>
                `
                return
            }

            notificationList.innerHTML = ''

            notifications.forEach(notification => {
                const notificationItem = document.createElement('div')
                notificationItem.className = `notification-item ${notification.isNew ? 'new' : ''}`
                notificationItem.innerHTML = `
                    <div class="notification-info">
                        <div class="notification-title">${notification.title}</div>
                        <div class="notification-details">
                            <span class="notification-detail">
                                <span>ðŸ‘¤</span> ${notification.customer}
                            </span>
                            <span class="notification-detail">
                                <span>ðŸ’°</span> EGP ${notification.total}
                            </span>
                            <span class="notification-detail">
                                <span>ðŸ“¦</span> ${notification.items} item${notification.items !== 1 ? 's' : ''}
                            </span>
                        </div>
                    </div>
                    <div class="notification-time">${notification.time}</div>
                    <div class="notification-actions">
                        <button class="view-order" data-id="${notification.id}">View</button>
                        <button class="dismiss">Dismiss</button>
                    </div>
                `
                notificationList.appendChild(notificationItem)
            })

            // Add event listeners to notification buttons
            document.querySelectorAll('.notification-item .view-order').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation()
                    const orderId = btn.getAttribute('data-id')
                    const order = orders.find(o => o.id == orderId)
                    if (order) {
                        showOrderDetails(order)
                    }
                })
            })

            document.querySelectorAll('.notification-item .dismiss').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation()
                    const notificationItem = btn.closest('.notification-item')
                    notificationItem.style.opacity = '0'
                    setTimeout(() => {
                        notificationItem.remove()
                        if (notificationList.children.length === 0) {
                            notificationList.innerHTML = `
                                <div class="notification-item" style="text-align: center; color: #999;">
                                    No notifications
                                </div>
                            `
                        }
                    }, 300)
                })
            })

            // Make entire notification item clickable
            document.querySelectorAll('.notification-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    if (!e.target.closest('.notification-actions')) {
                        const orderId = item.querySelector('.view-order')?.getAttribute('data-id')
                        if (orderId) {
                            const order = orders.find(o => o.id == orderId)
                            if (order) {
                                showOrderDetails(order)
                            }
                        }
                    }
                })
            })
        }

        function updateStats() {
            // Update total orders
            totalOrdersEl.textContent = orders.length

            // Update today's orders
            const todayOrders = orders.filter(order => {
                const orderDate = new Date(order.created_at).toISOString().split('T')[0]
                return orderDate === today
            })
            todayOrdersEl.textContent = todayOrders.length

            // Update pending orders
            const pendingOrders = orders.filter(order => order.status === 'Pending')
            pendingOrdersEl.textContent = pendingOrders.length

            // Update total revenue
            const revenue = orders.reduce((sum, order) => sum + order.total, 0)
            totalRevenueEl.textContent = `EGP ${revenue.toLocaleString()}`
        }

        // Update the updateCookiesStats function to handle the new data structure
        function updateCookiesStats() {
            // Update total items
            totalItemsEl.textContent = cookies.length

            // For cookies, we don't have stock information, so adjust these stats
            const cookiesCount = cookies.filter(item => item.type === 'cookie').length
            const boxesCount = cookies.filter(item => item.type === 'box').length

            // Since cookies don't have stock, we'll show counts by type instead
            inStockEl.textContent = cookiesCount
            lowStockEl.textContent = boxesCount
            outOfStockEl.textContent = 'N/A' // Not applicable for cookies without stock
        }

        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('en-EG', {
                timeZone: "Africa/Cairo",
                hour: '2-digit',
                minute: '2-digit',
                year: 'numeric',
                month: 'short',
                day: '2-digit'
            });
        }

        // Get status badge class
        function getStatusClass(status) {
            if (!status) return 'status-pending'; // fallback if null or undefined

            switch (status.toLowerCase()) {
                case 'pending': return 'status-pending';
                case 'confirmed': return 'status-confirmed';
                case 'preparing': return 'status-preparing';
                case 'delivering': return 'status-delivering';
                case 'completed': return 'status-completed';
                case 'cancelled': return 'status-cancelled';
                case 'failed': return 'status-failed';
                default: return 'status-pending';
            }
        }

        // Fetch all items from cookies, boxes, and mystery_boxes tables
        async function fetchAllItems() {
            try {
                console.log('Starting to fetch items from Supabase...')

                // Fetch cookies
                const { data: cookiesData, error: cookiesError } = await supabase
                    .from('cookies')
                    .select('slug, name')
                    .eq('is_active', true)

                if (cookiesError) {
                    console.error('Error fetching cookies:', cookiesError)
                    throw cookiesError
                }
                console.log('Cookies fetched:', cookiesData)

                // Fetch boxes
                const { data: boxesData, error: boxesError } = await supabase
                    .from('boxes')
                    .select('slug, name')
                    .eq('is_active', true)

                if (boxesError) {
                    console.error('Error fetching boxes:', boxesError)
                    throw boxesError
                }
                console.log('Boxes fetched:', boxesData)

                // Fetch mystery_boxes
                let mysteryBoxesData = []
                try {
                    const { data: mysteryData, error: mysteryError } = await supabase
                        .from('mystery_boxes')
                        .select('slug, name')
                        .eq('is_active', true)

                    if (mysteryError) {
                        console.log('Mystery boxes error (table might not exist):', mysteryError)
                    } else {
                        mysteryBoxesData = mysteryData || []
                        console.log('Mystery boxes fetched:', mysteryBoxesData)
                    }
                } catch (e) {
                    console.log('Mystery boxes table not found:', e)
                }

                // Combine all items with correct structure
                const allItems = [
                    ...(cookiesData || []).map(item => ({
                        slug: item.slug,
                        name: item.name,
                        displayName: `${item.name} (Cookie)`,
                        table: 'cookies'
                    })),
                    ...(boxesData || []).map(item => ({
                        slug: item.slug,
                        name: item.name,
                        displayName: `${item.name} (Box)`,
                        table: 'boxes'
                    })),
                    ...(mysteryBoxesData || []).map(item => ({
                        slug: item.slug,
                        name: item.name,
                        displayName: `${item.name} (Mystery Box)`,
                        table: 'mystery_boxes'
                    }))
                ]

                console.log('Combined items:', allItems)
                return allItems

            } catch (error) {
                console.error('Error fetching items:', error)
                showToast('Error loading items from database')
                return []
            }
        }

        function addDiscountSectionToEditModal(modal, item, type, variant = null) {
            const form = modal.querySelector('#edit-item-form');

            // Create discount section HTML
            const discountHTML = createDiscountHTML(item, type, variant);

            // Find where to insert the discount section (before the description field)
            const descriptionGroup = form.querySelector('#edit-description').closest('.form-group');
            if (descriptionGroup) {
                descriptionGroup.insertAdjacentHTML('beforebegin', discountHTML);
            } else {
                // Fallback: insert at the end of the form
                form.insertAdjacentHTML('beforeend', discountHTML);
            }

            // Setup discount event listeners
            setupDiscountEventListeners(modal, item, type, variant);
        }

        // Create discount HTML based on item type and variant
        function createDiscountHTML(item, type, variant = null) {
            if (type === 'cookie') {
                if (variant) {
                    // Single variant editing
                    return createCookieVariantDiscountHTML(item, variant);
                } else {
                    // Full cookie editing (both variants)
                    return createFullCookieDiscountHTML(item);
                }
            } else {
                // Box editing
                return createBoxDiscountHTML(item);
            }
        }

        // Create discount HTML for a single cookie variant
        function createCookieVariantDiscountHTML(item, variant) {
            const priceField = variant === 'chewy' ? 'chewy_price' : 'crumble_price';
            const discountRateField = `${variant}_discount_rate`;
            const discountAmountField = `${variant}_discount_amount`;
            const discountActiveField = `${variant}_discount_active`;

            const originalPrice = item[priceField] || 0;
            const discountRate = item[discountRateField] || 0;
            const discountAmount = item[discountAmountField] || 0;
            const isActive = item[discountActiveField] || false;

            const finalPrice = calculateFinalPrice(originalPrice, discountRate, discountAmount);

            return `
        <div class="discount-section">
            <div class="discount-section-title">
                <span>ðŸ’°</span> Discount Settings - ${variant.charAt(0).toUpperCase() + variant.slice(1)}
            </div>
            
            <div class="discount-variant">
                <div class="discount-variant-title">
                    <span>ðŸª</span> ${variant.charAt(0).toUpperCase() + variant.slice(1)} Variant
                </div>
                
                <div class="price-display">
                    <span class="original-price">Original: EGP ${originalPrice}</span>
                    ${isActive ? `<span class="final-price">Sale: EGP ${finalPrice}</span>` : ''}
                </div>
                
                ${isActive && (discountRate > 0 || discountAmount > 0) ? `
                    <div class="discount-preview">
                        <div class="discount-preview-item">
                            <span class="discount-preview-label">Discount:</span>
                            <span class="discount-preview-value discount-amount">
                                ${discountRate > 0 ? `${discountRate}%` : `EGP ${discountAmount}`}
                            </span>
                        </div>
                        <div class="discount-preview-item">
                            <span class="discount-preview-label">You Save:</span>
                            <span class="discount-preview-value discount-amount">
                                EGP ${(originalPrice - finalPrice).toFixed(2)}
                            </span>
                        </div>
                    </div>
                ` : ''}
                
                <div class="discount-controls">
                    <select class="discount-type-select" id="edit-${variant}-discount-type">
                        <option value="rate" ${discountRate > 0 ? 'selected' : ''}>Percentage %</option>
                        <option value="amount" ${discountAmount > 0 ? 'selected' : ''}>Fixed Amount</option>
                    </select>
                    
                    <input type="number" 
                           class="discount-input" 
                           id="edit-${variant}-discount-value" 
                           placeholder="${discountRate > 0 ? discountRate : discountAmount}"
                           value="${discountRate > 0 ? discountRate : discountAmount}"
                           min="0" 
                           ${discountRate > 0 ? 'max="100"' : ''}>
                    
                    <button type="button" 
                            class="discount-toggle ${isActive ? 'active' : ''}" 
                            id="edit-${variant}-discount-toggle">
                        ${isActive ? 'âœ… Active' : 'âŒ Inactive'}
                    </button>
                </div>
                
                <small style="color: var(--gray); margin-top: 0.5rem; display: block;">
                    ${discountRate > 0 ?
                    'Percentage discount will be applied to the original price' :
                    'Fixed amount will be subtracted from the original price'}
                </small>
            </div>
        </div>
    `;
        }

        // Create discount HTML for full cookie editing (both variants)
        function createFullCookieDiscountHTML(item) {
            const chewyPrice = item.chewy_price || 0;
            const crumblePrice = item.crumble_price || 0;

            return `
        <div class="discount-section">
            <div class="discount-section-title">
                <span>ðŸ’°</span> Discount Settings
            </div>
            
            ${item.chewy_price ? `
                <div class="discount-variant">
                    <div class="discount-variant-title">
                        <span>ðŸª</span> Chewy Variant
                    </div>
                    ${createVariantDiscountControls(item, 'chewy', chewyPrice)}
                </div>
            ` : ''}
            
            ${item.crumble_price ? `
                <div class="discount-variant">
                    <div class="discount-variant-title">
                        <span>ðŸª</span> Crumble Variant
                    </div>
                    ${createVariantDiscountControls(item, 'crumble', crumblePrice)}
                </div>
            ` : ''}
        </div>
    `;
        }

        // Create discount HTML for boxes
        function createBoxDiscountHTML(item) {
            return `
        <div class="discount-section">
            <div class="discount-section-title">
                <span>ðŸ’°</span> Discount Settings
            </div>
            
            ${item.chewy_price ? `
                <div class="discount-variant">
                    <div class="discount-variant-title">
                        <span>ðŸ“¦</span> Chewy Box
                    </div>
                    ${createVariantDiscountControls(item, 'chewy', item.chewy_price)}
                </div>
            ` : ''}
            
            ${item.crumble_price ? `
                <div class="discount-variant">
                    <div class="discount-variant-title">
                        <span>ðŸ“¦</span> Crumble Box
                    </div>
                    ${createVariantDiscountControls(item, 'crumble', item.crumble_price)}
                </div>
            ` : ''}
            
            ${item.mix_price ? `
                <div class="discount-variant">
                    <div class="discount-variant-title">
                        <span>ðŸ“¦</span> Mix Box
                    </div>
                    ${createVariantDiscountControls(item, 'mix', item.mix_price)}
                </div>
            ` : ''}
        </div>
    `;
        }

        // Create discount controls for a variant
        function createVariantDiscountControls(item, variant, originalPrice) {
            const discountRateField = `${variant}_discount_rate`;
            const discountAmountField = `${variant}_discount_amount`;
            const discountActiveField = `${variant}_discount_active`;

            const discountRate = item[discountRateField] || 0;
            const discountAmount = item[discountAmountField] || 0;
            const isActive = item[discountActiveField] || false;

            const finalPrice = calculateFinalPrice(originalPrice, discountRate, discountAmount);

            return `
        <div class="price-display">
            <span class="original-price">Original: EGP ${originalPrice}</span>
            ${isActive ? `<span class="final-price">Sale: EGP ${finalPrice}</span>` : ''}
        </div>
        
        ${isActive && (discountRate > 0 || discountAmount > 0) ? `
            <div class="discount-preview">
                <div class="discount-preview-item">
                    <span class="discount-preview-label">Discount:</span>
                    <span class="discount-preview-value discount-amount">
                        ${discountRate > 0 ? `${discountRate}%` : `EGP ${discountAmount}`}
                    </span>
                </div>
                <div class="discount-preview-item">
                    <span class="discount-preview-label">You Save:</span>
                    <span class="discount-preview-value discount-amount">
                        EGP ${(originalPrice - finalPrice).toFixed(2)}
                    </span>
                </div>
            </div>
        ` : ''}
        
        <div class="discount-controls">
            <select class="discount-type-select" id="edit-${variant}-discount-type">
                <option value="rate" ${discountRate > 0 ? 'selected' : ''}>Percentage %</option>
                <option value="amount" ${discountAmount > 0 ? 'selected' : ''}>Fixed Amount</option>
            </select>
            
            <input type="number" 
                   class="discount-input" 
                   id="edit-${variant}-discount-value" 
                   placeholder="${discountRate > 0 ? discountRate : discountAmount}"
                   value="${discountRate > 0 ? discountRate : discountAmount}"
                   min="0" 
                   ${discountRate > 0 ? 'max="100"' : ''}>
            
            <button type="button" 
                    class="disciscount-toggle ${isActive ? 'active' : ''}" 
                    id="edit-${variant}-discount-toggle">
                ${isActive ? 'âœ… Active' : 'âŒ Inactive'}
            </button>
        </div>
        
        <small style="color: var(--gray); margin-top: 0.5rem; display: block;">
            ${discountRate > 0 ?
                    'Percentage discount will be applied to the original price' :
                    'Fixed amount will be subtracted from the original price'}
        </small>
    `;
        }

        // Calculate final price after discount
        function calculateFinalPrice(originalPrice, discountRate, discountAmount) {
            let finalPrice = originalPrice;

            if (discountRate > 0) {
                finalPrice = originalPrice * (1 - discountRate / 100);
            } else if (discountAmount > 0) {
                finalPrice = Math.max(0, originalPrice - discountAmount);
            }

            return finalPrice.toFixed(2);
        }

        // Setup discount event listeners
        function setupDiscountEventListeners(modal, item, type, variant = null) {
            if (type === 'cookie' && variant) {
                // Single variant discount controls
                setupVariantDiscountListeners(modal, variant);
            } else if (type === 'cookie') {
                // Both variants for cookies
                if (item.chewy_price) setupVariantDiscountListeners(modal, 'chewy');
                if (item.crumble_price) setupVariantDiscountListeners(modal, 'crumble');
            } else {
                // Box variants
                if (item.chewy_price) setupVariantDiscountListeners(modal, 'chewy');
                if (item.crumble_price) setupVariantDiscountListeners(modal, 'crumble');
                if (item.mix_price) setupVariantDiscountListeners(modal, 'mix');
            }
        }

        // Setup discount listeners for a specific variant
        function setupVariantDiscountListeners(modal, variant) {
            const typeSelect = modal.querySelector(`#edit-${variant}-discount-type`);
            const valueInput = modal.querySelector(`#edit-${variant}-discount-value`);
            const toggleBtn = modal.querySelector(`#edit-${variant}-discount-toggle`);

            if (!typeSelect || !valueInput || !toggleBtn) return;

            // Toggle discount active state
            toggleBtn.addEventListener('click', () => {
                const isActive = toggleBtn.classList.contains('active');
                toggleBtn.classList.toggle('active');
                toggleBtn.textContent = isActive ? 'âŒ Inactive' : 'âœ… Active';
                updateDiscountPreview(modal, variant);
            });

            // Update max value for percentage discount
            typeSelect.addEventListener('change', () => {
                if (typeSelect.value === 'rate') {
                    valueInput.max = 100;
                    valueInput.placeholder = '0-100';
                } else {
                    valueInput.removeAttribute('max');
                    valueInput.placeholder = 'Amount';
                }
                updateDiscountPreview(modal, variant);
            });

            // Update preview when value changes
            valueInput.addEventListener('input', () => {
                updateDiscountPreview(modal, variant);
            });
        }

        // Update discount preview
        function updateDiscountPreview(modal, variant) {
            const typeSelect = modal.querySelector(`#edit-${variant}-discount-type`);
            const valueInput = modal.querySelector(`#edit-${variant}-discount-value`);
            const toggleBtn = modal.querySelector(`#edit-${variant}-discount-toggle`);
            const priceDisplay = modal.querySelector(`.discount-variant:has(#edit-${variant}-discount-type) .price-display`);

            if (!typeSelect || !valueInput || !toggleBtn || !priceDisplay) return;

            // Get original price (you might need to adjust this based on your form structure)
            const priceInput = modal.querySelector(variant === 'chewy' ? '#edit-chewy-price' :
                variant === 'crumble' ? '#edit-crumble-price' :
                    variant === 'mix' ? '#edit-mix-price' : null);

            if (!priceInput) return;

            const originalPrice = parseFloat(priceInput.value) || 0;
            const discountValue = parseFloat(valueInput.value) || 0;
            const isActive = toggleBtn.classList.contains('active');

            let finalPrice = originalPrice;

            if (isActive && discountValue > 0) {
                if (typeSelect.value === 'rate') {
                    finalPrice = originalPrice * (1 - Math.min(discountValue, 100) / 100);
                } else {
                    finalPrice = Math.max(0, originalPrice - discountValue);
                }
            }

            // Update price display
            const originalPriceSpan = priceDisplay.querySelector('.original-price');
            const finalPriceSpan = priceDisplay.querySelector('.final-price');

            if (originalPriceSpan) {
                originalPriceSpan.textContent = `Original: EGP ${originalPrice}`;
            }

            if (finalPriceSpan) {
                if (isActive && discountValue > 0) {
                    finalPriceSpan.textContent = `Sale: EGP ${finalPrice.toFixed(2)}`;
                    finalPriceSpan.style.display = 'inline';
                } else {
                    finalPriceSpan.style.display = 'none';
                }
            }
        }


        // Populate items dropdown
        async function populateItemsDropdown(selectedItems = []) {
            const itemsDropdown = document.getElementById('voucher-items')

            // Show loading state
            itemsDropdown.innerHTML = '<option value="" disabled class="loading-dropdown">Loading items...</option>'
            itemsDropdown.disabled = true

            try {
                const items = await fetchAllItems()

                // Clear dropdown
                itemsDropdown.innerHTML = ''

                if (items.length === 0) {
                    itemsDropdown.innerHTML = '<option value="" disabled>No items found</option>'
                    return
                }

                // Add "All Items" option
                const allOption = document.createElement('option')
                allOption.value = 'all'
                allOption.textContent = 'ðŸŽ All Items'
                allOption.title = 'Apply to all items'
                itemsDropdown.appendChild(allOption)

                // Add separator
                const separator = document.createElement('option')
                separator.disabled = true
                separator.textContent = 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€'
                itemsDropdown.appendChild(separator)

                // Group items by type
                const groupedItems = {
                    cookies: items.filter(item => item.table === 'cookies'),
                    boxes: items.filter(item => item.table === 'boxes'),
                    mystery_boxes: items.filter(item => item.table === 'mystery_boxes')
                }

                // Add cookies
                if (groupedItems.cookies.length > 0) {
                    const cookieHeader = document.createElement('option')
                    cookieHeader.disabled = true
                    cookieHeader.textContent = 'ðŸª COOKIES'
                    itemsDropdown.appendChild(cookieHeader)

                    groupedItems.cookies.forEach(item => {
                        const option = document.createElement('option')
                        option.value = item.slug
                        option.textContent = `   ${item.name}`
                        option.title = `Cookie: ${item.name}`

                        // Set selected if this item was previously selected
                        if (selectedItems.includes(item.slug)) {
                            option.selected = true
                        }

                        itemsDropdown.appendChild(option)
                    })
                }

                // Add boxes
                if (groupedItems.boxes.length > 0) {
                    const boxHeader = document.createElement('option')
                    boxHeader.disabled = true
                    boxHeader.textContent = 'ðŸ“¦ BOXES'
                    itemsDropdown.appendChild(boxHeader)

                    groupedItems.boxes.forEach(item => {
                        const option = document.createElement('option')
                        option.value = item.slug
                        option.textContent = `   ${item.name}`
                        option.title = `Box: ${item.name}`

                        if (selectedItems.includes(item.slug)) {
                            option.selected = true
                        }

                        itemsDropdown.appendChild(option)
                    })
                }

                // Add mystery boxes
                if (groupedItems.mystery_boxes.length > 0) {
                    const mysteryHeader = document.createElement('option')
                    mysteryHeader.disabled = true
                    mysteryHeader.textContent = 'ðŸŽ MYSTERY BOXES'
                    itemsDropdown.appendChild(mysteryHeader)

                    groupedItems.mystery_boxes.forEach(item => {
                        const option = document.createElement('option')
                        option.value = item.slug
                        option.textContent = `   ${item.name}`
                        option.title = `Mystery Box: ${item.name}`

                        if (selectedItems.includes(item.slug)) {
                            option.selected = true
                        }

                        itemsDropdown.appendChild(option)
                    })
                }

                // Enable dropdown
                itemsDropdown.disabled = false

            } catch (error) {
                console.error('Error populating items dropdown:', error)
                itemsDropdown.innerHTML = '<option value="" disabled>Error loading items</option>'
            }
        }

        // Get stock status class for cookies/boxes
        function getStockStatusClass(stock) {
            if (stock === 0) return 'status-out-of-stock';
            if (stock <= 10) return 'status-low-stock';
            return 'status-available';
        }

        // Get stock status text for cookies/boxes
        function getStockStatusText(stock) {
            if (stock === 0) return 'Out of Stock';
            if (stock <= 10) return 'Low Stock';
            return 'Available';
        }

        // Function to reset modal scroll position
        function resetModalScroll() {
            const modalBody = document.getElementById('modal-body');
            if (modalBody) {
                modalBody.scrollTop = 0;
            }
        }

        // Enhanced showOrderDetails function with voucher and financial details
        function showOrderDetails(order) {
            // Reset scroll to top immediately after content is set
            resetModalScroll();
            setTimeout(resetModalScroll, 10);

            selectedOrder = order;
            console.log("Order details:", order);
            const items = order.items ? JSON.parse(order.items) : [];

            // Create status progress bar
            const statusSteps = ['Pending', 'confirmed', 'preparing', 'delivering', 'completed'];
            const currentStatusIndex = statusSteps.indexOf(order.status.toLowerCase());
            const isFinalStatus = order.status.toLowerCase() === 'cancel' || order.status.toLowerCase() === 'failed';

            let progressHTML = `
        <div class="status-section">
            <div class="section-title">ðŸ“Š Order Progress</div>
            <div class="status-progress-container">
                <div class="status-progress-line">
                    <div class="status-progress-fill" style="width: ${(currentStatusIndex / (statusSteps.length - 1)) * 100}%"></div>
                </div>
                <div class="status-progress">
    `;

            statusSteps.forEach((step, index) => {
                let statusClass = '';
                if (index < currentStatusIndex) statusClass = 'completed';
                else if (index === currentStatusIndex) statusClass = 'active';

                progressHTML += `<div class="status-step ${statusClass}">${index + 1}</div>`;
            });

            progressHTML += `
                </div>
                <div class="status-labels">
                    <div class="status-label ${0 === currentStatusIndex ? 'active' : ''}">Pending</div>
                    <div class="status-label ${1 === currentStatusIndex ? 'active' : ''}">Confirmed</div>
                    <div class="status-label ${2 === currentStatusIndex ? 'active' : ''}">Preparing</div>
                    <div class="status-label ${3 === currentStatusIndex ? 'active' : ''}">Delivering</div>
                    <div class="status-label ${4 === currentStatusIndex ? 'active' : ''}">Completed</div>
                </div>
            </div>
        </div>
    `;

            // Customer and order info
            let customerInfoHTML = `
        <div class="modal-section">
            <div class="section-title">ðŸ‘¤ Customer Information</div>
            <div class="order-info-grid">
                <div class="info-item">
                    <div class="info-label"><span>ðŸ†”</span> Order ID</div>
                    <div class="info-value">#${order.order_id}</div>
                </div>
                <div class="info-item">
                    <div class="info-label"><span>ðŸ‘¤</span> Customer Name</div>
                    <div class="info-value">${order.customer_name}</div>
                </div>
                <div class="info-item">
                    <div class="info-label"><span>ðŸ“ž</span> Phone</div>
                    <div class="info-value">${order.phone}</div>
                </div>
                <div class="info-item">
                    <div class="info-label"><span>ðŸ“§</span> Email</div>
                    <div class="info-value">${order.email || 'N/A'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label"><span>ðŸ’³</span> Payment Method</div>
                    <div class="info-value">${order.payment_method}</div>
                </div>
                <div class="info-item">
                    <div class="info-label"><span>ðŸ•’</span> Order Time</div>
                    <div class="info-value">${formatDateTime(order.created_at)}</div>
                </div>
            </div>
        </div>
    `;

            // Financial Breakdown Section
            const subtotal = order.subtotal || items.reduce((sum, item) => sum + ((item.amount_cents || item.price * 100) / 100 * item.quantity), 0);
            const discount = order.discount || 0;
            const shippingCost = order.shipping_cost || 0;
            const freeShipping = order.free_shipping || false;
            const total = order.total || subtotal - discount + shippingCost;

            let financialInfoHTML = `
        <div class="modal-section">
            <div class="section-title">ðŸ’° Financial Breakdown</div>
            <div class="order-info-grid">
                <div class="info-item">
                    <div class="info-label"><span>ðŸ“¦</span> Subtotal</div>
                    <div class="info-value">EGP ${subtotal.toFixed(2)}</div>
                </div>
                <div class="info-item">
                    <div class="info-label"><span>ðŸšš</span> Shipping</div>
                    <div class="info-value">${freeShipping || shippingCost === 0 ? 'FREE' : `EGP ${shippingCost.toFixed(2)}`}</div>
                </div>
    `;

            // Add discount if applicable
            if (discount > 0) {
                financialInfoHTML += `
                <div class="info-item">
                    <div class="info-label"><span>ðŸŽ«</span> Discount</div>
                    <div class="info-value" style="color: var(--success);">-EGP ${discount.toFixed(2)}</div>
                </div>
        `;
            }

            financialInfoHTML += `
                <div class="info-item">
                    <div class="info-label"><span>ðŸ’°</span> Total Amount</div>
                    <div class="info-value highlight-value">EGP ${total.toFixed(2)}</div>
                </div>
            </div>
        </div>
    `;

            // Voucher Information Section (if voucher was used)
            let voucherInfoHTML = '';
            if (order.voucher_code || order.voucher_id) {
                voucherInfoHTML = `
            <div class="modal-section">
                <div class="section-title">ðŸŽ« Voucher Information</div>
                <div class="order-info-grid">
                    <div class="info-item">
                        <div class="info-label"><span>ðŸ·ï¸</span> Voucher Code</div>
                        <div class="info-value voucher-code">${order.voucher_code || 'N/A'}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label"><span>ðŸ†”</span> Voucher ID</div>
                        <div class="info-value">${order.voucher_id || 'N/A'}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label"><span>ðŸ“Š</span> Discount Applied</div>
                        <div class="info-value" style="color: var(--success);">EGP ${discount.toFixed(2)}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label"><span>ðŸšš</span> Free Shipping</div>
                        <div class="info-value">${freeShipping ? 'âœ… Yes' : 'âŒ No'}</div>
                    </div>
                </div>
            </div>
        `;
            }

            // Delivery information
            let deliveryInfoHTML = `
        <div class="modal-section">
            <div class="section-title">ðŸšš Delivery Information</div>
            <div class="info-item">
                <div class="info-label"><span>ðŸ </span> Delivery Address</div>
                <div class="info-value">${order.address || 'N/A'}</div>
            </div>
            <div class="info-item">
                <div class="info-label"><span>ðŸ“</span> Special Instructions</div>
                <div class="info-value">${order.special_instructions || 'None'}</div>
            </div>
        </div>
    `;

            // Order items
            let itemsHTML = `
        <div class="modal-section">
            <div class="section-title">ðŸ“¦ Order Items (${items.length})</div>
            <div class="items-container">
    `;

            if (items.length === 0) {
                itemsHTML += `<div class="info-value" style="text-align: center; padding: 1rem;">No items in this order</div>`;
            } else {
                items.forEach(item => {
                    const itemPrice = item.amount_cents ? item.amount_cents / 100 : item.price || 0;
                    const itemTotal = itemPrice * item.quantity;

                    itemsHTML += `
                <div class="item-card">
                    <div class="item-header">
                        <div class="item-name">${item.name}</div>
                        <div class="item-quantity">x${item.quantity}</div>
                    </div>
                    <div class="item-details">
                        <div class="item-price">EGP ${itemTotal.toFixed(2)}</div>
                    </div>
            `;

                    // Add flavors if they exist
                    if (item.flavors && item.flavors.length > 0) {
                        itemsHTML += `<div class="flavor-list">`;
                        item.flavors.forEach(flavor => {
                            itemsHTML += `
                        <div class="flavor-item">
                            <span>+ ${flavor.flavor} - ${flavor.type}</span>
                            <span>x${flavor.quantity}</span>
                        </div>
                    `;
                        });
                        itemsHTML += `</div>`;
                    }

                    itemsHTML += `</div>`;
                });
            }

            itemsHTML += `</div></div>`;

            // Status update section
            let statusUpdateHTML = `
        <div class="status-update-section">
            <div class="section-title">ðŸ”„ Update Order Status</div>
            <div class="status-options">
                <div class="status-option" data-status="Pending">
                    <span>â³</span> Pending
                </div>
                <div class="status-option" data-status="Confirmed">
                    <span>âœ…</span> Confirmed
                </div>
                <div class="status-option" data-status="Preparing">
                    <span>ðŸ‘¨â€ðŸ³</span> Preparing
                </div>
                <div class="status-option" data-status="Delivering">
                    <span>ðŸšš</span> Delivering
                </div>
                <div class="status-option" data-status="Completed">
                    <span>ðŸŽ‰</span> Completed
                </div>
                <div class="status-option" data-status="Cancelled">
                    <span>âŒ</span> Cancelled
                </div>
                <div class="status-option" data-status="Failed">
                    <span>âš ï¸</span> Failed
                </div>
            </div>
        </div>
    `;

            // Invoice actions section
            let invoiceActionsHTML = `
        <div class="invoice-actions">
            <button class="invoice-btn invoice-preview" id="preview-invoice-btn">
                <span>ðŸ‘ï¸</span> Preview Invoice
            </button>
            <button class="invoice-btn invoice-download" id="download-invoice-btn">
                <span>ðŸ“¥</span> Download Invoice
            </button>
            <button class="invoice-btn invoice-download" id="download-receipt-btn">
                <span>ðŸ§¾</span> Download Receipt
            </button>
        </div>
    `;

            // Combine all sections
            modalBody.innerHTML = `
        ${progressHTML}
        <div>
            ${customerInfoHTML}
            ${financialInfoHTML}
            ${voucherInfoHTML}
            ${deliveryInfoHTML}
        </div>
        <div>
            ${itemsHTML}
            ${statusUpdateHTML}
            ${invoiceActionsHTML} 
        </div>
    `;

            // Set up status option event listeners
            document.querySelectorAll('.status-option').forEach(opt => {
                const optionStatus = opt.getAttribute('data-status').toLowerCase();
                const optionIndex = statusSteps.indexOf(optionStatus);

                opt.classList.remove('selected', 'disabled');

                if (optionStatus === order.status.toLowerCase()) {
                    opt.classList.add('selected');
                    selectedStatus = order.status.toLowerCase();
                }

                // Add click event to status options with validation
                opt.addEventListener('click', () => {
                    if (opt.classList.contains('disabled')) return;

                    document.querySelectorAll('.status-option').forEach(option => option.classList.remove('selected'));
                    opt.classList.add('selected');
                    selectedStatus = opt.getAttribute('data-status');
                    console.log("Selected status:", selectedStatus);
                });
            });

            setTimeout(() => {
                const previewInvoiceBtn = document.getElementById('preview-invoice-btn');
                const downloadInvoiceBtn = document.getElementById('download-invoice-btn');
                const downloadReceiptBtn = document.getElementById('download-receipt-btn');

                if (previewInvoiceBtn) {
                    previewInvoiceBtn.addEventListener('click', () => {
                        showInvoicePreview(order, 'invoice');
                    });
                }

                if (downloadInvoiceBtn) {
                    downloadInvoiceBtn.addEventListener('click', () => {
                        downloadInvoice(order, 'invoice');
                    });
                }

                if (downloadReceiptBtn) {
                    downloadReceiptBtn.addEventListener('click', () => {
                        downloadInvoice(order, 'receipt');
                    });
                }
            }, 100);

            orderModal.style.display = 'flex';
        }


        // Filter orders based on current filter and search
        function filterOrders() {
            console.log("orders", orders)
            return orders.filter(order => {
                // Apply status filter
                if (currentFilter !== 'all' && order.status !== currentFilter) {
                    return false
                }

                // Apply search filter
                if (searchQuery) {
                    const searchTerm = searchQuery.toLowerCase()

                    // Get display order ID
                    const displayOrderId = (order.order_id || order.id).toString().toLowerCase();

                    // Search in multiple fields
                    const searchableFields = [
                        displayOrderId,
                        order.customer_name.toLowerCase(),
                        order.phone,
                        order.total.toString(),
                        order.payment_method.toLowerCase(),
                        order.status.toLowerCase()
                    ];

                    return searchableFields.some(field => field.includes(searchTerm));
                }

                return true
            })
        }

        // Update the filterCookies function
        function filterCookies() {
            return cookies.filter(item => {
                // Apply type filter
                if (currentCookiesFilter !== 'all') {
                    if (currentCookiesFilter === 'cookies' && item.type !== 'cookie') {
                        return false
                    }
                    if (currentCookiesFilter === 'boxes' && item.type !== 'box') {
                        return false
                    }
                }

                // Apply search filter
                if (cookiesSearchQuery) {
                    const searchTerm = cookiesSearchQuery.toLowerCase()
                    const searchableFields = [
                        item.id.toString(),
                        item.name.toLowerCase(),
                        item.type.toLowerCase(),
                        item.chewy_price ? item.chewy_price.toString() : '',
                        item.crumble_price ? item.crumble_price.toString() : '',
                        item.description ? item.description.toLowerCase() : '',
                        item.slug ? item.slug.toLowerCase() : ''
                    ]

                    return searchableFields.some(field => field.includes(searchTerm))
                }

                return true
            })
        }

        // Render all orders based on current filters
        function renderOrders() {
            const filteredOrders = filterOrders()
            renderFilteredOrders(filteredOrders)
            setupNotificationResetOnHover();
        }

        // Render all cookies based on current filters
        function renderCookies() {
            const filteredCookies = filterCookies()
            renderFilteredCookies(filteredCookies)
        }

        function renderFilteredOrders(filteredOrders, message) {
            if (filteredOrders.length === 0) {
                tableBody.innerHTML = `
            <tr>
                <td colspan="8" style="text-align: center; padding: 2rem;">
                    ${message || 'No orders found matching your criteria'}
                </td>
            </tr>
        `
                return
            }

            tableBody.innerHTML = ''

            filteredOrders.forEach(order => {
                const row = document.createElement('tr')

                // Use order_id if available, otherwise fall back to id
                const displayOrderId = order.order_id || order.id;

                row.setAttribute('data-order-id', displayOrderId)
                row.innerHTML = `
            <td>${displayOrderId}</td>
            <td>${order.customer_name}</td>
            <td>${order.phone}</td>
            <td>EGP ${order.total}</td>
            <td>${order.items ? JSON.parse(order.items).map(i => i.name + ' x' + i.quantity).join('<br>') : '-'}</td>
            <td>${order.payment_method}</td>
            <td><span class="status-badge ${getStatusClass(order.status)}">${order.status}</span></td>
            <td>${formatDateTime(order.created_at)}</td>
        `

                // Make row clickable to view details
                row.addEventListener('click', () => {
                    showOrderDetails(order)
                })

                // Make status badge clickable to quickly update status
                const statusBadge = row.querySelector('.status-badge')
                statusBadge.addEventListener('click', (e) => {
                    e.stopPropagation()
                    showOrderDetails(order)
                })

                tableBody.appendChild(row)
            })
        }
        // Update the editItem function to handle box variants
        async function editItem(id, type, variant = null) {
            try {
                // Fetch the specific item details
                const { data, error } = await supabase
                    .from(type === 'cookie' ? 'cookies' : 'boxes')
                    .select('*')
                    .eq('id', id)
                    .single()

                if (error) {
                    console.error('Error fetching item:', error)
                    showToast('Error loading item details')
                    return
                }

                // Create and show the edit modal
                showEditModal(data, type, variant)

            } catch (err) {
                console.error('Failed to edit item:', err)
                showToast('Failed to edit item')
            }
        }

        function addDiscountBadgesToRow(row, item) {
            if (item.type === 'cookie') {
                if (item.variant === 'chewy' && item.chewy_discount_active) {
                    const discountBadge = createDiscountBadge(item.chewy_discount_rate, item.chewy_discount_amount);
                    const priceCell = row.querySelector('td:nth-child(5)'); // Chewy price column
                    if (priceCell) {
                        priceCell.innerHTML = `${priceCell.innerHTML} ${discountBadge}`;
                    }
                } else if (item.variant === 'crumble' && item.crumble_discount_active) {
                    const discountBadge = createDiscountBadge(item.crumble_discount_rate, item.crumble_discount_amount);
                    const priceCell = row.querySelector('td:nth-child(6)'); // Crumble price column
                    if (priceCell) {
                        priceCell.innerHTML = `${priceCell.innerHTML} ${discountBadge}`;
                    }
                }
            } else {
                // Box discount badges
                if (item.variant === 'chewy' && item.chewy_discount_active) {
                    const discountBadge = createDiscountBadge(item.chewy_discount_rate, item.chewy_discount_amount);
                    const priceCell = row.querySelector('td:nth-child(5)'); // Chewy price column
                    if (priceCell) {
                        priceCell.innerHTML = `${priceCell.innerHTML} ${discountBadge}`;
                    }
                } else if (item.variant === 'crumble' && item.crumble_discount_active) {
                    const discountBadge = createDiscountBadge(item.crumble_discount_rate, item.crumble_discount_amount);
                    const priceCell = row.querySelector('td:nth-child(6)'); // Crumble price column
                    if (priceCell) {
                        priceCell.innerHTML = `${priceCell.innerHTML} ${discountBadge}`;
                    }
                } else if (item.variant === 'mix' && item.mix_discount_active) {
                    const discountBadge = createDiscountBadge(item.mix_discount_rate, item.mix_discount_amount);
                    const priceCell = row.querySelector('td:nth-child(7)'); // Mix price column
                    if (priceCell) {
                        priceCell.innerHTML = `${priceCell.innerHTML} ${discountBadge}`;
                    }
                }
            }
        }

        function createDiscountBadge(discountRate, discountAmount) {
            const discountValue = discountRate > 0 ? `${discountRate}%` : `EGP ${discountAmount}`;
            return `<span class="discount-badge" title="Discount: ${discountValue}">-${discountValue}</span>`;
        }

        // Update the showEditModal function to handle box variants
        function showEditModal(item, type, variant = null) {
            let modalHTML = `
        <div class="modal" id="edit-item-modal">
            <div class="modal-content" style="max-width: 600px; position: relative;">
                <!-- Loading Overlay -->
                <div class="loading-overlay" id="loading-overlay" style="display: none;">
                    <div class="upload-spinner"></div>
                    <p>Uploading Image...</p>
                </div>
                
                <div class="modal-header">
                    <h2 class="modal-title">Edit ${type === 'cookie' ? 'Cookie' : 'Box'} ${variant ? `(${variant})` : ''}</h2>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="edit-item-form" class="edit-form">
                        <div class="form-group">
                            <label>Current Image:</label>
                            <div class="current-image-container">
                                <img src="${getFullImageUrl(type === 'cookie' ? (variant === 'chewy' ? item.image_url_chewy : item.image_url_crumble) : item.image_url)}" 
                                     alt="${item.name}" 
                                     class="current-image" 
                                     onerror="this.src='https://via.placeholder.com/150x150/FFD7DF/C0394F?text=No+Image'">
                            </div>
                        </div>
    `

            if (type === 'cookie') {
                modalHTML += `
            <div class="form-group">
                <label for="edit-name">Name:</label>
                <input type="text" id="edit-name" value="${item.name || ''}" required>
            </div>
            ${variant === 'chewy' ? `
            <div class="form-group">
                <label for="edit-chewy-price">Chewy Price (EGP):</label>
                <input type="number" id="edit-chewy-price" step="0.01" value="${item.chewy_price || 0}" required>
            </div>
            ` : ''}
            ${variant === 'crumble' ? `
            <div class="form-group">
                <label for="edit-crumble-price">Crumble Price (EGP):</label>
                <input type="number" id="edit-crumble-price" step="0.01" value="${item.crumble_price || 0}" required>
            </div>
            ` : ''}
            <div class="form-group">
                <label for="edit-image-upload">Upload New Image:</label>
                <input type="file" id="edit-image-upload" accept="image/*" class="file-input">
                <small>Supported formats: JPG, PNG, SVG, WebP (Max 2MB)</small>
                <div class="image-preview" id="image-preview" style="display: none;">
                    <img id="preview-image" alt="Preview">
                    <button type="button" id="remove-preview" class="remove-preview-btn">Remove</button>
                </div>
            </div>
            <div class="form-group">
                <label for="edit-description">Description:</label>
                <textarea id="edit-description" rows="3">${item.description || ''}</textarea>
            </div>
            <div class="form-group">
                <label for="edit-slug">Slug:</label>
                <input type="text" id="edit-slug" value="${item.slug || ''}">
            </div>
            <div class="form-group">
                <label for="edit-is-active">Active:</label>
                <input type="checkbox" id="edit-is-active" ${item.is_active ? 'checked' : ''}>
            </div>
        `
            } else {
                // Box editing form
                modalHTML += `
            <div class="form-group">
                <label for="edit-name">Name:</label>
                <input type="text" id="edit-name" value="${item.name || ''}" required>
            </div>
            <div class="form-group">
                <label for="edit-size">Size:</label>
                <input type="text" id="edit-size" value="${item.size || ''}" required>
            </div>
            <div class="form-group">
                <label for="edit-cookie-count">Cookie Count:</label>
                <input type="number" id="edit-cookie-count" value="${item.cookie_count || 0}" required>
            </div>
            ${variant === 'chewy' ? `
            <div class="form-group">
                <label for="edit-chewy-price">Chewy Price (EGP):</label>
                <input type="number" id="edit-chewy-price" step="0.01" value="${item.chewy_price || 0}" required>
            </div>
            ` : ''}
            ${variant === 'crumble' ? `
            <div class="form-group">
                <label for="edit-crumble-price">Crumble Price (EGP):</label>
                <input type="number" id="edit-crumble-price" step="0.01" value="${item.crumble_price || 0}" required>
            </div>
            ` : ''}
            ${variant === 'mix' ? `
            <div class="form-group">
                <label for="edit-mix-price">Mix Price (EGP):</label>
                <input type="number" id="edit-mix-price" step="0.01" value="${item.mix_price || 0}" required>
            </div>
            ` : ''}
            <div class="form-group">
                <label for="edit-image-upload">Upload New Image:</label>
                <input type="file" id="edit-image-upload" accept="image/*" class="file-input">
                <small>Supported formats: JPG, PNG, SVG, WebP (Max 2MB)</small>
                <div class="image-preview" id="image-preview" style="display: none;">
                    <img id="preview-image" alt="Preview">
                    <button type="button" id="remove-preview" class="remove-preview-btn">Remove</button>
                </div>
            </div>
            <div class="form-group">
                <label for="edit-description">Description:</label>
                <textarea id="edit-description" rows="3">${item.description || ''}</textarea>
            </div>
            <div class="form-group">
                <label for="edit-slug">Slug:</label>
                <input type="text" id="edit-slug" value="${item.slug || ''}">
            </div>
            <div class="form-group">
                <label for="edit-is-active">Active:</label>
                <input type="checkbox" id="edit-is-active" ${item.is_active ? 'checked' : ''}>
            </div>
        `
            }

            modalHTML += `
                    </form>
                </div>
                <div class="modal-actions">
                    <button class="modal-btn btn-secondary" id="cancel-edit-btn">
                        <span>âœ•</span> Cancel
                    </button>
                    <button class="modal-btn btn-primary" id="save-edit-btn">
                        <span>âœ“</span> Save Changes
                    </button>
                </div>
            </div>
        </div>
    `
            addDiscountSectionToEditModal(editModal, item, type, variant);

            document.body.insertAdjacentHTML('beforeend', modalHTML)

            const editModal = document.getElementById('edit-item-modal')
            editModal.style.display = 'flex'

            setupEditModalEvents(editModal, item, type, variant)
            setupImageUploadPreview()
        }

        // Update the getFullImageUrl function
        function getFullImageUrl(imageUrl) {
            if (!imageUrl) return 'https://via.placeholder.com/150x150/FFD7DF/C0394F?text=No+Image';
            if (imageUrl.startsWith('http')) return imageUrl;
            return `https://${GITHUB_USERNAME}.github.io/${GITHUB_REPO}/${imageUrl}`;
        }

        // Setup image upload preview
        function setupImageUploadPreview() {
            const fileInput = document.getElementById('edit-image-upload');
            const previewContainer = document.getElementById('image-preview');
            const previewImage = document.getElementById('preview-image');
            const removePreviewBtn = document.getElementById('remove-preview');

            if (!fileInput) return;

            fileInput.addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (file) {
                    // Validate file type and size
                    if (!file.type.match('image.*')) {
                        showToast('Please select a valid image file');
                        return;
                    }

                    if (file.size > 2 * 1024 * 1024) { // 2MB limit
                        showToast('Image size must be less than 2MB');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function (e) {
                        previewImage.src = e.target.result;
                        previewContainer.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });

            if (removePreviewBtn) {
                removePreviewBtn.addEventListener('click', function () {
                    fileInput.value = '';
                    previewContainer.style.display = 'none';
                    previewImage.src = '';
                });
            }
        }


        // Update the setupEditModalEvents function to prevent closing during upload
        function setupEditModalEvents(modal, item, type, variant = null) {
            const closeModal = modal.querySelector('.close-modal');
            const cancelBtn = modal.querySelector('#cancel-edit-btn');

            const closeModalHandler = () => {
                // Check if there's an active upload (waiting modal exists)
                const waitingModal = document.getElementById('upload-waiting-modal');
                if (waitingModal) {
                    if (!confirm('Image upload is in progress. Are you sure you want to cancel? This will abort the upload.')) {
                        return;
                    }
                    // Remove waiting modal if user confirms cancellation
                    waitingModal.remove();
                }
                modal.remove();
            };

            closeModal.addEventListener('click', closeModalHandler);
            cancelBtn.addEventListener('click', closeModalHandler);

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModalHandler();
                }
            });

            const saveBtn = modal.querySelector('#save-edit-btn');
            saveBtn.addEventListener('click', async () => {
                const inputs = modal.querySelectorAll('input, textarea, button');
                inputs.forEach(input => {
                    if (input !== saveBtn && input !== cancelBtn) {
                        input.disabled = true;
                    }
                });

                await saveItemChanges(item.id, type, modal, variant);
            });

            modal.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const waitingModal = document.getElementById('upload-waiting-modal');
                    if (!waitingModal) {
                        saveBtn.click();
                    }
                }
            });
        }


        // Update the uploadImageToGitHub function to use the fetched credentials
        // Update the uploadImageToGitHub function to handle filename conflicts
        async function uploadImageToGitHub(file, itemId, type, variant = null) {
            try {
                // Generate unique filename with random component
                const fileExtension = file.name.split('.').pop();
                const timestamp = new Date().getTime();
                const randomString = Math.random().toString(36).substring(2, 8);
                const variantSuffix = variant ? `_${variant}` : '';
                const filename = `${type}_${itemId}${variantSuffix}_${timestamp}_${randomString}.${fileExtension}`;
                const path = `images/${filename}`;

                const base64Content = await fileToBase64(file);

                const response = await fetch(`https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${path}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: `Upload ${type} image for ${itemId}${variant ? ` (${variant})` : ''}`,
                        content: base64Content.split(',')[1],
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('GitHub API error details:', errorData);
                    throw new Error(`GitHub API error: ${response.status} - ${errorData.message}`);
                }

                const result = await response.json();
                return path;

            } catch (error) {
                console.error('Error uploading image to GitHub:', error);
                showToast('Error uploading image: ' + error.message);
                return null;
            }
        }


        // Helper function to convert file to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // Add this function to check image availability on GitHub
        async function waitForImageAvailability(imageUrl, maxWaitTime = 60000) {
            return new Promise((resolve, reject) => {
                const startTime = Date.now();
                let attempts = 0;

                function checkImage() {
                    attempts++;
                    const img = new Image();
                    img.onload = () => {
                        console.log(`âœ… Image available after ${attempts} attempts and ${Date.now() - startTime}ms`);
                        resolve(true);
                    };
                    img.onerror = () => {
                        const elapsed = Date.now() - startTime;
                        if (elapsed > maxWaitTime) {
                            console.log(`âŒ Image not available after ${maxWaitTime}ms`);
                            resolve(false);
                            return;
                        }

                        // Update the waiting modal status
                        const uploadStatus = document.getElementById('upload-status');
                        if (uploadStatus) {
                            const secondsElapsed = Math.floor(elapsed / 1000);
                            uploadStatus.textContent = `Step 2/2: Waiting for image... (${secondsElapsed}s) - Attempt ${attempts}`;
                        }

                        // Exponential backoff with max 5 second intervals
                        const delay = Math.min(1000 * Math.pow(1.5, attempts - 1), 5000);
                        setTimeout(checkImage, delay);
                    };
                    img.src = imageUrl + '?t=' + Date.now(); // Cache busting
                }

                checkImage();
            });
        }


        async function getDiscountDataFromModal(modal, type, variant = null) {
            const discountData = {};

            if (type === 'cookie' && variant) {
                // Single variant
                const variantData = getVariantDiscountData(modal, variant);
                Object.assign(discountData, variantData);
            } else if (type === 'cookie') {
                // Both variants
                if (modal.querySelector('#edit-chewy-discount-type')) {
                    const chewyData = getVariantDiscountData(modal, 'chewy');
                    Object.assign(discountData, chewyData);
                }
                if (modal.querySelector('#edit-crumble-discount-type')) {
                    const crumbleData = getVariantDiscountData(modal, 'crumble');
                    Object.assign(discountData, crumbleData);
                }
            } else {
                // Box variants
                if (modal.querySelector('#edit-chewy-discount-type')) {
                    const chewyData = getVariantDiscountData(modal, 'chewy');
                    Object.assign(discountData, chewyData);
                }
                if (modal.querySelector('#edit-crumble-discount-type')) {
                    const crumbleData = getVariantDiscountData(modal, 'crumble');
                    Object.assign(discountData, crumbleData);
                }
                if (modal.querySelector('#edit-mix-discount-type')) {
                    const mixData = getVariantDiscountData(modal, 'mix');
                    Object.assign(discountData, mixData);
                }
            }

            return discountData;
        }

        // Get discount data for a specific variant
        function getVariantDiscountData(modal, variant) {
            const typeSelect = modal.querySelector(`#edit-${variant}-discount-type`);
            const valueInput = modal.querySelector(`#edit-${variant}-discount-value`);
            const toggleBtn = modal.querySelector(`#edit-${variant}-discount-toggle`);

            if (!typeSelect || !valueInput || !toggleBtn) return {};

            const discountValue = parseFloat(valueInput.value) || 0;
            const isActive = toggleBtn.classList.contains('active');

            const variantData = {};

            if (typeSelect.value === 'rate') {
                variantData[`${variant}_discount_rate`] = isActive ? discountValue : 0;
                variantData[`${variant}_discount_amount`] = 0;
            } else {
                variantData[`${variant}_discount_rate`] = 0;
                variantData[`${variant}_discount_amount`] = isActive ? discountValue : 0;
            }

            variantData[`${variant}_discount_active`] = isActive;

            return variantData;
        }




        // Update the saveItemChanges function for boxes
        async function saveItemChanges(itemId, type, modal, variant = null) {
            try {
                const form = modal.querySelector('#edit-item-form');
                const fileInput = modal.querySelector('#edit-image-upload');
                const file = fileInput.files[0];
                const saveBtn = modal.querySelector('#save-edit-btn');
                const cancelBtn = modal.querySelector('#cancel-edit-btn');
                // Handle discount data
                const discountData = await getDiscountDataFromModal(modal, type, variant);

                // Merge discount data with existing update data
                Object.assign(updateData, discountData);
                // Disable form during upload
                const inputs = modal.querySelectorAll('input, textarea, button, select');
                inputs.forEach(input => {
                    if (input !== saveBtn && input !== cancelBtn) {
                        input.disabled = true;
                    }
                });

                // Show upload status
                saveBtn.innerHTML = '<span>â³</span> Uploading to GitHub...';
                saveBtn.disabled = true;

                let imageUrl = '';

                // If a new file is selected, upload it
                if (file) {
                    // Show waiting modal
                    const waitingModalHTML = `
                <div class="modal" id="upload-waiting-modal" 
                    style="display: flex; justify-content: center; align-items: center; height: 100vh;">
                
                <div class="modal-content" style="max-width: 500px; width: 100%; background: #fff;">
                   
                    <div class="modal-body" style="display: flex; flex-direction: column; align-items: center; gap: 1rem;">
                    
                    <!-- Spinner -->
                    <div style="width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    
                    <!-- Title -->
                    <h3 style="color: var(--primary); margin: 0;">Uploading The Image</h3>
                    
                    <!-- Subtitle -->
                    <p style="color: var(--gray); font-size: 0.9rem; margin: 0;">
                        This may take a while...
                    </p>
                    </div>
                </div>
                </div>
            `;

                    document.body.insertAdjacentHTML('beforeend', waitingModalHTML);
                    const waitingModal = document.getElementById('upload-waiting-modal');

                    try {
                        // Upload to GitHub
                        imageUrl = await uploadImageToGitHub(file, itemId, type, variant);

                        if (!imageUrl) {
                            throw new Error('Upload failed - no URL returned');
                        }

                        const fullImageUrl = `https://${GITHUB_USERNAME}.github.io/${GITHUB_REPO}/${imageUrl}`;
                        const isAvailable = await waitForImageAvailability(fullImageUrl);

                        if (!isAvailable) {
                            throw new Error('Image not available on GitHub after upload');
                        }

                        waitingModal.remove();

                    } catch (error) {
                        console.error('Upload failed:', error);
                        showToast('âŒ Upload failed: ' + error.message);
                        waitingModal.remove();

                        // Re-enable form on failure
                        inputs.forEach(input => input.disabled = false);
                        saveBtn.innerHTML = '<span>âœ“</span> Save Changes';
                        saveBtn.disabled = false;
                        return;
                    }
                }

                // Continue with saving other data
                saveBtn.innerHTML = '<span>ðŸ’¾</span> Saving Changes...';

                const updateData = {};

                if (type === 'cookie') {
                    updateData.name = modal.querySelector('#edit-name').value;
                    updateData.description = modal.querySelector('#edit-description').value;
                    updateData.slug = modal.querySelector('#edit-slug').value;
                    updateData.is_active = modal.querySelector('#edit-is-active').checked;

                    if (variant === 'chewy') {
                        updateData.chewy_price = parseFloat(modal.querySelector('#edit-chewy-price').value) || 0;
                        if (imageUrl) {
                            updateData.image_url_chewy = imageUrl;
                        }
                    } else if (variant === 'crumble') {
                        updateData.crumble_price = parseFloat(modal.querySelector('#edit-crumble-price').value) || 0;
                        if (imageUrl) {
                            updateData.image_url_crumble = imageUrl;
                        }
                    }
                } else {
                    // Box update data
                    updateData.name = modal.querySelector('#edit-name').value;
                    updateData.size = modal.querySelector('#edit-size').value;
                    updateData.cookie_count = parseInt(modal.querySelector('#edit-cookie-count').value) || 0;
                    updateData.description = modal.querySelector('#edit-description').value;
                    updateData.slug = modal.querySelector('#edit-slug').value;
                    updateData.is_active = modal.querySelector('#edit-is-active').checked;

                    // Update the specific variant price
                    if (variant === 'chewy') {
                        updateData.chewy_price = parseFloat(modal.querySelector('#edit-chewy-price').value) || 0;
                    } else if (variant === 'crumble') {
                        updateData.crumble_price = parseFloat(modal.querySelector('#edit-crumble-price').value) || 0;
                    } else if (variant === 'mix') {
                        updateData.mix_price = parseFloat(modal.querySelector('#edit-mix-price').value) || 0;
                    }

                    if (imageUrl) {
                        updateData.image_url = imageUrl;
                    }
                }

                if (!updateData.name) {
                    showToast('Name is required');
                    inputs.forEach(input => input.disabled = false);
                    saveBtn.innerHTML = '<span>âœ“</span> Save Changes';
                    saveBtn.disabled = false;
                    return;
                }

                const { error } = await supabase
                    .from(type === 'cookie' ? 'cookies' : 'boxes')
                    .update(updateData)
                    .eq('id', itemId);

                if (error) {
                    console.error('Error updating item:', error);
                    showToast('Error updating item: ' + error.message);
                } else {
                    showToast(`âœ… ${type === 'cookie' ? 'Cookie' : 'Box'} ${variant ? `(${variant})` : ''} updated successfully`);
                    modal.remove();
                    loadCookies();
                }

            } catch (err) {
                console.error('Failed to update item:', err);
                showToast('Failed to update item');

                // Re-enable form on error
                const inputs = modal.querySelectorAll('input, textarea, button, select');
                inputs.forEach(input => input.disabled = false);

                const saveBtn = modal.querySelector('#save-edit-btn');
                saveBtn.innerHTML = '<span>âœ“</span> Save Changes';
                saveBtn.disabled = false;

                // Remove waiting modal if it exists
                const waitingModal = document.getElementById('upload-waiting-modal');
                if (waitingModal) {
                    waitingModal.remove();
                }
            }
        }

        // Update table headers when the page loads
        document.addEventListener('DOMContentLoaded', function () {
            updateTableHeaders();
        });

        // Update the deleteItem function for cookies
        async function deleteItem(id, type, name, variant = null) {
            const itemName = variant ? `${name} (${variant})` : name;

            if (confirm(`Are you sure you want to delete ${itemName}? This action cannot be undone.`)) {
                try {
                    if (type === 'cookie') {
                        // For cookies, we need to check if we're deleting the last variant
                        const { data: cookieData, error: fetchError } = await supabase
                            .from('cookies')
                            .select('chewy_price, crumble_price')
                            .eq('id', id)
                            .single();

                        if (fetchError) {
                            console.error('Error fetching cookie data:', fetchError);
                            showToast('Error fetching cookie data');
                            return;
                        }

                        const { chewy_price, crumble_price } = cookieData;

                        let updateData = {};

                        if (variant === 'chewy') {
                            updateData.chewy_price = null;
                            updateData.image_url_chewy = null;
                        } else if (variant === 'crumble') {
                            updateData.crumble_price = null;
                            updateData.image_url_crumble = null;
                        }

                        // Check if this is the last variant being deleted
                        const remainingChewy = variant === 'chewy' ? null : chewy_price;
                        const remainingCrumble = variant === 'crumble' ? null : crumble_price;

                        const isLastVariant = !remainingChewy && !remainingCrumble;

                        if (isLastVariant) {
                            // Delete the entire cookie if no variants remain
                            const { error } = await supabase
                                .from('cookies')
                                .delete()
                                .eq('id', id);

                            if (error) {
                                console.error('Error deleting cookie:', error);
                                showToast('Error deleting cookie');
                            } else {
                                showToast(`${itemName} deleted successfully`);
                                loadCookies();
                            }
                        } else {
                            // Only update the specific variant
                            const { error } = await supabase
                                .from('cookies')
                                .update(updateData)
                                .eq('id', id);

                            if (error) {
                                console.error('Error deleting cookie variant:', error);
                                showToast('Error deleting cookie variant');
                            } else {
                                showToast(`${itemName} deleted successfully`);
                                loadCookies();
                            }
                        }
                    } else {
                        // Box deletion logic remains the same
                        const updateData = {};
                        if (variant === 'chewy') {
                            updateData.chewy_price = null;
                        } else if (variant === 'crumble') {
                            updateData.crumble_price = null;
                        } else if (variant === 'mix') {
                            updateData.mix_price = null;
                        }

                        // Check if all prices are null, then deactivate the entire box
                        const { data: boxData, error: fetchError } = await supabase
                            .from('boxes')
                            .select('chewy_price, crumble_price, mix_price')
                            .eq('id', id)
                            .single();

                        if (!fetchError) {
                            const { chewy_price, crumble_price, mix_price } = boxData;
                            const allPricesNull = !chewy_price && !crumble_price && !mix_price;

                            if (allPricesNull) {
                                updateData.is_active = false;
                            }

                            const { error } = await supabase
                                .from('boxes')
                                .update(updateData)
                                .eq('id', id);

                            if (error) {
                                console.error('Error deleting box variant:', error);
                                showToast('Error deleting box variant');
                            } else {
                                showToast(`${itemName} deleted successfully`);
                                loadCookies();
                            }
                        }
                    }
                } catch (err) {
                    console.error('Failed to delete item:', err);
                    showToast('Failed to delete item');
                }
            }
        }
        // Update the renderFilteredCookies function to handle box types
        function renderFilteredCookies(filteredCookies, message) {
            if (filteredCookies.length === 0) {
                cookiesTable.innerHTML = `
            <tr>
                <td colspan="10" style="text-align: center; padding: 2rem;">
                    ${message || 'No items found matching your criteria'}
                </td>
            </tr>
        `
                return
            }

            cookiesTable.innerHTML = ''

            filteredCookies.forEach(item => {
                const row = document.createElement('tr')

                // Function to get full image URL
                const getImageUrl = (imageUrl) => {
                    if (!imageUrl) return 'https://via.placeholder.com/50x50/FFD7DF/C0394F?text=No+Image';
                    if (imageUrl.startsWith('http')) return imageUrl;
                    return `https://${GITHUB_USERNAME}.github.io/${GITHUB_REPO}/${imageUrl}`;
                };

                const imageUrl = getImageUrl(item.image_url);

                if (item.type === 'cookie') {
                    row.innerHTML = `
                <td>
                    <img src="${imageUrl}" alt="${item.name}" class="item-image">
                </td>
                <td>${item.id}</td>
                <td>${item.name}</td>
                <td>Cookie (${item.variant})</td>
                <td>${item.variant === 'chewy' ? `EGP ${item.price || 0}` : '-'}</td>
                <td>${item.variant === 'crumble' ? `EGP ${item.price || 0}` : '-'}</td>
                <td>-</td>
                <td>${item.description ? (item.description.length > 50 ? item.description.substring(0, 50) + '...' : item.description) : 'No description'}</td>
                <td>${item.slug || 'No slug'}</td>
                <td>
                    <button class="action-btn edit-btn" data-id="${item.original_id}" data-type="cookie" data-variant="${item.variant}">Edit</button>
                    <button class="action-btn delete-btn" data-id="${item.original_id}" data-type="cookie" data-variant="${item.variant}">Delete</button>
                </td>
            `
                } else {
                    // Box row with enhanced information
                    row.innerHTML = `
                <td>
                    <img src="${imageUrl}" alt="${item.name}" class="item-image">
                </td>
                <td>${item.id}</td>
                <td>${item.name}</td>
                <td>Box (${item.variant})</td>
                <td>${item.variant === 'chewy' ? `EGP ${item.price || 0}` : '-'}</td>
                <td>${item.variant === 'crumble' ? `EGP ${item.price || 0}` : '-'}</td>
                <td>${item.variant === 'mix' ? `EGP ${item.price || 0}` : '-'}</td>
                <td>${item.description || 'No description'}</td>
                <td>${item.slug || 'No slug'}</td>
                <td>
                    <button class="action-btn edit-btn" data-id="${item.original_id}" data-type="box" data-variant="${item.variant}">Edit</button>
                    <button class="action-btn delete-btn" data-id="${item.original_id}" data-type="box" data-variant="${item.variant}">Delete</button>
                </td>
            `
                }

                // Add click event to image for larger preview
                const image = row.querySelector('.item-image');
                image.style.cursor = 'pointer';
                image.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showImagePreview(imageUrl, item.name);
                });

                // Add event listeners to action buttons
                row.querySelector('.edit-btn').addEventListener('click', (e) => {
                    e.stopPropagation()
                    editItem(item.original_id || item.id, item.type, item.variant)
                })

                row.querySelector('.delete-btn').addEventListener('click', (e) => {
                    e.stopPropagation()
                    deleteItem(item.original_id || item.id, item.type, item.name, item.variant)
                })

                cookiesTable.appendChild(row)
                addDiscountBadgesToRow(row, item);
            })
        }

        // Update the table headers for boxes to include mix price
        function updateTableHeaders() {
            const cookiesTableHeaders = document.querySelector('#cookies-tab-content thead tr');
            if (cookiesTableHeaders) {
                cookiesTableHeaders.innerHTML = `
            <th>Image</th>
            <th data-sort="id">ID â†•</th>
            <th data-sort="name">Name â†•</th>
            <th data-sort="type">Type â†•</th>
            <th data-sort="chewy_price">Chewy Price (EGP) â†•</th>
            <th data-sort="crumble_price">Crumble Price (EGP) â†•</th>
            <th data-sort="mix_price">Mix Price (EGP) â†•</th>
            <th>Description</th>
            <th>Slug</th>
            <th>Actions</th>
        `;
            }
        }


        // Add image preview function
        function showImagePreview(imageUrl, itemName) {
            const previewHTML = `
        <div class="modal" id="image-preview-modal">
            <div class="modal-content" style="max-width: 500px; text-align: center;">
                <div class="modal-header">
                    <h2 class="modal-title">${itemName}</h2>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <img src="${imageUrl}" alt="${itemName}" style="max-height: 400px; border-radius: 8px;">
                </div>
                <div class="modal-actions">
                    <button class="modal-btn btn-secondary" id="close-preview-btn">
                        <span>âœ•</span> Close
                    </button>
                </div>
            </div>
        </div>
    `

            document.body.insertAdjacentHTML('beforeend', previewHTML)

            const previewModal = document.getElementById('image-preview-modal')
            previewModal.style.display = 'flex'

            // Close modal events
            const closeModal = () => previewModal.remove()

            previewModal.querySelector('.close-modal').addEventListener('click', closeModal)
            previewModal.querySelector('#close-preview-btn').addEventListener('click', closeModal)
            previewModal.addEventListener('click', (e) => {
                if (e.target === previewModal) closeModal()
            })
        }

        function renderNewOrder(order) {
            const filteredOrders = filterOrders()
            const row = document.createElement('tr')
            row.classList.add('highlight', 'new-order', 'new-order-pulse')
            row.setAttribute('data-order-id', order.order_id)
            row.innerHTML = `
        <td>${order.order_id}</td>
        <td>${order.customer_name}</td>
        <td>${order.phone}</td>
        <td>EGP ${order.total}</td>
        <td>${order.items ? JSON.parse(order.items).map(i => i.name + ' x' + i.quantity).join('<br>') : '-'}</td>
        <td>${order.payment_method}</td>
        <td><span class="status-badge ${getStatusClass(order.status)}">${order.status}</span></td>
        <td>${formatDateTime(order.created_at)}</td>
    `
            // Add hover event to reset notification count
            row.addEventListener('mouseenter', () => {
                if (row.classList.contains('new-order')) {
                    // Reset notification count
                    unreadCount = 0;
                    notificationCount.textContent = '0';
                    notificationCount.style.display = 'none';
                    notificationIndicatorText.textContent = 'No new orders';

                    // Remove new-order class from this row
                    row.classList.remove('new-order', 'new-order-pulse');
                }
            });
            // Make row clickable to view details
            row.addEventListener('click', () => {
                showOrderDetails(order)
            })

            // Make status badge clickable to quickly update status
            const statusBadge = row.querySelector('.status-badge')
            statusBadge.addEventListener('click', (e) => {
                e.stopPropagation()
                showOrderDetails(order)
            })

            tableBody.prepend(row)

            // Remove highlight after animation, keep new-order class
            setTimeout(() => {
                row.classList.remove('highlight', 'new-order-pulse')
            }, 3000)

            // Add notification for the new order
            addNotification(order)


            // Trigger notifications for new orders only
            const message = `Order #${order.order_id} from ${order.customer_name}, Total: EGP ${order.total}`
            showToast(message)
            playSound()
            showBrowserNotification(message)

            setTimeout(() => {
                setupNotificationResetOnHover();
            }, 100);
        }

        // Sort orders
        function sortOrders(field) {
            if (sortField === field) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc'
            } else {
                sortField = field
                sortDirection = 'desc'
            }

            orders.sort((a, b) => {
                let valueA = a[field]
                let valueB = b[field]

                // Handle different data types
                if (field === 'created_at') {
                    valueA = new Date(valueA)
                    valueB = new Date(valueB)
                } else if (field === 'total') {
                    valueA = Number(valueA)
                    valueB = Number(valueB)
                }

                if (valueA < valueB) return sortDirection === 'asc' ? -1 : 1
                if (valueA > valueB) return sortDirection === 'asc' ? 1 : -1
                return 0
            })

            renderOrders()

            // Update sort indicators
            document.querySelectorAll('th').forEach(th => {
                th.innerHTML = th.innerHTML.replace(' â†‘', '').replace(' â†“', '')
                if (th.getAttribute('data-sort') === field) {
                    th.innerHTML += sortDirection === 'asc' ? ' â†‘' : ' â†“'
                }
            })
        }

        // Export orders to CSV
        function exportOrders() {
            const filteredOrders = filterOrders()
            if (filteredOrders.length === 0) {
                showToast('No orders to export')
                return
            }

            let csv = 'Order ID,Customer Name,Phone,Total,Payment Method,Status,Time\n'

            filteredOrders.forEach(order => {
                csv += `"${order.order_id}","${order.customer_name}","${order.phone}","${order.total}","${order.payment_method}","${order.status}","${formatDateTime(order.created_at)}"\n`
            })

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' })
            const url = URL.createObjectURL(blob)
            const link = document.createElement('a')
            link.setAttribute('href', url)
            link.setAttribute('download', `orders_export_${new Date().toISOString().split('T')[0]}.csv`)
            link.style.visibility = 'hidden'
            document.body.appendChild(link)
            link.click()
            document.body.removeChild(link)

            showToast('Orders exported successfully')
        }

        // Export cookies to CSV
        function exportCookies() {
            const filteredCookies = filterCookies()
            if (filteredCookies.length === 0) {
                showToast('No items to export')
                return
            }

            let csv = 'ID,Name,Type,Price,Stock,Status\n'

            filteredCookies.forEach(cookie => {
                csv += `"${cookie.id}","${cookie.name}","${cookie.type}","${cookie.price}","${cookie.stock}","${getStockStatusText(cookie.stock)}"\n`
            })

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' })
            const url = URL.createObjectURL(blob)
            const link = document.createElement('a')
            link.setAttribute('href', url)
            link.setAttribute('download', `items_export_${new Date().toISOString().split('T')[0]}.csv`)
            link.style.visibility = 'hidden'
            document.body.appendChild(link)
            link.click()
            document.body.removeChild(link)

            showToast('Items exported successfully')
        }

        async function loadOrders(loadMore = false) {
            const state = infiniteScrollState.orders;

            if (state.isLoading) return;

            try {
                state.isLoading = true;

                if (!loadMore) {
                    // First load - show loading in table
                    tableBody.innerHTML = `
                <tr>
                    <td colspan="8">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                        </div>
                    </td>
                </tr>
            `;
                    state.currentPage = 1;
                    state.allData = [];
                } else {
                    // Show loading more indicator
                    document.getElementById('orders-loading').style.display = 'flex';
                }

                const from = (state.currentPage - 1) * state.pageSize;
                const to = from + state.pageSize - 1;

                const { data, error, count } = await supabase
                    .from('orders')
                    .select('*', { count: 'exact' })
                    .order('created_at', { ascending: false })
                    .range(from, to);

                if (error) {
                    console.error('Error loading orders:', error);
                    showToast('Error loading orders');
                    return;
                }

                // Check if there's more data
                const totalLoaded = state.currentPage * state.pageSize;
                state.hasMore = totalLoaded < count;

                // Add new data to existing data
                if (loadMore) {
                    state.allData = [...state.allData, ...data];
                } else {
                    state.allData = data;
                }

                state.currentPage++;

                // Update UI with all loaded data
                orders = state.allData;
                updateStats();
                renderOrders();

                // Hide loading indicators
                document.getElementById('orders-loading').style.display = 'none';

                // Show end of results message if no more data
                if (!state.hasMore && state.allData.length > 0) {
                    const existingEndMessage = document.getElementById('orders-end-message');
                    if (!existingEndMessage) {
                        const endMessage = document.createElement('div');
                        endMessage.id = 'orders-end-message';
                        endMessage.className = 'end-of-results';
                        endMessage.textContent = 'No more orders to load';
                        document.getElementById('orders-tab-content').appendChild(endMessage);
                    }
                }

                // Add to notifications (only first load)
                if (!loadMore) {
                    data.slice(0, 5).forEach(order => {
                        const notification = {
                            id: order.order_id,
                            title: `Order #${order.order_id}`,
                            customer: order.customer_name,
                            total: order.total,
                            items: order.items ? JSON.parse(order.items).length : 0,
                            time: new Date(order.created_at).toLocaleTimeString(),
                            isNew: false
                        };
                        notifications.push(notification);
                    });
                    renderNotifications();
                }

            } catch (err) {
                console.error('Failed to load orders:', err);
                showToast('Failed to load orders');
            } finally {
                state.isLoading = false;
            }
        }

        // Update the loadCookies function to handle boxes with three types
        async function loadCookies(loadMore = false) {
            const state = infiniteScrollState.cookies;

            if (state.isLoading) return;

            try {
                state.isLoading = true;

                if (!loadMore) {
                    cookiesTable.innerHTML = `
                <tr>
                    <td colspan="10">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                        </div>
                    </td>
                </tr>
            `;
                    state.currentPage = 1;
                    state.allData = [];
                } else {
                    document.getElementById('cookies-loading').style.display = 'flex';
                }

                // Load all data first
                const { data: cookiesData, error: cookiesError } = await supabase
                    .from('cookies')
                    .select('*')
                    .order('name', { ascending: true });

                if (cookiesError) {
                    console.error('Error loading cookies:', cookiesError);
                    showToast('Error loading cookies');
                }

                const { data: boxesData, error: boxesError } = await supabase
                    .from('boxes')
                    .select('*')
                    .order('name', { ascending: true });

                if (boxesError) {
                    console.error('Error loading boxes:', boxesError);
                }

                // Combine and process data
                let combinedItems = [];

                // Process cookies (same as before)
                if (cookiesData) {
                    cookiesData.forEach(cookie => {
                        if (cookie.chewy_price && cookie.is_active) {
                            combinedItems.push({
                                id: `${cookie.id}_chewy`,
                                original_id: cookie.id,
                                name: `${cookie.name} (Chewy)`,
                                type: 'cookie',
                                variant: 'chewy',
                                price: cookie.chewy_price,
                                description: cookie.description || '',
                                slug: cookie.slug || '',
                                image_url: cookie.image_url_chewy || '',
                                chewy_discount_rate: cookie.chewy_discount_rate || 0,
                                chewy_discount_amount: cookie.chewy_discount_amount || 0,
                                chewy_discount_active: cookie.chewy_discount_active || false,
                                is_active: cookie.is_active,
                                created_at: cookie.created_at
                            });
                        }

                        if (cookie.crumble_price && cookie.is_active) {
                            combinedItems.push({
                                id: `${cookie.id}_crumble`,
                                original_id: cookie.id,
                                name: `${cookie.name} (Crumble)`,
                                type: 'cookie',
                                variant: 'crumble',
                                price: cookie.crumble_price,
                                description: cookie.description || '',
                                slug: cookie.slug || '',
                                image_url: cookie.image_url_crumble || '',
                                is_active: cookie.is_active,
                                chewy_discount_rate: box.chewy_discount_rate || 0,
                                chewy_discount_amount: box.chewy_discount_amount || 0,
                                chewy_discount_active: box.chewy_discount_active || false,
                                // ... add for other variants ...
                                created_at: cookie.created_at
                            });
                        }
                    });
                }

                // Process boxes with three types
                if (boxesData) {
                    boxesData.forEach(box => {
                        // Create three entries for each box type
                        if (box.chewy_price && box.is_active) {
                            combinedItems.push({
                                id: `${box.id}_chewy`,
                                original_id: box.id,
                                name: `${box.name} (Chewy)`,
                                type: 'box',
                                variant: 'chewy',
                                price: box.chewy_price,
                                description: box.description || '',
                                slug: box.slug || '',
                                image_url: box.image_url || '',
                                is_active: box.is_active,
                                created_at: box.created_at,
                                size: box.size,
                                cookie_count: box.cookie_count
                            });
                        }

                        if (box.crumble_price && box.is_active) {
                            combinedItems.push({
                                id: `${box.id}_crumble`,
                                original_id: box.id,
                                name: `${box.name} (Crumble)`,
                                type: 'box',
                                variant: 'crumble',
                                price: box.crumble_price,
                                description: box.description || '',
                                slug: box.slug || '',
                                image_url: box.image_url || '',
                                is_active: box.is_active,
                                created_at: box.created_at,
                                size: box.size,
                                cookie_count: box.cookie_count
                            });
                        }

                        if (box.mix_price && box.is_active) {
                            combinedItems.push({
                                id: `${box.id}_mix`,
                                original_id: box.id,
                                name: `${box.name} (Mix)`,
                                type: 'box',
                                variant: 'mix',
                                price: box.mix_price,
                                description: box.description || '',
                                slug: box.slug || '',
                                image_url: box.image_url || '',
                                is_active: box.is_active,
                                created_at: box.created_at,
                                size: box.size,
                                cookie_count: box.cookie_count
                            });
                        }
                    });
                }

                // Apply pagination to combined data
                const startIndex = (state.currentPage - 1) * state.pageSize;
                const endIndex = startIndex + state.pageSize;
                const pageData = combinedItems.slice(startIndex, endIndex);

                // Check if there's more data
                state.hasMore = endIndex < combinedItems.length;

                // Add new data to existing data
                if (loadMore) {
                    state.allData = [...state.allData, ...pageData];
                } else {
                    state.allData = pageData;
                }

                state.currentPage++;

                // Update UI
                cookies = state.allData;
                updateCookiesStats();
                renderCookies();

                document.getElementById('cookies-loading').style.display = 'none';

                if (!state.hasMore && state.allData.length > 0) {
                    const existingEndMessage = document.getElementById('cookies-end-message');
                    if (!existingEndMessage) {
                        const endMessage = document.createElement('div');
                        endMessage.id = 'cookies-end-message';
                        endMessage.className = 'end-of-results';
                        endMessage.textContent = 'No more items to load';
                        document.getElementById('cookies-tab-content').appendChild(endMessage);
                    }
                }

            } catch (err) {
                console.error('Failed to load items:', err);
                showToast('Failed to load items');
            } finally {
                state.isLoading = false;
            }
        }

        // Set up event listeners
        function setupEventListeners() {
            // Filter buttons for orders
            document.querySelectorAll('.filter-btn[data-filter]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn[data-filter]').forEach(b => b.classList.remove('active'))
                    btn.classList.add('active')
                    currentFilter = btn.dataset.filter
                    renderOrders()
                })
            })

            // Add this to your existing setupEventListeners function
            document.addEventListener('click', function (e) {
                // Handle shipping edit buttons
                if (e.target.classList.contains('edit-btn') && e.target.dataset.type === 'city') {
                    const cityId = parseInt(e.target.dataset.id);
                    editCity(cityId);
                }

                if (e.target.classList.contains('edit-btn') && e.target.dataset.type === 'zone') {
                    const zoneId = parseInt(e.target.dataset.id);
                    editZone(zoneId);
                }

                // Handle shipping delete buttons
                if (e.target.classList.contains('delete-btn') && e.target.dataset.type === 'city') {
                    const cityId = parseInt(e.target.dataset.id);
                    const city = shippingCities.find(c => c.id === cityId);
                    if (city) {
                        deleteCity(cityId, city.city);
                    }
                }

                if (e.target.classList.contains('delete-btn') && e.target.dataset.type === 'zone') {
                    const zoneId = parseInt(e.target.dataset.id);
                    const zone = shippingZones.find(z => z.id === zoneId);
                    if (zone) {
                        deleteZone(zoneId, zone.zone_name);
                    }
                }

                // Handle view zones buttons
                if (e.target.classList.contains('view-zones-btn')) {
                    const cityId = parseInt(e.target.dataset.id);
                    const cityName = e.target.dataset.city;

                    // Switch to zones view and filter by this city
                    currentShippingView = 'zones';
                    document.querySelectorAll('.filter-btn[data-filter-shipping]').forEach(btn => btn.classList.remove('active'));
                    document.querySelector('.filter-btn[data-filter-shipping="zones"]').classList.add('active');
                    document.getElementById('cities-view').style.display = 'none';
                    document.getElementById('zones-view').style.display = 'block';
                    document.getElementById('search-shipping-input').value = cityName;
                    shippingSearchQuery = cityName;
                    renderZonesView();
                }
            });

            // Refresh items dropdown when free item checkbox is checked
            document.getElementById('voucher-free-item').addEventListener('change', function () {
                if (this.checked) {
                    const selectedItems = selectedVoucher ? selectedVoucher.items || [] : []
                    populateItemsDropdown(selectedItems)
                }
            })

            // Handle "All Items" selection logic
            document.getElementById('voucher-items').addEventListener('change', function () {
                const selectedOptions = Array.from(this.selectedOptions)
                const hasAllSelected = selectedOptions.some(option => option.value === 'all')

                if (hasAllSelected) {
                    // If "All Items" is selected, deselect all other options and select only "All Items"
                    Array.from(this.options).forEach(option => {
                        option.selected = option.value === 'all'
                    })
                } else if (selectedOptions.length > 0) {
                    // If specific items are selected, ensure "All Items" is not selected
                    const allOption = Array.from(this.options).find(option => option.value === 'all')
                    if (allOption) {
                        allOption.selected = false
                    }
                }
            })

            // Filter buttons for cookies
            document.querySelectorAll('.filter-btn[data-filter-cookies]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn[data-filter-cookies]').forEach(b => b.classList.remove('active'))
                    btn.classList.add('active')
                    currentCookiesFilter = btn.dataset.filterCookies
                    renderCookies()
                })
            })

            // Search input for orders
            searchInput.addEventListener('input', () => {
                searchQuery = searchInput.value
                renderOrders()
            })

            // Search input for cookies
            searchCookiesInput.addEventListener('input', () => {
                cookiesSearchQuery = searchCookiesInput.value
                renderCookies()
            })

            // Table header sorting for orders
            document.querySelectorAll('#orders-tab-content th[data-sort]').forEach(th => {
                th.addEventListener('click', () => {
                    sortOrders(th.getAttribute('data-sort'))
                })
            })

            // Add new item button functionality
            document.getElementById('add-item-btn').addEventListener('click', () => {
                showAddItemModal();
            });

            // Function to show the add item modal
            function showAddItemModal() {
                const modalHTML = `
        <div class="modal" id="add-item-modal">
            <div class="modal-content" style="max-width: 700px; position: relative;">
                <!-- Loading Overlay -->
                <div class="loading-overlay" id="loading-overlay" style="display: none;">
                    <div class="upload-spinner"></div>
                    <p>Uploading Image...</p>
                </div>
                
                <div class="modal-header">
                    <h2 class="modal-title">Add New Item</h2>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="add-item-form" class="edit-form">
                        <div class="form-group">
                            <label for="item-type">Item Type:</label>
                            <select id="item-type" required>
                                <option value="">Select Item Type</option>
                                <option value="cookie">Cookie</option>
                                <option value="box">Box</option>
                            </select>
                        </div>

                        <!-- Common Fields -->
                        <div class="form-group">
                            <label for="add-name">Name:</label>
                            <input type="text" id="add-name" required>
                            <small>Enter the name of the cookie or box</small>
                        </div>

                        <div class="form-group">
                            <label for="add-description">Description:</label>
                            <textarea id="add-description" rows="3" placeholder="Enter item description..."></textarea>
                        </div>

                        <div class="form-group">
                            <label for="add-slug">Slug:</label>
                            <input type="text" id="add-slug">
                            <small>URL-friendly identifier (auto-generated if empty)</small>
                        </div>

                        <!-- Cookie Specific Fields -->
                        <div id="cookie-fields" style="display: none;">
                            <div class="form-group">
                                <label>Cookie Variants:</label>
                                <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 0.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" id="add-chewy-variant" value="chewy">
                                        <span>ðŸª Chewy</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" id="add-crumble-variant" value="crumble">
                                        <span>ðŸª Crumble</span>
                                    </label>
                                </div>
                            </div>

                            <div id="chewy-fields" style="display: none; margin-top: 1rem; padding: 1rem; background: var(--gray-100); border-radius: 8px;">
                                <h4 style="margin-bottom: 1rem; color: var(--primary);">Chewy Variant</h4>
                                <div class="form-group">
                                    <label for="add-chewy-price">Chewy Price (EGP):</label>
                                    <input type="number" id="add-chewy-price" step="0.01" min="0">
                                </div>
                                <div class="form-group">
                                    <label for="add-chewy-image">Chewy Image:</label>
                                    <input type="file" id="add-chewy-image" accept="image/*" class="file-input">
                                    <small>Supported formats: JPG, PNG, SVG, WebP (Max 2MB)</small>
                                    <div class="image-preview" id="chewy-image-preview" style="display: none;">
                                        <img id="chewy-preview-image" alt="Chewy Preview">
                                        <button type="button" id="remove-chewy-preview" class="remove-preview-btn">Remove</button>
                                    </div>
                                </div>
                            </div>

                            <div id="crumble-fields" style="display: none; margin-top: 1rem; padding: 1rem; background: var(--gray-100); border-radius: 8px;">
                                <h4 style="margin-bottom: 1rem; color: var(--primary);">Crumble Variant</h4>
                                <div class="form-group">
                                    <label for="add-crumble-price">Crumble Price (EGP):</label>
                                    <input type="number" id="add-crumble-price" step="0.01" min="0">
                                </div>
                                <div class="form-group">
                                    <label for="add-crumble-image">Crumble Image:</label>
                                    <input type="file" id="add-crumble-image" accept="image/*" class="file-input">
                                    <small>Supported formats: JPG, PNG, SVG, WebP (Max 2MB)</small>
                                    <div class="image-preview" id="crumble-image-preview" style="display: none;">
                                        <img id="crumble-preview-image" alt="Crumble Preview">
                                        <button type="button" id="remove-crumble-preview" class="remove-preview-btn">Remove</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Additional Cookie Fields -->
                            <div class="form-group">
                                <label for="add-ingredients">Ingredients:</label>
                                <textarea id="add-ingredients" rows="2" placeholder="List of ingredients..."></textarea>
                            </div>

                            <div class="form-group">
                                <label for="add-specialty">Specialty:</label>
                                <textarea id="add-specialty" rows="2" placeholder="What makes this cookie special..."></textarea>
                            </div>

                            <div class="form-group">
                                <label for="add-perfect-for">Perfect For:</label>
                                <textarea id="add-perfect-for" rows="2" placeholder="Ideal occasions or pairings..."></textarea>
                            </div>

                            <div class="form-group">
                                <label for="add-tags">Tags:</label>
                                <input type="text" id="add-tags" placeholder="popular, new, seasonal (comma separated)">
                                <small>Add tags to help categorize the cookie</small>
                            </div>
                        </div>

                        <!-- Box Specific Fields -->
                        <div id="box-fields" style="display: none;">
                            <div class="form-group">
                                <label for="add-size">Size:</label>
                                <select id="add-size" required>
                                    <option value="">Select Size</option>
                                    <option value="duo">Duo (2 cookies)</option>
                                    <option value="trio">Trio (3 cookies)</option>
                                    <option value="classic">Classic (4 cookies)</option>
                                    <option value="craver">Craver (6 cookies)</option>
                                    <option value="feast">Feast (9 cookies)</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="add-cookie-count">Cookie Count:</label>
                                <input type="number" id="add-cookie-count" min="1" required>
                            </div>

                            <div class="form-group">
                                <label>Box Variants:</label>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 0.5rem;">
                                    <div style="padding: 1rem; background: var(--gray-100); border-radius: 8px;">
                                        <h4 style="margin-bottom: 0.5rem; color: var(--primary);">Chewy</h4>
                                        <div class="form-group">
                                            <label for="add-box-chewy-price">Price (EGP):</label>
                                            <input type="number" id="add-box-chewy-price" step="0.01" min="0" required>
                                        </div>
                                    </div>
                                    <div style="padding: 1rem; background: var(--gray-100); border-radius: 8px;">
                                        <h4 style="margin-bottom: 0.5rem; color: var(--primary);">Crumble</h4>
                                        <div class="form-group">
                                            <label for="add-box-crumble-price">Price (EGP):</label>
                                            <input type="number" id="add-box-crumble-price" step="0.01" min="0" required>
                                        </div>
                                    </div>
                                    <div style="padding: 1rem; background: var(--gray-100); border-radius: 8px;">
                                        <h4 style="margin-bottom: 0.5rem; color: var(--primary);">Mix</h4>
                                        <div class="form-group">
                                            <label for="add-box-mix-price">Price (EGP):</label>
                                            <input type="number" id="add-box-mix-price" step="0.01" min="0" required>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="add-box-image">Box Image:</label>
                                <input type="file" id="add-box-image" accept="image/*" class="file-input">
                                <small>Supported formats: JPG, PNG, SVG, WebP (Max 2MB)</small>
                                <div class="image-preview" id="box-image-preview" style="display: none;">
                                    <img id="box-preview-image" alt="Box Preview">
                                    <button type="button" id="remove-box-preview" class="remove-preview-btn">Remove</button>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="add-is-active" style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="add-is-active" checked>
                                <span>âœ… Active Item</span>
                            </label>
                            <small>Uncheck to create this item as inactive</small>
                        </div>
                    </form>
                </div>
                <div class="modal-actions">
                    <button class="modal-btn btn-secondary" id="cancel-add-btn">
                        <span>âœ•</span> Cancel
                    </button>
                    <button class="modal-btn btn-primary" id="save-add-btn">
                        <span>âœ“</span> Create Item
                    </button>
                </div>
            </div>
        </div>
    `;

                document.body.insertAdjacentHTML('beforeend', modalHTML);

                const addModal = document.getElementById('add-item-modal');
                addModal.style.display = 'flex';

                setupAddModalEvents(addModal);
                setupAddFormInteractions();
            }

            // Setup add modal event listeners
            function setupAddModalEvents(modal) {
                const closeModal = modal.querySelector('.close-modal');
                const cancelBtn = modal.querySelector('#cancel-add-btn');

                const closeModalHandler = () => {
                    modal.remove();
                };

                closeModal.addEventListener('click', closeModalHandler);
                cancelBtn.addEventListener('click', closeModalHandler);

                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModalHandler();
                    }
                });

                const saveBtn = modal.querySelector('#save-add-btn');
                saveBtn.addEventListener('click', async () => {
                    await saveNewItem(modal);
                });

                // Enter key support
                modal.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        saveBtn.click();
                    }
                });
            }

            // Setup form interactions for the add modal
            function setupAddFormInteractions() {
                const itemTypeSelect = document.getElementById('item-type');
                const cookieFields = document.getElementById('cookie-fields');
                const boxFields = document.getElementById('box-fields');
                const sizeSelect = document.getElementById('add-size');

                // Item type change handler
                itemTypeSelect.addEventListener('change', function () {
                    const type = this.value;

                    cookieFields.style.display = type === 'cookie' ? 'block' : 'none';
                    boxFields.style.display = type === 'box' ? 'block' : 'none';

                    // Reset form when switching types
                    if (type === 'cookie') {
                        resetBoxFields();
                    } else if (type === 'box') {
                        resetCookieFields();
                    }
                });

                // Cookie variant checkboxes
                document.getElementById('add-chewy-variant').addEventListener('change', function () {
                    document.getElementById('chewy-fields').style.display = this.checked ? 'block' : 'none';
                    if (!this.checked) {
                        document.getElementById('add-chewy-price').value = '';
                        document.getElementById('add-chewy-image').value = '';
                        document.getElementById('chewy-image-preview').style.display = 'none';
                    }
                });

                document.getElementById('add-crumble-variant').addEventListener('change', function () {
                    document.getElementById('crumble-fields').style.display = this.checked ? 'block' : 'none';
                    if (!this.checked) {
                        document.getElementById('add-crumble-price').value = '';
                        document.getElementById('add-crumble-image').value = '';
                        document.getElementById('crumble-image-preview').style.display = 'none';
                    }
                });

                // Box size auto-fill cookie count
                sizeSelect.addEventListener('change', function () {
                    const sizeConfig = {
                        'duo': 2,
                        'trio': 3,
                        'classic': 4,
                        'craver': 6,
                        'feast': 9
                    };

                    if (sizeConfig[this.value]) {
                        document.getElementById('add-cookie-count').value = sizeConfig[this.value];
                    }
                });

                // Auto-generate slug from name
                document.getElementById('add-name').addEventListener('input', function () {
                    const slugInput = document.getElementById('add-slug');
                    if (!slugInput.value) {
                        const slug = this.value
                            .toLowerCase()
                            .replace(/[^a-z0-9]+/g, '-')
                            .replace(/(^-|-$)/g, '');
                        slugInput.value = slug;
                    }
                });

                // Image preview setup
                setupAddImagePreviews();
            }

            // Setup image previews for add form
            function setupAddImagePreviews() {
                // Chewy image preview
                const chewyFileInput = document.getElementById('add-chewy-image');
                const chewyPreview = document.getElementById('chewy-image-preview');
                const chewyPreviewImage = document.getElementById('chewy-preview-image');
                const removeChewyPreview = document.getElementById('remove-chewy-preview');

                if (chewyFileInput) {
                    chewyFileInput.addEventListener('change', function (e) {
                        handleImagePreview(e, chewyPreview, chewyPreviewImage);
                    });
                }

                if (removeChewyPreview) {
                    removeChewyPreview.addEventListener('click', function () {
                        chewyFileInput.value = '';
                        chewyPreview.style.display = 'none';
                    });
                }

                // Crumble image preview
                const crumbleFileInput = document.getElementById('add-crumble-image');
                const crumblePreview = document.getElementById('crumble-image-preview');
                const crumblePreviewImage = document.getElementById('crumble-preview-image');
                const removeCrumblePreview = document.getElementById('remove-crumble-preview');

                if (crumbleFileInput) {
                    crumbleFileInput.addEventListener('change', function (e) {
                        handleImagePreview(e, crumblePreview, crumblePreviewImage);
                    });
                }

                if (removeCrumblePreview) {
                    removeCrumblePreview.addEventListener('click', function () {
                        crumbleFileInput.value = '';
                        crumblePreview.style.display = 'none';
                    });
                }

                // Box image preview
                const boxFileInput = document.getElementById('add-box-image');
                const boxPreview = document.getElementById('box-image-preview');
                const boxPreviewImage = document.getElementById('box-preview-image');
                const removeBoxPreview = document.getElementById('remove-box-preview');

                if (boxFileInput) {
                    boxFileInput.addEventListener('change', function (e) {
                        handleImagePreview(e, boxPreview, boxPreviewImage);
                    });
                }

                if (removeBoxPreview) {
                    removeBoxPreview.addEventListener('click', function () {
                        boxFileInput.value = '';
                        boxPreview.style.display = 'none';
                    });
                }
            }

            // Helper function for image preview
            function handleImagePreview(event, previewContainer, previewImage) {
                const file = event.target.files[0];
                if (file) {
                    if (!file.type.match('image.*')) {
                        showToast('Please select a valid image file');
                        return;
                    }

                    if (file.size > 2 * 1024 * 1024) {
                        showToast('Image size must be less than 2MB');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function (e) {
                        previewImage.src = e.target.result;
                        previewContainer.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            }

            // Reset functions
            function resetCookieFields() {
                document.getElementById('add-chewy-variant').checked = false;
                document.getElementById('add-crumble-variant').checked = false;
                document.getElementById('chewy-fields').style.display = 'none';
                document.getElementById('crumble-fields').style.display = 'none';
                document.getElementById('add-chewy-price').value = '';
                document.getElementById('add-crumble-price').value = '';
                document.getElementById('add-chewy-image').value = '';
                document.getElementById('add-crumble-image').value = '';
                document.getElementById('chewy-image-preview').style.display = 'none';
                document.getElementById('crumble-image-preview').style.display = 'none';
                document.getElementById('add-ingredients').value = '';
                document.getElementById('add-specialty').value = '';
                document.getElementById('add-perfect-for').value = '';
                document.getElementById('add-tags').value = '';
            }

            function resetBoxFields() {
                document.getElementById('add-size').value = '';
                document.getElementById('add-cookie-count').value = '';
                document.getElementById('add-box-chewy-price').value = '';
                document.getElementById('add-box-crumble-price').value = '';
                document.getElementById('add-box-mix-price').value = '';
                document.getElementById('add-box-image').value = '';
                document.getElementById('box-image-preview').style.display = 'none';
            }

            // Main function to save new item
            async function saveNewItem(modal) {
                try {
                    const itemType = document.getElementById('item-type').value;
                    const name = document.getElementById('add-name').value.trim();
                    const description = document.getElementById('add-description').value.trim();
                    const slug = document.getElementById('add-slug').value.trim();
                    const isActive = document.getElementById('add-is-active').checked;

                    // Validation
                    if (!itemType) {
                        showToast('Please select item type');
                        return;
                    }

                    if (!name) {
                        showToast('Name is required');
                        return;
                    }

                    const saveBtn = modal.querySelector('#save-add-btn');
                    const cancelBtn = modal.querySelector('#cancel-add-btn');

                    // Disable form during save
                    const inputs = modal.querySelectorAll('input, textarea, button, select');
                    inputs.forEach(input => {
                        if (input !== saveBtn && input !== cancelBtn) {
                            input.disabled = true;
                        }
                    });

                    saveBtn.innerHTML = '<span>â³</span> Creating Item...';
                    saveBtn.disabled = true;

                    let result;

                    if (itemType === 'cookie') {
                        result = await saveNewCookie(modal);
                    } else if (itemType === 'box') {
                        result = await saveNewBox(modal);
                    }

                    if (result) {
                        showToast(`âœ… ${itemType === 'cookie' ? 'Cookie' : 'Box'} created successfully`);
                        modal.remove();
                        loadCookies();
                    } else {
                        throw new Error('Failed to create item');
                    }

                } catch (err) {
                    console.error('Failed to create item:', err);
                    showToast('Failed to create item');

                    // Re-enable form on error
                    const inputs = modal.querySelectorAll('input, textarea, button, select');
                    inputs.forEach(input => input.disabled = false);

                    const saveBtn = modal.querySelector('#save-add-btn');
                    saveBtn.innerHTML = '<span>âœ“</span> Create Item';
                    saveBtn.disabled = false;
                }
            }

            // Save new cookie with proper price handling
            async function saveNewCookie(modal) {
                const name = document.getElementById('add-name').value.trim();
                const description = document.getElementById('add-description').value.trim();
                const slug = document.getElementById('add-slug').value.trim() || generateSlug(name);
                const isActive = document.getElementById('add-is-active').checked;
                const hasChewy = document.getElementById('add-chewy-variant').checked;
                const hasCrumble = document.getElementById('add-crumble-variant').checked;
                const ingredients = document.getElementById('add-ingredients').value.trim();
                const specialty = document.getElementById('add-specialty').value.trim();
                const perfectFor = document.getElementById('add-perfect-for').value.trim();
                const tagsInput = document.getElementById('add-tags').value.trim();

                // Validate at least one variant is selected
                if (!hasChewy && !hasCrumble) {
                    showToast('Please select at least one cookie variant');
                    return false;
                }

                const cookieData = {
                    name: name,
                    description: description,
                    slug: slug,
                    is_active: isActive,
                    ingredients: ingredients || null,
                    specialty: specialty || null,
                    perfect_for: perfectFor || null,
                    tags: tagsInput ? tagsInput.split(',').map(tag => tag.trim()) : []
                };

                // Set prices - use null for unselected variants
                cookieData.chewy_price = hasChewy ? parseFloat(document.getElementById('add-chewy-price').value) : null;
                cookieData.crumble_price = hasCrumble ? parseFloat(document.getElementById('add-crumble-price').value) : null;

                // Validate prices for selected variants
                if (hasChewy && (!cookieData.chewy_price || cookieData.chewy_price <= 0)) {
                    showToast('Please enter a valid price for Chewy variant');
                    return false;
                }

                if (hasCrumble && (!cookieData.crumble_price || cookieData.crumble_price <= 0)) {
                    showToast('Please enter a valid price for Crumble variant');
                    return false;
                }

                // Upload images for selected variants
                if (hasChewy) {
                    const chewyImageFile = document.getElementById('add-chewy-image').files[0];
                    if (chewyImageFile) {
                        // Generate a unique ID for the new cookie
                        const tempId = `new_${Date.now()}`;
                        const chewyImageUrl = await uploadImageToGitHub(chewyImageFile, tempId, 'cookie', 'chewy');
                        if (chewyImageUrl) {
                            cookieData.image_url_chewy = chewyImageUrl;
                        }
                    }
                }

                if (hasCrumble) {
                    const crumbleImageFile = document.getElementById('add-crumble-image').files[0];
                    if (crumbleImageFile) {
                        // Generate a unique ID for the new cookie
                        const tempId = `new_${Date.now()}`;
                        const crumbleImageUrl = await uploadImageToGitHub(crumbleImageFile, tempId, 'cookie', 'crumble');
                        if (crumbleImageUrl) {
                            cookieData.image_url_crumble = crumbleImageUrl;
                        }
                    }
                }

                // Insert into database
                const { data, error } = await supabase
                    .from('cookies')
                    .insert([cookieData])
                    .select();

                if (error) {
                    console.error('Error creating cookie:', error);
                    showToast('Error creating cookie: ' + error.message);
                    return false;
                }

                return true;
            }
            // Save new box
            async function saveNewBox(modal) {
                const name = document.getElementById('add-name').value.trim();
                const description = document.getElementById('add-description').value.trim();
                const slug = document.getElementById('add-slug').value.trim() || generateSlug(name);
                const size = document.getElementById('add-size').value;
                const cookieCount = parseInt(document.getElementById('add-cookie-count').value);
                const isActive = document.getElementById('add-is-active').checked;
                const chewyPrice = parseFloat(document.getElementById('add-box-chewy-price').value);
                const crumblePrice = parseFloat(document.getElementById('add-box-crumble-price').value);
                const mixPrice = parseFloat(document.getElementById('add-box-mix-price').value);

                // Validation
                if (!size) {
                    showToast('Please select box size');
                    return false;
                }

                if (!cookieCount || cookieCount < 1) {
                    showToast('Please enter valid cookie count');
                    return false;
                }

                if (!chewyPrice || !crumblePrice || !mixPrice) {
                    showToast('Please enter prices for all box variants');
                    return false;
                }

                const boxData = {
                    name: name,
                    size: size,
                    description: description,
                    slug: slug,
                    cookie_count: cookieCount,
                    chewy_price: chewyPrice,
                    crumble_price: crumblePrice,
                    mix_price: mixPrice,
                    is_active: isActive
                };

                // Upload box image
                const boxImageFile = document.getElementById('add-box-image').files[0];
                if (boxImageFile) {
                    const boxImageUrl = await uploadImageToGitHub(boxImageFile, 'new_box', 'box');
                    if (boxImageUrl) {
                        boxData.image_url = boxImageUrl;
                    }
                }

                // Insert into database
                const { error } = await supabase
                    .from('boxes')
                    .insert([boxData]);

                if (error) {
                    console.error('Error creating box:', error);
                    showToast('Error creating box: ' + error.message);
                    return false;
                }

                return true;
            }

            // Helper function to generate slug
            function generateSlug(name) {
                return name
                    .toLowerCase()
                    .replace(/[^a-z0-9]+/g, '-')
                    .replace(/(^-|-$)/g, '');
            }

            // Vouchers filter buttons
            document.querySelectorAll('.filter-btn[data-filter-vouchers]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn[data-filter-vouchers]').forEach(b => b.classList.remove('active'))
                    btn.classList.add('active')
                    currentVouchersFilter = btn.dataset.filterVouchers
                    renderVouchers()
                })
            })

            // Vouchers search input
            document.getElementById('search-vouchers-input').addEventListener('input', () => {
                vouchersSearchQuery = document.getElementById('search-vouchers-input').value
                renderVouchers()
            })

            // Add voucher button
            document.getElementById('add-voucher-btn').addEventListener('click', () => {
                showVoucherModal()
            })

            // Voucher modal events
            document.getElementById('cancel-voucher-btn').addEventListener('click', () => {
                document.getElementById('voucher-modal').style.display = 'none'
                // Reset readonly states when closing modal
                const discountRateInput = document.getElementById('voucher-discount-rate')
                const discountAmountInput = document.getElementById('voucher-discount-amount')
                discountRateInput.readOnly = false
                discountAmountInput.readOnly = false
                updateDiscountFieldStyles()
            })

            document.querySelector('#voucher-modal .close-modal').addEventListener('click', () => {
                document.getElementById('voucher-modal').style.display = 'none'
                // Reset readonly states when closing modal
                const discountRateInput = document.getElementById('voucher-discount-rate')
                const discountAmountInput = document.getElementById('voucher-discount-amount')
                discountRateInput.readOnly = false
                discountAmountInput.readOnly = false
                updateDiscountFieldStyles()
            })

            document.getElementById('save-voucher-btn').addEventListener('click', saveVoucher)

            // Voucher type change events
            document.getElementById('voucher-free-shipping').addEventListener('change', updateVoucherFormVisibility)
            document.getElementById('voucher-free-item').addEventListener('change', updateVoucherFormVisibility)
            document.getElementById('voucher-total').addEventListener('change', updateVoucherFormVisibility)

            // Close voucher modal on background click
            document.getElementById('voucher-modal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('voucher-modal')) {
                    document.getElementById('voucher-modal').style.display = 'none'
                    // Reset readonly states when closing modal
                    const discountRateInput = document.getElementById('voucher-discount-rate')
                    const discountAmountInput = document.getElementById('voucher-discount-amount')
                    discountRateInput.readOnly = false
                    discountAmountInput.readOnly = false
                    updateDiscountFieldStyles()
                }
            })


            // Clear discount fields when voucher type changes away from discount types
            document.getElementById('voucher-free-shipping').addEventListener('change', function () {
                if (!this.checked) {
                    const freeItem = document.getElementById('voucher-free-item').checked
                    const totalDiscount = document.getElementById('voucher-total').checked
                    if (!freeItem && !totalDiscount) {
                        document.getElementById('voucher-discount-rate').value = ''
                        document.getElementById('voucher-discount-amount').value = ''
                    }
                }
            })
        }

        // Initialize the dashboard
        loadOrders()
        setupEventListeners()

        // Update the real-time subscriptions for cookies
        supabase
            .channel('cookies')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'cookies' }, payload => {
                console.log('New cookie received:', payload.new)
                // Add to cookies array with proper structure
                const newCookie = {
                    ...payload.new,
                    type: 'cookie',
                    id: payload.new.id,
                    name: payload.new.name,
                    chewy_price: payload.new.chewy_price || 0,
                    crumble_price: payload.new.crumble_price || 0,
                    description: payload.new.description || '',
                    slug: payload.new.slug || '',
                }
                cookies.unshift(newCookie)
                updateCookiesStats()
                renderCookies()
                showToast(`New cookie added: ${payload.new.name}`)
            })
            .subscribe()

        // Update subscription for cookie updates
        supabase
            .channel('cookie-updates')
            .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'cookies' }, payload => {
                console.log('Cookie updated:', payload.new)
                // Update the cookie in the local array
                const cookieIndex = cookies.findIndex(c => c.id === payload.new.id && c.type === 'cookie')
                if (cookieIndex !== -1) {
                    cookies[cookieIndex] = {
                        ...payload.new,
                        type: 'cookie',
                        id: payload.new.id,
                        name: payload.new.name,
                        chewy_price: payload.new.chewy_price || 0,
                        crumble_price: payload.new.crumble_price || 0,
                        description: payload.new.description || '',
                        slug: payload.new.slug || '',
                    }
                    updateCookiesStats()
                    renderCookies()
                }
            })
            .subscribe()

        // Real-time subscription for cookie deletions
        supabase
            .channel('cookie-deletions')
            .on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'cookies' }, payload => {
                console.log('Cookie deleted:', payload.old)
                // Remove the cookie from the local array
                cookies = cookies.filter(c => !(c.id === payload.old.id && c.type === 'cookie'))
                updateCookiesStats()
                renderCookies()
                showToast(`Cookie deleted: ${payload.old.name}`)
            })
            .subscribe()

        // Real-time subscription for new boxes
        supabase
            .channel('boxes')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'boxes' }, payload => {
                console.log('New box received:', payload.new)
                // Add to cookies array and update stats
                const newBox = {
                    ...payload.new,
                    type: 'box'
                }
                cookies.unshift(newBox)
                updateCookiesStats()
                renderCookies()
                showToast(`New box added: ${payload.new.name}`)
            })
            .subscribe()

        // Real-time subscription for box updates
        supabase
            .channel('box-updates')
            .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'boxes' }, payload => {
                console.log('Box updated:', payload.new)
                // Update the box in the local array
                const boxIndex = cookies.findIndex(b => b.id === payload.new.id && b.type === 'box')
                if (boxIndex !== -1) {
                    cookies[boxIndex] = {
                        ...payload.new,
                        type: 'box'
                    }
                    updateCookiesStats()
                    renderCookies()
                }
            })
            .subscribe()

        // Real-time subscription for box deletions
        supabase
            .channel('box-deletions')
            .on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'boxes' }, payload => {
                console.log('Box deleted:', payload.old)
                // Remove the box from the local array
                cookies = cookies.filter(b => !(b.id === payload.old.id && b.type === 'box'))
                updateCookiesStats()
                renderCookies()
                showToast(`Box deleted: ${payload.old.name}`)
            })
            .subscribe()

        // Real-time subscription for new orders
        supabase
            .channel('orders')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'orders' }, payload => {
                console.log('New order received:', payload.new)

                // Add to orders array and update stats
                orders.unshift(payload.new)
                updateStats()

                // Render the new order
                renderNewOrder(payload.new)
            })
            .subscribe()

        // Real-time subscription for order updates
        supabase
            .channel('order-updates')
            .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'orders' }, payload => {
                console.log('Order updated:', payload.new)

                // Update the order in the local array
                const orderIndex = orders.findIndex(o => o.id === payload.new.id)
                if (orderIndex !== -1) {
                    orders[orderIndex] = payload.new

                    // Update the UI if this order is currently being viewed
                    if (selectedOrder && selectedOrder.id === payload.new.id) {
                        showOrderDetails(payload.new)
                    }

                    // Re-render orders and update stats
                    renderOrders()
                    updateStats()

                    // Show notification if status changed
                    if (payload.old.status !== payload.new.status) {
                        showToast(`Order ${payload.new.order_id} status updated to ${payload.new.status}`)
                    }
                }
            })
            .subscribe()

        // Real-time subscription for new vouchers
        supabase
            .channel('vouchers')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'vouchers' }, payload => {
                console.log('New voucher received:', payload.new)
                vouchers.unshift(payload.new)
                updateVouchersStats()
                renderVouchers()
                showToast(`New voucher added: ${payload.new.code}`)
            })
            .subscribe()

        // Real-time subscription for voucher updates
        supabase
            .channel('voucher-updates')
            .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'vouchers' }, payload => {
                console.log('Voucher updated:', payload.new)
                const voucherIndex = vouchers.findIndex(v => v.id === payload.new.id)
                if (voucherIndex !== -1) {
                    vouchers[voucherIndex] = payload.new
                    updateVouchersStats()
                    renderVouchers()
                }
            })
            .subscribe()


        // Real-time subscription for voucher status updates
        supabase
            .channel('voucher-status-updates')
            .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'vouchers' }, payload => {
                console.log('Voucher status updated:', payload.new)
                const voucherIndex = vouchers.findIndex(v => v.id === payload.new.id)
                if (voucherIndex !== -1) {
                    vouchers[voucherIndex] = payload.new
                    updateVouchersStats()
                    renderVouchers()
                }
            })
            .subscribe()

        // Real-time subscription for voucher deletions
        supabase
            .channel('voucher-deletions')
            .on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'vouchers' }, payload => {
                console.log('Voucher deleted:', payload.old)
                vouchers = vouchers.filter(v => v.id !== payload.old.id)
                updateVouchersStats()
                renderVouchers()
                showToast(`Voucher deleted: ${payload.old.code}`)
            })
            .subscribe()

        // Add real-time subscriptions
        supabase
            .channel('shipping-cities')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'shipping_prices' }, payload => {
                console.log('Shipping cities changed:', payload)
                loadShippingData()
            })
            .subscribe()

        supabase
            .channel('shipping-zones')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'shipping_zones' }, payload => {
                console.log('Shipping zones changed:', payload)
                loadShippingData()
            })
            .subscribe()
    </script>
</body>

</html>